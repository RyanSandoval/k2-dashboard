<!DOCTYPE html>
<!-- 
WARNING: DO NOT REPLACE THIS ENTIRE FILE!
This is the COMPLETE K-2 dashboard with: Notes, Tasks, Jots, Projects, AI Insights, Trading
Multiple times this file has been completely replaced with a trading-only version, destroying all functionality.
If you need to update ONLY the Trading tab, make surgical edits - DO NOT replace the entire file!
Current features: Notes (TipTap editors), Tasks (with extraction from notes/jots), Jots (daily docs), Projects, AI Insights
-->
<html lang="en">
<head>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' cdn.jsdelivr.net esm.sh *.esm.sh; style-src 'self' 'unsafe-inline'; connect-src 'self' api.github.com esm.sh *.esm.sh; img-src 'self' data: blob: *; font-src 'self' data:; frame-src 'none'; object-src 'none';">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-2 Command Center</title>
<!-- Force GitHub Pages refresh: 2026-02-17T13:26 -->
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3a;
    --text: #e0e0e8;
    --text-dim: #8888a0;
    --accent: #4a9eff;
    --accent2: #7c5cff;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Layout */
  .app { display: flex; height: 100vh; }
  .sidebar {
    width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px 0;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
  .sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }
  .sidebar-header h1 {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }
  .sidebar-header h1 span { color: var(--accent); }
  .sidebar-header p { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .nav-section { padding: 8px 12px; }
  .nav-section-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    padding: 8px 8px 4px;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-dim);
    transition: all 0.15s;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent); color: #fff; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
  .nav-item .badge {
    margin-left: auto;
    background: var(--accent2);
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
  }
  .sidebar-footer {
    margin-top: auto;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Main Content */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
  }
  .page { display: none; }
  .page.active { display: block; }
  .page-header {
    margin-bottom: 24px;
  }
  .page-header h2 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .page-header p { color: var(--text-dim); font-size: 14px; margin-top: 4px; }

  /* Cards */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.15s;
    position: relative;
  }
  .card:hover { border-color: var(--accent); }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .card-title { font-size: 15px; font-weight: 600; }
  .card-body { font-size: 13px; color: var(--text-dim); line-height: 1.6; }
  .card-footer {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Comment badge on cards */
  .comment-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    background: var(--accent);
    color: #fff;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 10px;
    z-index: 1;
  }

  /* Comments section styles */
  

  /* Submission (copy/paste) */
  .submission-section {
    border-top: 1px solid var(--border);
    padding-top: 16px;
    margin-bottom: 20px;
  }
  .submission-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  .submission-field {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    position: relative;
  }
  .submission-label {
    font-size: 11px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }
  .submission-textarea {
    width: 100%;
    min-height: 56px;
    resize: vertical;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.06);
    color: var(--text);
    border-radius: 8px;
    padding: 8px;
    font-size: 13px;
    line-height: 1.4;
    outline: none;
  }
  .copy-btn {
    margin-top: 8px;
    background: rgba(74,158,255,0.15);
    color: var(--accent);
    border: 1px solid rgba(74,158,255,0.3);
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 12px;
    cursor: pointer;
  }
  .copy-btn:hover { background: rgba(74,158,255,0.22); }
  .copied-flash { border-color: rgba(74,222,128,0.9) !important; }

.comments-section {
    margin-top: 24px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }
  .comments-section h4 {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text);
  }
  .comments-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
    max-height: 200px;
    overflow-y: auto;
  }
  .comment {
    display: flex;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border-radius: 8px;
    border-left: 3px solid var(--green);
  }
  .comment.k2 {
    border-left-color: var(--accent);
  }
  .comment-avatar {
    font-size: 14px;
    flex-shrink: 0;
  }
  .comment-content {
    flex: 1;
  }
  .comment-author {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 2px;
    font-weight: 600;
  }
  .comment-text {
    font-size: 13px;
    line-height: 1.5;
    color: var(--text);
  }
  .comment-time {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
  }
  .comment-input-section {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .comment-input {
    width: 100%;
    min-height: 60px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    line-height: 1.5;
    resize: vertical;
    outline: none;
  }
  .comment-input:focus {
    border-color: var(--accent);
  }
  .comment-input::placeholder {
    color: var(--text-dim);
  }
  .comment-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
  }
  .comment-btn {
    background: var(--accent);
    border: none;
    border-radius: 6px;
    color: #fff;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .comment-btn:hover {
    opacity: 0.9;
  }

  /* Tags & Badges */
  .tag {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 500;
  }
  .tag-blue { background: rgba(74,158,255,0.15); color: var(--accent); }
  .tag-purple { background: rgba(124,92,255,0.15); color: var(--accent2); }
  .tag-green { background: rgba(74,222,128,0.15); color: var(--green); }
  .tag-yellow { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .tag-red { background: rgba(248,113,113,0.15); color: var(--red); }
  .tag-orange { background: rgba(251,146,60,0.15); color: var(--orange); }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-active { background: var(--green); }
  .status-planning { background: var(--yellow); }
  .status-blocked { background: var(--red); }
  .status-idea { background: var(--accent); }

  /* Stat Cards */
  .stat-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .stat-card .label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .stat-card .sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

  /* Discussion Thread */
  .thread {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .thread-header {
    padding: 16px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .thread-header:hover { background: var(--surface2); }
  .thread-title { font-weight: 600; font-size: 14px; flex: 1; }
  .thread-date { font-size: 12px; color: var(--text-dim); }
  .thread-body {
    padding: 0 20px 16px;
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.7;
    display: none;
  }
  .thread.open .thread-body { display: block; }
  .thread-toggle { color: var(--text-dim); font-size: 12px; transition: transform 0.2s; }
  .thread.open .thread-toggle { transform: rotate(90deg); }

  /* Tasks */
  .task-list { list-style: none; }
  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .task-item:last-child { border-bottom: none; }
  .task-check {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .task-check:hover { border-color: var(--accent); }
  .task-check.done { background: var(--green); border-color: var(--green); }
  .task-check.done::after { content: "‚úì"; color: #000; font-size: 12px; font-weight: 700; }
  .task-content { flex: 1; }
  .task-content.done { text-decoration: line-through; color: var(--text-dim); }
  .task-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .task-priority {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .priority-high { background: rgba(248,113,113,0.15); color: var(--red); }
  .priority-medium { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .priority-low { background: rgba(74,158,255,0.15); color: var(--accent); }

  /* Quick Add */
  .quick-add {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .quick-add input, .quick-add select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-size: 13px;
    outline: none;
  }
  .quick-add input { flex: 1; }
  .quick-add input:focus { border-color: var(--accent); }
  .quick-add select { width: 120px; }
  .quick-add button {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .quick-add button:hover { opacity: 0.9; }

  /* Notes */
  .note-editor {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .note-editor textarea {
    width: 100%;
    min-height: 120px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    outline: none;
  }
  .note-editor textarea:focus { border-color: var(--accent); }
  .note-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
  }
  .btn:hover { border-color: var(--accent); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Timeline */
  .timeline { position: relative; padding-left: 24px; }
  .timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border);
  }
  .timeline-item {
    position: relative;
    padding-bottom: 24px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
  }
  .timeline-date { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
  .timeline-content { font-size: 13px; line-height: 1.6; }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
  }
  .filter-btn:hover, .filter-btn.active {
    border-color: var(--accent);
    color: var(--text);
  }

  /* Kanban */
  .kanban {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 16px;
    min-height: 500px;
  }
  .kanban-column {
    min-width: 280px;
    width: 280px;
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 160px);
  }
  .kanban-column-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .kanban-column-header .count {
    background: var(--surface2);
    color: var(--text-dim);
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 500;
  }
  .kanban-cards {
    padding: 12px;
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .kanban-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    cursor: grab;
    transition: all 0.15s;
  }
  .kanban-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .kanban-card.dragging { opacity: 0.5; }
  .kanban-card-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .kanban-card-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-bottom: 10px; }
  .kanban-card-footer { display: flex; gap: 4px; flex-wrap: wrap; }
  .kanban-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
  .kanban-card-date { font-size: 10px; color: var(--text-dim); }
  .kanban-card-tasks { font-size: 10px; color: var(--text-dim); }
  .column-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-idea { background: var(--accent); }
  .dot-planning { background: var(--yellow); }
  .dot-active { background: var(--orange); }
  .dot-review { background: var(--accent2); }
  .dot-done { background: var(--green); }
  .kanban-drop-zone {
    min-height: 40px;
    border: 2px dashed transparent;
    border-radius: 8px;
    transition: all 0.2s;
  }
  .kanban-drop-zone.over {
    border-color: var(--accent);
    background: rgba(74,158,255,0.05);
  }

  /* Daily Docs / Editor */
  .jots-date-header {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 16px;
    letter-spacing: -0.5px;
  }
  .jots-date-header .dow { color: var(--accent); }
  /* Markdown rendering (universal) */
  .md-content h1 { font-size: 18px; font-weight: 700; margin: 8px 0 4px; }
  .md-content h2 { font-size: 15px; font-weight: 700; margin: 4px 0 2px; }
  .md-content h3 { font-size: 14px; font-weight: 600; margin: 3px 0 2px; }
  .md-content h4 { font-size: 13px; font-weight: 600; margin: 3px 0 2px; }
  .md-content blockquote { border-left: 3px solid var(--accent); padding: 4px 12px; margin: 6px 0; color: var(--text-dim); }
  .md-content table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 12px; }
  .md-content th, .md-content td { padding: 6px 8px; border: 1px solid var(--border); }
  .md-content th { background: var(--surface2); text-align: left; }
  .md-content hr { border: none; border-top: 1px solid var(--border); margin: 12px 0; }
  .md-content del { color: var(--text-dim); }
  .md-content mark { background: rgba(255,213,79,0.3); padding: 1px 3px; border-radius: 3px; }
  /* ProseMirror / TipTap Editor */
  .daily-doc-container { margin-bottom: 24px; }
  .daily-doc-editor {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    min-height: 120px;
    transition: border-color 0.2s;
  }
  .daily-doc-editor:focus-within { border-color: var(--accent); }
  .daily-doc-editor.readonly { min-height: unset; opacity: 0.9; }
  .daily-doc-editor.readonly:focus-within { border-color: var(--border); }
  .ProseMirror { outline: none; color: var(--text); font-size: 14px; line-height: 1.6; }
  .ProseMirror p { margin: 4px 0; }
  .ProseMirror h1 { font-size: 20px; font-weight: 700; margin: 16px 0 6px; }
  .ProseMirror h2 { font-size: 16px; font-weight: 700; margin: 12px 0 4px; }
  .ProseMirror h3 { font-size: 14px; font-weight: 600; margin: 8px 0 3px; }
  .ProseMirror code {
    background: rgba(74,158,255,0.12); padding: 1px 5px; border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12.5px; color: var(--accent);
  }
  .ProseMirror pre {
    background: #1e1e2e; border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; margin: 8px 0; overflow-x: auto; font-size: 12.5px; line-height: 1.5;
  }
  .ProseMirror pre code { background: none; padding: 0; color: #abb2bf; font-size: 12.5px; }
  .ProseMirror blockquote {
    border-left: 3px solid var(--accent); padding: 4px 12px; margin: 8px 0;
    color: var(--text-dim); font-style: italic;
  }
  .ProseMirror hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
  .ProseMirror ul, .ProseMirror ol { margin: 4px 0 4px 18px; font-size: 14px; }
  .ProseMirror li { margin: 2px 0; }
  .ProseMirror li p { margin: 0; }
  .ProseMirror a { color: var(--accent); text-decoration: underline; cursor: pointer; }
  .ProseMirror ul[data-type="taskList"] {
    list-style: none; padding: 0; margin: 4px 0;
  }
  .ProseMirror ul[data-type="taskList"] li {
    display: flex; align-items: flex-start; gap: 8px; margin: 3px 0;
  }
  .ProseMirror ul[data-type="taskList"] li > label {
    flex-shrink: 0; margin-top: 3px;
  }
  .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"] {
    appearance: none; -webkit-appearance: none;
    width: 18px; height: 18px; border: 2px solid var(--border);
    border-radius: 4px; cursor: pointer; position: relative;
    background: transparent; transition: all 0.15s;
  }
  .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"]:hover {
    border-color: var(--accent);
  }
  .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"]:checked {
    background: var(--green); border-color: var(--green);
  }
  .ProseMirror ul[data-type="taskList"] li > label input[type="checkbox"]:checked::after {
    content: "‚úì"; color: #000; font-size: 12px; font-weight: 700;
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  }
  .ProseMirror ul[data-type="taskList"] li[data-checked="true"] > div > p {
    text-decoration: line-through; color: var(--text-dim);
  }
  .ProseMirror p.is-editor-empty:first-child::before {
    content: attr(data-placeholder);
    float: left; color: var(--text-dim); pointer-events: none; height: 0;
  }
  /* Mention badges */
  .mention-project {
    display: inline; background: rgba(124,92,255,0.15); color: var(--accent2);
    padding: 1px 6px; border-radius: 6px; font-size: 12px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }
  .mention-note {
    display: inline; background: rgba(74,158,255,0.15); color: var(--accent);
    padding: 1px 6px; border-radius: 6px; font-size: 12px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }
  .mention-project:hover, .mention-note:hover { opacity: 0.8; }
  /* Inline timestamp */
  .jot-time-inline { font-size: 11px; color: var(--text-dim); margin-right: 6px; }
  /* Slash command menu */
  .slash-menu {
    position: absolute; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); z-index: 600;
    max-height: 280px; overflow-y: auto; min-width: 220px; padding: 4px;
  }
  .slash-menu-item {
    padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px;
    display: flex; align-items: center; gap: 10px; transition: background 0.1s;
  }
  .slash-menu-item:hover, .slash-menu-item.active { background: var(--surface2); color: var(--accent); }
  .slash-menu-item .sm-icon { font-size: 16px; flex-shrink: 0; width: 24px; text-align: center; }
  .slash-menu-item .sm-label { font-weight: 500; }
  .slash-menu-item .sm-desc { font-size: 11px; color: var(--text-dim); margin-left: auto; }
  /* Suggestion dropdown (@ and #) */
  .suggestion-dropdown {
    position: absolute; background: var(--surface); border: 1px solid var(--border);
    border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); z-index: 600;
    max-height: 200px; overflow-y: auto; min-width: 200px; padding: 4px;
  }
  .suggestion-item {
    padding: 8px 12px; font-size: 13px; cursor: pointer; border-radius: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .suggestion-item:hover, .suggestion-item.active { background: var(--surface2); color: var(--accent); }
  /* Floating toolbar */
  .editor-float-toolbar {
    position: absolute; display: none; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 4px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 500; gap: 2px; align-items: center;
  }
  .editor-float-toolbar.visible { display: flex; }
  .eft-btn {
    background: none; border: none; color: var(--text); padding: 6px 8px;
    border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;
    transition: background 0.15s;
  }
  .eft-btn:hover { background: var(--surface2); }
  .eft-btn.is-active { color: var(--accent); background: rgba(74,158,255,0.1); }
  .eft-divider { width: 1px; height: 20px; background: var(--border); margin: 0 2px; }

  /* Selection toolbar */
  .selection-toolbar {
    position: fixed;
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 4px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 300;
    gap: 2px;
    align-items: center;
  }
  .selection-toolbar.visible { display: flex; }
  .sel-btn {
    background: none;
    border: none;
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    transition: background 0.15s;
  }
  .sel-btn:hover { background: var(--surface2); }
  .sel-btn.sel-task { color: var(--green); }
  .sel-btn.sel-task:hover { background: rgba(74,222,128,0.12); }
  .sel-divider { width: 1px; height: 20px; background: var(--border); margin: 0 2px; }

  .jot-day-section { margin-top: 16px; }
  .jot-day-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    -webkit-tap-highlight-color: transparent;
  }
  .jot-day-header:hover { color: var(--text); }
  .jot-day-toggle { font-size: 10px; transition: transform 0.2s; }
  .jot-day-header.open .jot-day-toggle { transform: rotate(90deg); }
  .jot-day-entries { display: none; }
  .jot-day-header.open + .jot-day-entries { display: block !important; }

  @media (max-width: 768px) {
    .daily-doc-editor { padding: 12px 14px; }
    .ProseMirror { font-size: 15px; }
  }

  /* Mobile Nav */
  .mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 8px 0 env(safe-area-inset-bottom, 8px);
    z-index: 100;
    justify-content: space-around;
  }
  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 10px;
    color: var(--text-dim);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .mobile-nav-item .icon { font-size: 20px; }
  .mobile-nav-item.active { color: var(--accent); }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .mobile-nav { display: flex; }
    .main { padding: 16px; padding-bottom: 80px; }
    .card-grid { grid-template-columns: 1fr; }
    .stat-row { grid-template-columns: 1fr 1fr; }
    .kanban { flex-direction: column; min-height: auto; gap: 12px; }
    .kanban-column { width: 100%; min-width: 100%; max-height: none; }
    .kanban-card { cursor: pointer; }
    .quick-add { flex-wrap: wrap; }
    .quick-add input { min-width: 100%; }
    .quick-add select { flex: 1; }
    .charts-bottom-grid { grid-template-columns: 1fr !important; }
    .chart-container-pnl, .chart-container-wr, .chart-container-bal { height: 200px !important; }
  }

  /* Time horizon toggle pills */
  .time-toggle {
    display: flex;
    gap: 4px;
    justify-content: flex-end;
    margin-bottom: 10px;
    overflow-x: auto;
    flex-wrap: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  .time-toggle-btn {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    transition: all 0.15s;
    letter-spacing: 0.3px;
  }
  .time-toggle-btn:hover { border-color: #3b82f6; color: var(--text); }
  .time-toggle-btn.active {
    background: #3b82f6;
    border-color: #3b82f6;
    color: #fff;
  }

  /* Sitewide Search */
  .search-trigger {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 8px 12px;
    padding: 8px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dim);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .search-trigger:hover { border-color: var(--accent); color: var(--text); }
  .search-trigger .search-kbd {
    margin-left: auto;
    font-size: 10px;
    background: var(--bg);
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid var(--border);
    font-family: monospace;
  }
  .search-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    align-items: flex-start;
    justify-content: center;
    padding-top: 15vh;
  }
  .search-overlay.active { display: flex; }
  .search-modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    width: 560px;
    max-width: 90vw;
    max-height: 60vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  .search-modal-input {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 16px;
    border-bottom: 1px solid var(--border);
  }
  .search-modal-input input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 16px;
    outline: none;
  }
  .search-modal-input .icon { font-size: 18px; color: var(--text-dim); }
  .search-results {
    overflow-y: auto;
    padding: 8px;
    flex: 1;
  }
  .search-results:empty::after {
    content: 'Type to search across everything...';
    display: block;
    text-align: center;
    padding: 24px;
    color: var(--text-dim);
    font-size: 13px;
  }
  .search-group-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    padding: 8px 12px 4px;
  }
  .search-result-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text);
    transition: background 0.1s;
  }
  .search-result-item:hover, .search-result-item.selected { background: var(--surface2); }
  .search-result-item .sr-icon { width: 20px; text-align: center; flex-shrink: 0; }
  .search-result-item .sr-body { flex: 1; min-width: 0; }
  .search-result-item .sr-title { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .search-result-item .sr-snippet { font-size: 11px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
  .search-result-item mark { background: var(--accent); color: #fff; border-radius: 2px; padding: 0 2px; }
  .search-modal-footer {
    padding: 8px 16px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
    display: flex;
    gap: 12px;
  }
  .search-modal-footer kbd {
    font-family: monospace;
    background: var(--bg);
    padding: 1px 4px;
    border-radius: 3px;
    border: 1px solid var(--border);
    font-size: 10px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" integrity="sha384-NrKB+u6Ts6AtkIhwPixiKTzgSKNblyhlk0Sohlgar9UHUBzai/sgnNNWWd291xqt" crossorigin="anonymous"></script>
</head>
<body>
<!-- Login Screen -->
<div id="login-screen" style="display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:320px;text-align:center;">
    <div style="font-size:32px;margin-bottom:8px;">ü§ñ</div>
    <h2 style="font-size:20px;margin-bottom:4px;">K-2 HQ</h2>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:24px;">Enter access code</p>
    <input type="password" id="login-code" placeholder="Access code" 
      style="width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;text-align:center;outline:none;margin-bottom:12px;"
      onkeydown="if(event.key==='Enter')checkLogin()">
    <div id="token-field" style="display:none;">
      <input type="password" id="login-token" placeholder="GitHub token (first time only)" 
        style="width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;text-align:center;outline:none;margin-bottom:12px;"
        onkeydown="if(event.key==='Enter')checkLogin()">
      <p style="font-size:10px;color:var(--text-dim);margin-bottom:12px;">Stored in browser session only. Never sent anywhere except GitHub API.</p>
    </div>
    <button onclick="checkLogin()" 
      style="width:100%;padding:12px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;">
      Enter
    </button>
    <p id="login-error" style="color:var(--red);font-size:12px;margin-top:12px;display:none;">Wrong code. Try again.</p>
  </div>
</div>
<script>
  const ACCESS_HASH = "78e370b587b145920213731b7c7c725e512b3b6577c51c800218a7c764c532ae"; // SHA-256 of access code
  async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  }
  async function checkLogin() {
    const code = document.getElementById('login-code').value;
    const hash = await sha256(code);
    if (hash !== ACCESS_HASH) {
      document.getElementById('login-error').style.display = 'block';
      document.getElementById('login-code').value = '';
      return;
    }
    // Check if we have a token already
    let token = localStorage.getItem('gh_token');
    const tokenInput = document.getElementById('login-token');
    if (!token && tokenInput.value) {
      token = tokenInput.value.trim();
    }
    if (!token) {
      // Show token field
      document.getElementById('token-field').style.display = 'block';
      document.getElementById('login-token').focus();
      if (!tokenInput.value) return;
    }
    localStorage.setItem('k2auth', 'true');
    localStorage.setItem('gh_token', token);
    GH_TOKEN = token;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-main').style.display = 'flex';
    loadData();
  }
  // Auto-login if already authed this session
  if (localStorage.getItem('k2auth') === 'true' && localStorage.getItem('gh_token')) {
    document.getElementById('login-screen').style.display = 'none';
  }
</script>

<div class="app" id="app-main" style="display:none;">

  <!-- Sitewide Search Modal -->
  <div class="search-overlay" id="search-overlay" onclick="if(event.target===this)closeSearch()">
    <div class="search-modal">
      <div class="search-modal-input">
        <span class="icon">üîç</span>
        <input type="text" id="search-input" placeholder="Search projects, notes, jots, tasks, discussions, decisions..." autocomplete="off" oninput="onSearchInput()">
      </div>
      <div class="search-results" id="search-results"></div>
      <div class="search-modal-footer">
        <span><kbd>‚Üë‚Üì</kbd> Navigate</span>
        <span><kbd>‚Üµ</kbd> Open</span>
        <span><kbd>Esc</kbd> Close</span>
      </div>
    </div>
  </div>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>ü§ñ <span>K-2</span> HQ</h1>
      <p>Command Center</p>
    </div>
    <div class="search-trigger" onclick="openSearch()">
      <span>üîç</span> Search...
      <span class="search-kbd">‚åòK</span>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <div class="nav-item" data-page="dashboard">
        <span class="icon">üìä</span> Dashboard
      </div>
      <!-- Viking AI Insights lives in Notes page -->
    </div>
    <div class="nav-section">
      <div class="nav-item active" data-page="jots">
        <span class="icon">‚úèÔ∏è</span> Jots
      </div>
      <div class="nav-section-title">Work</div>
      <div class="nav-item" data-page="projects">
        <span class="icon">üöÄ</span> Projects
        <span class="badge" id="project-count">0</span>
      </div>
      <div class="nav-item" data-page="tasks">
        <span class="icon">‚úÖ</span> Tasks
        <span class="badge" id="task-count">0</span>
      </div>
      <div class="nav-item" data-page="discussions">
        <span class="icon">üí¨</span> Discussions
      </div>
      <div class="nav-item" data-page="trading">
        <span class="icon">üìà</span> Trading
      </div>
      <div class="nav-item" data-page="growth">
        <span class="icon">üéØ</span> Growth
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Reference</div>
      <div class="nav-item" data-page="decisions">
        <span class="icon">‚öñÔ∏è</span> Decisions
      </div>
      <div class="nav-item" data-page="notes">
        <span class="icon">üìù</span> Notes
      </div>
      <div class="nav-item" data-page="ai-insights">
        <span class="icon">üöÄ</span> AI Insights
        <span class="badge" id="ai-insights-badge">0</span>
      </div>
    </div>
    <div class="sidebar-footer">
      Last synced: <span id="last-sync">just now</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">

    <!-- Dashboard Page -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Overview of active work and recent activity</p>
      </div>

      <div class="stat-row" id="stats-row">
        <!-- Populated by JS -->
      </div>

      <h3 style="font-size:16px; margin-bottom:12px;">Active Projects</h3>
      <div class="card-grid" id="dashboard-projects">
        <!-- Populated by JS -->
      </div>

      <div id="inbox-alert" style="display:none;background:rgba(74,158,255,0.1);border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üì®</span>
          <div>
            <div style="font-size:14px;font-weight:600;">Pending messages for K-2</div>
            <div id="inbox-count" style="font-size:12px;color:var(--text-dim);"></div>
          </div>
        </div>
      </div>

      <div id="dashboard-jots-card" class="card" style="margin-bottom:24px;display:none;cursor:pointer;" onclick="navigateTo('jots')">
        <div class="card-header">
          <span class="card-title">‚úèÔ∏è Today's Jots</span>
          <span style="font-size:12px;color:var(--accent);font-weight:500;">View all ‚Üí</span>
        </div>
        <div class="card-body" id="dashboard-jots-entries"></div>
      </div>

      <h3 style="font-size:16px; margin-bottom:12px;">Recent Activity</h3>
      <div class="timeline" id="dashboard-timeline">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Jots / Daily Docs Page -->
    <div class="page active" id="page-jots" style="max-width:900px;margin:0 auto;">
      <div class="page-header">
        <div class="jots-date-header" id="jots-today-date"></div>
        <p>Daily notes ‚Äî just start typing. Use markdown shortcuts, / for commands</p>
      </div>
      <div style="margin-bottom:12px;">
        <input type="text" id="jot-search" placeholder="üîç Search daily notes..." oninput="filterDailyDocs()" style="width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div id="daily-doc-today" class="daily-doc-container">
        <div id="daily-doc-today-editor" class="daily-doc-editor"></div>
      </div>
      <div id="daily-doc-previous"></div>
    </div>

    <!-- Projects Page (Kanban) -->
    <div class="page" id="page-projects">
      <div class="page-header">
        <h2>Projects</h2>
        <p>Drag cards between columns to update status</p>
      </div>
      <div class="kanban" id="kanban-board">
        <!-- Populated by JS -->
      </div>
      <div id="archived-projects" style="display:none;margin-top:24px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer;" onclick="toggleArchive()">
          <span id="archive-toggle-icon" style="color:var(--text-dim);font-size:12px;">‚ñ∂</span>
          <span style="font-size:14px;font-weight:600;color:var(--text-dim);">Archived</span>
          <span id="archive-count" style="font-size:11px;background:var(--surface2);color:var(--text-dim);padding:2px 8px;border-radius:99px;"></span>
        </div>
        <div id="archive-list" style="display:none;"></div>
      </div>
    </div>

    <!-- Tasks Page -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>Tasks</h2>
        <p>Things to get done</p>
      </div>
      <div class="quick-add">
        <input type="text" id="new-task-input" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addTask()">
        <select id="new-task-priority">
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
        <select id="new-task-project">
          <option value="">No Project</option>
        </select>
        <button onclick="addTask()">Add</button>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="my" data-group="tasks">üë§ My Tasks</button>
        <button class="filter-btn" data-filter="k2" data-group="tasks">ü§ñ K-2's Tasks</button>
        <button class="filter-btn" data-filter="all" data-group="tasks">All</button>
        <button class="filter-btn" data-filter="done" data-group="tasks">Done</button>
      </div>
      <div class="card">
        <ul class="task-list" id="task-list">
          <!-- Populated by JS -->
        </ul>
      </div>
    </div>

    <!-- Discussions Page -->
    <div class="page" id="page-discussions">
      <div class="page-header">
        <h2>Discussions</h2>
        <p>Key conversations and their context</p>
      </div>
      <div id="discussions-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Decisions Page -->
    <div class="page" id="page-decisions">
      <div class="page-header">
        <h2>Decisions</h2>
        <p>Choices made and their rationale</p>
      </div>
      <div id="decisions-timeline" class="timeline">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- ========== TRADING SECTION START ========== -->
    <!-- TRADING TOPIC K-2: You can ONLY edit between these markers -->
    <!-- DO NOT touch anything outside START/END markers -->
    <!-- Trading Page -->
    <div class="page" id="page-trading">
      <div class="page-header" id="trading-page-header">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
          <div>
            <h2 id="trading-title">Trading</h2>
            <p id="trading-subtitle">Books, positions & P&L across all strategies</p>
          </div>
          <div id="trading-mode-toggle" style="display:flex;align-items:center;gap:8px;">
            <div style="display:flex;background:var(--surface2);border-radius:20px;padding:3px;border:1px solid var(--border);">
              <button id="toggle-live" onclick="setTradingMode('live')" style="padding:6px 16px;border-radius:18px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:6px;">
                <span class="live-dot" style="width:8px;height:8px;border-radius:50%;background:#ef4444;animation:pulse-dot 1.5s ease-in-out infinite;"></span>
                LIVE
              </button>
              <button id="toggle-paper" onclick="setTradingMode('paper')" style="padding:6px 16px;border-radius:18px;border:none;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.2s;">
                üìù PAPER
              </button>
            </div>
          </div>
        </div>
      </div>
      <style>
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .trading-live-mode #trading-page-header { border-bottom: 2px solid #ef4444; padding-bottom: 12px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(239,68,68,0.1); }
        .trading-paper-mode #trading-page-header { border-bottom: 2px solid var(--border); padding-bottom: 12px; margin-bottom: 24px; }
        .trading-paper-mode .paper-watermark { display: block !important; }
      </style>
      <div class="stat-row" id="trading-stats-row"></div>

      <!-- Trading Charts -->
      <div id="trading-charts-section" style="display:none;margin-bottom:24px;">
        <div class="card" style="margin-bottom:16px;padding:20px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div style="font-size:15px;font-weight:600;">Cumulative P&L Over Time</div>
            <div class="time-toggle" style="margin-bottom:0;" id="toggle-pnl">
              <button class="time-toggle-btn" data-range="1H" onclick="setChartRange('pnl','1H')">1H</button>
              <button class="time-toggle-btn" data-range="6H" onclick="setChartRange('pnl','6H')">6H</button>
              <button class="time-toggle-btn active" data-range="1D" onclick="setChartRange('pnl','1D')">1D</button>
              <button class="time-toggle-btn" data-range="1W" onclick="setChartRange('pnl','1W')">1W</button>
              <button class="time-toggle-btn" data-range="1M" onclick="setChartRange('pnl','1M')">1M</button>
              <button class="time-toggle-btn" data-range="ALL" onclick="setChartRange('pnl','ALL')">ALL</button>
            </div>
          </div>
          <div style="position:relative;height:300px;" class="chart-container-pnl">
            <canvas id="chart-pnl"></canvas>
          </div>
          <div id="chart-pnl-empty" style="display:none;text-align:center;color:var(--text-dim);padding:40px;font-size:13px;">No resolved trades yet</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;" class="charts-bottom-grid">
          <div class="card" style="padding:20px;">
            <div style="font-size:15px;font-weight:600;margin-bottom:12px;">Win Rate by Book</div>
            <div style="position:relative;height:300px;" class="chart-container-wr">
              <canvas id="chart-winrate"></canvas>
            </div>
            <div id="chart-wr-empty" style="display:none;text-align:center;color:var(--text-dim);padding:40px;font-size:13px;">No resolved trades yet</div>
          </div>
          <div class="card" style="padding:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <div style="font-size:15px;font-weight:600;">Balance Over Time</div>
              <div class="time-toggle" style="margin-bottom:0;" id="toggle-balance">
                <button class="time-toggle-btn" data-range="1H" onclick="setChartRange('balance','1H')">1H</button>
                <button class="time-toggle-btn" data-range="6H" onclick="setChartRange('balance','6H')">6H</button>
                <button class="time-toggle-btn active" data-range="1D" onclick="setChartRange('balance','1D')">1D</button>
                <button class="time-toggle-btn" data-range="1W" onclick="setChartRange('balance','1W')">1W</button>
                <button class="time-toggle-btn" data-range="1M" onclick="setChartRange('balance','1M')">1M</button>
                <button class="time-toggle-btn" data-range="ALL" onclick="setChartRange('balance','ALL')">ALL</button>
              </div>
            </div>
            <div style="position:relative;height:300px;" class="chart-container-bal">
              <canvas id="chart-balance"></canvas>
            </div>
            <div id="chart-bal-empty" style="display:none;text-align:center;color:var(--text-dim);padding:40px;font-size:13px;">No trade history yet</div>
          </div>
        </div>
      </div>

      <div class="card-grid" id="trading-books-grid"></div>
      <div class="paper-watermark" style="display:none;text-align:center;color:rgba(136,136,160,0.2);font-size:48px;font-weight:900;letter-spacing:8px;margin-top:24px;user-select:none;">PAPER TRADING</div>
    </div>
    <!-- ========== TRADING SECTION END ========== -->

    <!-- Notes Page -->
    <div class="page" id="page-notes">
      <div class="page-header">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h2>Notes</h2>
            <p>Think out loud ‚Äî K-2 weighs in with analysis, ideas & pushback</p>
          </div>
          <button onclick="createNewNote()" style="padding:10px 16px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">‚úèÔ∏è New Note</button>
        </div>
      </div>

      <div id="notes-list">
        <!-- Populated by JS -->
      </div>

      <!-- Full-screen note editor -->
      <div id="note-editor-view" style="display:none;max-width:800px;margin:0 auto;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <button onclick="closeNoteEditor()" style="background:none;border:none;color:var(--accent);font-size:14px;cursor:pointer;">‚Üê Back to Notes</button>
          <div style="display:flex;gap:8px;align-items:center;">
            <select id="note-project-link" onchange="linkNoteToProject()" style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;">
              <option value="">No project</option>
            </select>
            <span id="note-save-status" style="font-size:11px;color:var(--text-dim);">Saved</span>
            <button onclick="deleteCurrentNote()" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;" title="Delete">üóë</button>
          </div>
        </div>
        <input type="text" id="note-title-input" placeholder="Note title..." style="width:100%;padding:12px 0;background:none;border:none;border-bottom:1px solid var(--border);color:var(--text);font-size:22px;font-weight:700;margin-bottom:12px;outline:none;">
        <div id="note-body-input" style="width:100%;min-height:50vh;padding:16px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:15px;line-height:1.8;outline:none;font-family:inherit;"></div>
        <div id="note-k2-response" style="display:none;margin-top:24px;padding:16px;background:rgba(74,158,255,0.08);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-size:12px;color:var(--accent);font-weight:600;">ü§ñ K-2's Take</span>
            <span id="note-k2-date" style="font-size:10px;color:var(--text-dim);"></span>
          </div>
          <div id="note-k2-text" class="md-content" style="font-size:14px;color:var(--text);line-height:1.7;"></div>
        </div>
        <div style="margin-top:16px;text-align:center;">
          <button onclick="requestK2TakeFromEditor()" id="note-k2-btn" style="padding:10px 24px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">ü§ñ Get K-2's Take</button>
        </div>
      </div>
    </div>

    <!-- AI Insights Page -->
    <div class="page" id="page-ai-insights">
      <div class="page-header">
        <h2>üöÄ Viking AI Insights</h2>
        <p>AI-powered recommendations and insights from the Viking team</p>
      </div>
      
      <div class="filter-bar" id="ai-insights-filters" style="margin-bottom:16px;">
        <button class="filter-btn active" data-filter="all" data-group="ai-insights">All</button>
        <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
        <button class="filter-btn" data-filter="New" data-group="ai-insights">New</button>
        <button class="filter-btn" data-filter="Reviewed" data-group="ai-insights">Reviewed</button>
        <button class="filter-btn" data-filter="In Progress" data-group="ai-insights">In Progress</button>
        <button class="filter-btn" data-filter="Done" data-group="ai-insights">Done</button>
        <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
        <button class="filter-btn" data-filter="High" data-group="ai-insights">High</button>
        <button class="filter-btn" data-filter="Medium" data-group="ai-insights">Med</button>
      </div>
      
      <div id="ai-insights-grid" class="card-grid">
        <!-- Populated by JS -->
      </div>
    </div>

    <div class="page" id="page-growth">
      <div class="page-header">
        <h2>PM Growth</h2>
        <p id="growth-subtitle">Head of Product track</p>
      </div>
      <div id="growth-content"></div>
    </div>

  </div>

  <!-- AI Insight Detail Modal -->
  <div id="ai-insight-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeAIInsightModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:600px;margin:40px auto;padding:24px;position:relative;">
      <button onclick="closeAIInsightModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">‚úï</button>
      <div id="ai-insight-modal-content"></div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="task-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeTaskModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;margin:40px auto;display:flex;flex-direction:column;max-height:calc(100vh - 80px);position:relative;">
      <button onclick="closeTaskModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;z-index:1;">‚úï</button>
      <div id="task-modal-content" style="padding:24px;overflow-y:auto;flex:1;"></div>
      <div id="task-modal-input" style="padding:12px 24px 24px;border-top:1px solid var(--border);flex-shrink:0;">
        <div style="display:flex;gap:8px;">
          <input type="text" id="task-msg-input" placeholder="Message or instruction for K-2..." 
            style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;"
            onkeydown="if(event.key==='Enter')sendTaskMessage()">
          <button onclick="sendTaskMessage()" style="padding:10px 16px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;">Send to K-2</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div id="project-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeProjectModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;margin:40px auto;padding:24px;position:relative;">
      <button onclick="closeProjectModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">‚úï</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="mobile-nav" id="mobile-nav">
    <div class="mobile-nav-item" data-page="dashboard" onclick="navigateTo('dashboard');setMobileActive(this)">
      <span class="icon">üìä</span>Home
    </div>
    <!-- Viking Insights removed from mobile nav -->
    <div class="mobile-nav-item active" data-page="jots" onclick="navigateTo('jots');setMobileActive(this)">
      <span class="icon">‚úèÔ∏è</span>Jots
    </div>
    <div class="mobile-nav-item" data-page="notes" onclick="navigateTo('notes');setMobileActive(this)">
      <span class="icon">üìù</span>Notes
    </div>
    <div class="mobile-nav-item" data-page="projects" onclick="navigateTo('projects');setMobileActive(this)">
      <span class="icon">üöÄ</span>Projects
    </div>
    <div class="mobile-nav-item" data-page="tasks" onclick="navigateTo('tasks');setMobileActive(this)">
      <span class="icon">‚úÖ</span>Tasks
    </div>
    <div class="mobile-nav-item" data-page="trading" onclick="navigateTo('trading');setMobileActive(this)">
      <span class="icon">üìà</span>Trading
    </div>
    <div class="mobile-nav-item" data-page="growth" onclick="navigateTo('growth');setMobileActive(this)">
      <span class="icon">üéØ</span>Growth
    </div>
    <div class="mobile-nav-item" data-page="discussions" onclick="navigateTo('discussions');setMobileActive(this)">
      <span class="icon">üí¨</span>Chats
    </div>
  </div>
</div>

<script>
function setMobileActive(el) {
  document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
}

// ============================================================
// DATA STORE ‚Äî loaded from server, synced on every change
// ============================================================

let DATA = { projects: [], discussions: [], tasks: [], decisions: [], notes: [], timeline: [], jots: [], dailyDocs: {}, commands: [], vikingInsights: [], trading: { books: [] }, growth: null };

// ============================================================
// APP LOGIC
// ============================================================

// GitHub API Config
// Data stored in a PRIVATE repo (RyanSandoval/k2-data) ‚Äî never in the public repo
const DATA_REPO = 'RyanSandoval/k2-data';
const DATA_FILE = 'data.json';
let GH_TOKEN = localStorage.getItem('gh_token') || '';
let GH_SHA = '';

function ghHeaders() {
  return {
    'Authorization': `token ${GH_TOKEN}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  };
}

async function loadData() {
  if (!GH_TOKEN) return;
  try {
    const res = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/${DATA_FILE}`, {
      headers: ghHeaders()
    });
    if (res.status === 404) {
      // First run ‚Äî create the file
      await saveData();
      return;
    }
    if (!res.ok) throw new Error(`GitHub API ${res.status}`);
    const file = await res.json();
    GH_SHA = file.sha;
    const d = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(file.content.replace(/\n/g, '')), c => c.charCodeAt(0))));
    DATA.projects = d.projects || [];
    DATA.discussions = d.discussions || [];
    DATA.tasks = d.tasks || [];
    DATA.decisions = d.decisions || [];
    DATA.notes = d.notes || [];
    DATA.timeline = d.timeline || [];
    DATA.inbox = d.inbox || [];
    DATA.jots = d.jots || [];
    DATA.dailyDocs = d.dailyDocs || {};
    DATA.commands = d.commands || [];
    DATA.vikingInsights = d.vikingInsights || [];
    DATA.trading = d.trading || { books: [] };
    // Backward compat: old format had trading.books, new has trading.paper/live
    if (DATA.trading.books && !DATA.trading.paper) {
      DATA.trading = { paper: { books: DATA.trading.books }, live: { books: [] } };
    }
    DATA.growth = d.growth || null;
    window._dataLoaded = true;
    renderAll();
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
  } catch(e) {
    console.error('Failed to load data:', e);
  }
}

async function saveData() {
  if (!GH_TOKEN) return;
  const syncEl = document.getElementById('last-sync');
  if (syncEl) syncEl.innerHTML = '<span style="color:var(--yellow);">‚è≥ Saving...</span>';
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));
    const body = {
      message: `Data update ${new Date().toISOString()}`,
      content: content
    };
    if (GH_SHA) body.sha = GH_SHA;
    const res = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/${DATA_FILE}`, {
      method: 'PUT',
      headers: ghHeaders(),
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      if (res.status === 409) { await loadData(); return; }
      throw new Error(`GitHub API ${res.status}`);
    }
    const result = await res.json();
    GH_SHA = result.content.sha;
    if (syncEl) syncEl.innerHTML = `<span style="color:var(--green);">‚úì</span> ${new Date().toLocaleTimeString()}`;
  } catch(e) {
    console.error('Failed to save data:', e);
    if (syncEl) syncEl.innerHTML = '<span style="color:var(--red);">‚úï Save failed</span>';
  }
}

function renderAll() {
  const fns = [renderDashboard, renderProjects, renderTasks, renderDiscussions,
               renderDecisions, renderNotes, migrateJotsToDailyDocs, renderDailyDocs,
               renderAIInsights, renderTrading, renderGrowth];
  for (const fn of fns) {
    try { fn(); } catch(e) { console.error(`[K2] renderAll: ${fn.name} failed:`, e); }
  }
}

// Navigation
function navigateTo(page) {
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
  if (navItem) navItem.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  // Sync mobile nav
  document.querySelectorAll('.mobile-nav-item').forEach(i => {
    i.classList.toggle('active', i.dataset.page === page);
  });
  // Scroll to top
  document.querySelector('.main').scrollTop = 0;
  // Auto-focus daily doc editor
  if (page === 'jots') {
    setTimeout(() => window._todayEditor?.commands?.focus?.('end'), 200);
  }
}

document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => navigateTo(item.dataset.page));
});

// Render Dashboard
function renderDashboard() {
  console.log('[K2 Debug] renderDashboard called, DATA.projects:', DATA.projects.length, 'items, statuses:', DATA.projects.map(p=>p.status));
  const pendingTasks = DATA.tasks.filter(t => !t.done).length;
  const activeProjects = DATA.projects.filter(p => p.status === 'active').length;
  console.log('[K2 Debug] activeProjects:', activeProjects);
  const totalDecisions = DATA.decisions.length;
  const openQuestions = DATA.discussions.reduce((n, d) => n + (d.openQuestions || []).length, 0);

  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('projects')">
      <div class="label">Active Projects</div>
      <div class="value" style="color:var(--accent)">${activeProjects}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('tasks')">
      <div class="label">Pending Tasks</div>
      <div class="value" style="color:var(--yellow)">${pendingTasks}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('decisions')">
      <div class="label">Decisions Made</div>
      <div class="value" style="color:var(--green)">${totalDecisions}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('discussions')">
      <div class="label">Open Questions</div>
      <div class="value" style="color:var(--orange)">${openQuestions}</div>
    </div>
  `;

  document.getElementById('dashboard-projects').innerHTML = DATA.projects.map(p => `
    <div class="card">
      <div class="card-header">
        <span class="card-title">${p.name}</span>
        <span class="status-dot status-${p.status}"></span>
      </div>
      <div class="card-body">${p.description}</div>
      <div class="card-footer">
        ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
      </div>
    </div>
  `).join('');

  const sortedTimeline = [...(DATA.timeline || [])].sort((a, b) => b.date.localeCompare(a.date));
  document.getElementById('dashboard-timeline').innerHTML = sortedTimeline.slice(0, 8).map(t => `
    <div class="timeline-item">
      <div class="timeline-date">${t.date}</div>
      <div class="timeline-content">${t.event}</div>
    </div>
  `).join('');

  // Inbox alert
  const inbox = (DATA.inbox || []).filter(m => !m.read);
  const inboxAlert = document.getElementById('inbox-alert');
  if (inboxAlert) {
    if (inbox.length > 0) {
      inboxAlert.style.display = 'block';
      document.getElementById('inbox-count').textContent = `${inbox.length} message${inbox.length > 1 ? 's' : ''} waiting`;
    } else {
      inboxAlert.style.display = 'none';
    }
  }
}

// Viking AI Insights Rendering (dedicated page)
function renderAIInsights() {
  const insights = DATA.vikingInsights || [];
  
  // Update nav badge
  const badge = document.getElementById('ai-insights-badge');
  if (badge) {
    const newCount = insights.filter(i => i.status === 'New').length;
    badge.textContent = newCount;
    badge.style.display = newCount > 0 ? 'inline' : 'none';
  }

  renderFilteredAIInsights();
  setupAIInsightsFilters();
}

function renderFilteredAIInsights() {
  const insights = DATA.vikingInsights || [];
  const gridContainer = document.getElementById('ai-insights-grid');
  if (!gridContainer) return;

  const activeFilters = Array.from(document.querySelectorAll('#ai-insights-filters .filter-btn.active'))
    .map(btn => btn.dataset.filter)
    .filter(f => f !== 'all');

  let filteredInsights = insights;

  if (activeFilters.length > 0) {
    filteredInsights = insights.filter(insight => {
      return activeFilters.some(filter => 
        insight.category === filter || 
        insight.impact === filter || 
        insight.status === filter
      );
    });
  }

  // Sort by most recently updated (dateUpdated or dateAdded), newest first
  filteredInsights = [...filteredInsights].sort((a, b) => {
    const aDate = a.dateUpdated || a.dateAdded || '';
    const bDate = b.dateUpdated || b.dateAdded || '';
    return bDate.localeCompare(aDate);
  });

  gridContainer.innerHTML = filteredInsights.map(insight => {
    const impactColor = insight.impact === 'High' ? 'var(--red)' : 
                       insight.impact === 'Medium' ? 'var(--yellow)' : 'var(--green)';
    const statusColor = insight.status === 'New' ? 'var(--accent)' :
                       insight.status === 'Reviewed' ? 'var(--accent2)' :
                       insight.status === 'In Progress' ? 'var(--yellow)' :
                       insight.status === 'Done' ? 'var(--green)' : 'var(--text-dim)';


  // Submission (copy/paste) fields
  const sub = insight.submission || {};
  const submissionOverview = sub.overview || '';
  const submissionDetails = bullets(sub.details || []);
  const submissionBenefits = bullets(sub.benefits || []);
  const submissionTech = bullets(sub.technologyRequired || []);
  const submissionEffort = sub.levelOfEffort || '';
  const submissionHorizon = sub.benefitHorizon || '';
  const submissionCost = sub.estimatedCost || '';
  const submissionSecurity = bullets(sub.securityConcerns || []);

  const submissionAllText = [
    `1. Idea Overview\n${submissionOverview}`,
    `2. Idea Details\n${submissionDetails}`,
    `3. Benefits to Viking\n${submissionBenefits}`,
    `4. Technology Required\n${submissionTech}`,
    `5. Level of Effort to Implement\n${submissionEffort}`,
    `6. Short or long term benefits\n${submissionHorizon}`,
    `7. Estimated Cost\n${submissionCost}`,
    `8. Security Concerns\n${submissionSecurity}`
  ].join('\n\n');

    // Get comment count for badge
    const commentCount = (insight.comments || []).length;

    return `
      <div class="card" style="cursor:pointer;" onclick="openAIInsightModal('${insight.id}')">
        ${commentCount > 0 ? `<div class="comment-badge">${commentCount} üí¨</div>` : ''}
        <div class="card-header">
          <span class="card-title">${insight.title}</span>
          <div style="display:flex;gap:4px;align-items:center;">
            <span style="font-size:11px;font-weight:600;color:${impactColor};">P${insight.priority}</span>
          </div>
        </div>
        <div class="card-body">${insight.description}</div>
        <div class="card-footer" style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <span class="tag tag-blue">${insight.category}</span>
            <span class="tag" style="background:rgba(${impactColor === 'var(--red)' ? '248,113,113' : impactColor === 'var(--yellow)' ? '251,191,36' : '74,222,128'},0.15);color:${impactColor};">${insight.impact}</span>
            <span class="tag" style="background:rgba(${statusColor === 'var(--accent)' ? '74,158,255' : statusColor === 'var(--accent2)' ? '124,92,255' : statusColor === 'var(--yellow)' ? '251,191,36' : statusColor === 'var(--green)' ? '74,222,128' : '136,136,160'},0.15);color:${statusColor};">${insight.status}</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);">${insight.dateAdded}</div>
        </div>
      </div>
    `;
  }).join('');
}

function setupAIInsightsFilters() {
  document.querySelectorAll('#ai-insights-filters .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = btn.dataset.filter;
      
      if (filter === 'all') {
        document.querySelectorAll('#ai-insights-filters .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        document.querySelector('#ai-insights-filters .filter-btn[data-filter="all"]')?.classList.remove('active');
        btn.classList.toggle('active');
        // If nothing active, re-activate "all"
        const anyActive = document.querySelectorAll('#ai-insights-filters .filter-btn.active').length;
        if (!anyActive) document.querySelector('#ai-insights-filters .filter-btn[data-filter="all"]').classList.add('active');
      }
      
      renderFilteredAIInsights();
    });
  });
}

function openAIInsightModal(insightId) {
  const insight = DATA.vikingInsights.find(i => i.id === insightId);
  if (!insight) return;

  // Initialize comments array if it doesn't exist
  if (!insight.comments) {
    insight.comments = [];
  }

  const modalContent = document.getElementById('ai-insight-modal-content');
  if (!modalContent) return;

  const impactColor = insight.impact === 'High' ? 'var(--red)' : 
                     insight.impact === 'Medium' ? 'var(--yellow)' : 'var(--green)';
  const statusColor = insight.status === 'New' ? 'var(--accent)' :
                     insight.status === 'Reviewed' ? 'var(--accent2)' :
                     insight.status === 'In Progress' ? 'var(--yellow)' :
                     insight.status === 'Done' ? 'var(--green)' : 'var(--text-dim)';

  modalContent.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
      <h3 style="font-size:18px;font-weight:700;flex:1;margin-right:16px;">${insight.title}</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:12px;font-weight:600;color:${impactColor};">P${insight.priority}</span>
      </div>
    </div>

    <p style="font-size:14px;color:var(--text-dim);line-height:1.6;margin-bottom:20px;">${insight.description}</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div>
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Category</div>
        <span class="tag tag-blue">${insight.category}</span>
      </div>
      <div>
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Impact</div>
        <span class="tag" style="background:rgba(${impactColor === 'var(--red)' ? '248,113,113' : impactColor === 'var(--yellow)' ? '251,191,36' : '74,222,128'},0.15);color:${impactColor};">${insight.impact}</span>
      </div>
    </div>

    <div style="margin-bottom:20px;">
      <label style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:8px;">Status</label>
      <select onchange="updateAIInsightStatus('${insight.id}', this.value)" style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
        <option value="New" ${insight.status === 'New' ? 'selected' : ''}>New</option>
        <option value="Reviewed" ${insight.status === 'Reviewed' ? 'selected' : ''}>Reviewed</option>
        <option value="In Progress" ${insight.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
        <option value="Done" ${insight.status === 'Done' ? 'selected' : ''}>Done</option>
        <option value="Dismissed" ${insight.status === 'Dismissed' ? 'selected' : ''}>Dismissed</option>
      </select>
    </div>

    ${insight.competitors ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Competitive Context</div>
        <div style="font-size:13px;color:var(--text);background:var(--surface2);padding:12px;border-radius:8px;border-left:3px solid var(--orange);">${insight.competitors}</div>
      </div>
    ` : ''}

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
      ${(insight.tags || []).map(tag => `<span class="tag tag-purple">${tag}</span>`).join('')}
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--text-dim);border-top:1px solid var(--border);padding-top:12px;margin-bottom:20px;">
      <div>Source: ${insight.source}</div>
      <div>Added: ${insight.dateAdded}</div>
    </div>



    <!-- Submission (copy/paste) Section -->
    <div class="submission-section">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px;">
        <h4 style="margin:0;">üìã Submission (copy/paste)</h4>
        <button class="copy-btn" onclick="copyFromTextarea('submission-all-${insight.id}')">Copy All (1‚Äì8)</button>
      </div>

      <textarea id="submission-all-${insight.id}" class="submission-textarea" readonly style="display:none;">${submissionAllText}</textarea>

      <div class="submission-grid">
        <div class="submission-field">
          <div class="submission-label">1. Idea Overview</div>
          <textarea id="sub-ov-${insight.id}" class="submission-textarea" readonly>${submissionOverview}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-ov-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">2. Idea Details</div>
          <textarea id="sub-det-${insight.id}" class="submission-textarea" readonly>${submissionDetails}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-det-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">3. Benefits to Viking</div>
          <textarea id="sub-ben-${insight.id}" class="submission-textarea" readonly>${submissionBenefits}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-ben-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">4. Technology Required</div>
          <textarea id="sub-tech-${insight.id}" class="submission-textarea" readonly>${submissionTech}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-tech-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">5. Level of Effort to Implement</div>
          <textarea id="sub-eff-${insight.id}" class="submission-textarea" readonly>${submissionEffort}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-eff-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">6. Short or long term benefits</div>
          <textarea id="sub-hor-${insight.id}" class="submission-textarea" readonly>${submissionHorizon}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-hor-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">7. Estimated Cost</div>
          <textarea id="sub-cost-${insight.id}" class="submission-textarea" readonly>${submissionCost}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-cost-${insight.id}')">Copy</button>
        </div>

        <div class="submission-field">
          <div class="submission-label">8. Security Concerns</div>
          <textarea id="sub-sec-${insight.id}" class="submission-textarea" readonly>${submissionSecurity}</textarea>
          <button class="copy-btn" onclick="copyFromTextarea('sub-sec-${insight.id}')">Copy</button>
        </div>
      </div>

      <div style="margin-top:8px;font-size:11px;color:var(--text-dim);">Tip: click each Copy button and paste into the matching Microsoft Forms box.</div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <h4>üí¨ Comments</h4>
      <div class="comments-list" id="comments-list-${insight.id}">
        ${insight.comments.map(comment => `
          <div class="comment ${comment.author === 'K-2' ? 'k2' : ''}">
            <div class="comment-avatar">${comment.author === 'K-2' ? 'ü§ñ' : 'üë§'}</div>
            <div class="comment-content">
              <div class="comment-author">${comment.author}</div>
              <div class="comment-text">${comment.text}</div>
              <div class="comment-time">${new Date(comment.timestamp).toLocaleString()}</div>
            </div>
          </div>
        `).join('')}
        ${insight.comments.length === 0 ? `
          <div style="text-align:center;color:var(--text-dim);padding:20px;font-size:13px;">
            No comments yet. Start the discussion below!
          </div>
        ` : ''}
      </div>
      <div class="comment-input-section">
        <textarea id="comment-input-${insight.id}" class="comment-input" placeholder="Add your thoughts... (Shift+Enter for new line, Enter to send)" rows="3" onkeydown="handleCommentKeydown(event, '${insight.id}')"></textarea>
        <div class="comment-actions">
          <button class="comment-btn" onclick="addComment('${insight.id}')">Send</button>
        </div>
      </div>
    </div>
  `;

  document.getElementById('ai-insight-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';

  // Auto-scroll to bottom of comments
  setTimeout(() => {
    const commentsList = document.getElementById(`comments-list-${insight.id}`);
    if (commentsList) {
      commentsList.scrollTop = commentsList.scrollHeight;
    }
  }, 100);
}

function closeAIInsightModal() {
  document.getElementById('ai-insight-modal').style.display = 'none';
  document.body.style.overflow = '';
}

async function updateAIInsightStatus(insightId, newStatus) {
  const insight = DATA.vikingInsights.find(i => i.id === insightId);
  if (!insight) return;

  insight.status = newStatus;
  insight.dateUpdated = (function(){var d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")})();
  await saveData();
  renderAIInsights();
  
  // Re-open modal to show updated status
  setTimeout(() => openAIInsightModal(insightId), 100);
}

function handleCommentKeydown(event, insightId) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    addComment(insightId);
  }
}

async function addComment(insightId) {
  const insight = DATA.vikingInsights.find(i => i.id === insightId);
  if (!insight) return;

  const input = document.getElementById(`comment-input-${insightId}`);
  const text = input.value.trim();
  if (!text) return;

  // Initialize comments array if it doesn't exist
  if (!insight.comments) {
    insight.comments = [];
  }

  // Add the comment
  const newComment = {
    author: 'Ryan',
    text: text,
    timestamp: new Date().toISOString()
  };

  insight.comments.push(newComment);
  input.value = '';

  await saveData();
  renderAIInsights(); // Update the comment badges on cards
  
  // Re-render the modal content to show the new comment
  openAIInsightModal(insightId);
}



// Clipboard helpers
async function copyTextToClipboard(text) {
  try {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      await navigator.clipboard.writeText(text);
      return true;
    }
  } catch (e) {
    // fall through
  }
  // Fallback
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.top = '-1000px';
  ta.style.left = '-1000px';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  let ok = false;
  try { ok = document.execCommand('copy'); } catch (e) { ok = false; }
  document.body.removeChild(ta);
  return ok;
}

async function copyFromTextarea(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const text = el.value || el.textContent || '';
  const ok = await copyTextToClipboard(text);
  // lightweight feedback
  if (ok) {
    try {
      el.classList.add('copied-flash');
      setTimeout(() => el.classList.remove('copied-flash'), 450);
    } catch (e) {}
  }
}

function bullets(arr) {
  if (!Array.isArray(arr) || arr.length === 0) return '';
  return arr.map(x => `- ${x}`).join('\n');
}

// ========== TRADING JAVASCRIPT START ==========
// TRADING TOPIC K-2: You can edit trading functions between these markers
// DO NOT modify functions outside these boundaries
// Trading mode state
let tradingMode = 'live'; // default to LIVE

function setTradingMode(mode) {
  tradingMode = mode;
  renderTrading();
}

function getTradingBooks() {
  const trading = DATA.trading || {};
  if (tradingMode === 'live') {
    return (trading.live || {}).books || [];
  } else {
    return (trading.paper || {}).books || [];
  }
}

// Trading
function renderTrading() {
  const books = getTradingBooks();

  // Update toggle buttons styling
  const liveBtn = document.getElementById('toggle-live');
  const paperBtn = document.getElementById('toggle-paper');
  const tradingPage = document.getElementById('page-trading');
  if (liveBtn && paperBtn) {
    if (tradingMode === 'live') {
      liveBtn.style.background = '#ef4444';
      liveBtn.style.color = '#fff';
      paperBtn.style.background = 'transparent';
      paperBtn.style.color = 'var(--text-dim)';
      tradingPage.classList.add('trading-live-mode');
      tradingPage.classList.remove('trading-paper-mode');
      document.getElementById('trading-subtitle').textContent = 'üî¥ LIVE ‚Äî Real money positions';
    } else {
      paperBtn.style.background = '#3b82f6';
      paperBtn.style.color = '#fff';
      liveBtn.style.background = 'transparent';
      liveBtn.style.color = 'var(--text-dim)';
      tradingPage.classList.add('trading-paper-mode');
      tradingPage.classList.remove('trading-live-mode');
      document.getElementById('trading-subtitle').textContent = 'üìù PAPER ‚Äî Simulated trading';
    }
  }

  // Empty state for live
  if (books.length === 0) {
    document.getElementById('trading-stats-row').innerHTML = '';
    document.getElementById('trading-books-grid').innerHTML = `
      <div style="grid-column:1/-1;text-align:center;padding:60px 20px;color:var(--text-dim);">
        <div style="font-size:48px;margin-bottom:12px;">${tradingMode === 'live' ? 'üî¥' : 'üìù'}</div>
        <div style="font-size:16px;font-weight:600;margin-bottom:4px;">No ${tradingMode} trades yet</div>
        <div style="font-size:13px;">Trades will appear here once the ${tradingMode} bot starts executing.</div>
      </div>
    `;
    const section = document.getElementById('trading-charts-section');
    if (section) section.style.display = 'none';
    return;
  }
  const totalBankroll = books.reduce((s, b) => s + (b.bankroll || 0), 0);
  const totalPnL = books.reduce((s, b) => s + (b.realizedPnL || 0), 0);
  const totalWins = books.reduce((s, b) => s + (b.wins || 0), 0);
  const totalLosses = books.reduce((s, b) => s + (b.losses || 0), 0);
  const totalOpen = books.reduce((s, b) => s + (b.open || 0), 0);
  const winRate = (totalWins + totalLosses) > 0 ? Math.round(totalWins / (totalWins + totalLosses) * 100) : 0;
  const pnlColor = totalPnL >= 0 ? 'var(--green)' : 'var(--red)';
  const pnlSign = totalPnL >= 0 ? '+' : '';

  const statsRow = document.getElementById('trading-stats-row');
  if (statsRow) {
    statsRow.innerHTML = `
      <div class="stat-card"><div class="label">Total Bankroll</div><div class="value" style="color:var(--accent)">$${totalBankroll.toFixed(0)}</div></div>
      <div class="stat-card"><div class="label">Realized P&L</div><div class="value" style="color:${pnlColor}">${pnlSign}$${totalPnL.toFixed(2)}</div></div>
      <div class="stat-card"><div class="label">Win Rate</div><div class="value" style="color:var(--green)">${winRate}%</div><div class="sub">${totalWins}W / ${totalLosses}L</div></div>
      <div class="stat-card"><div class="label">Open Positions</div><div class="value" style="color:var(--yellow)">${totalOpen}</div></div>
    `;
  }

  // === Charts ===
  renderTradingCharts(books);

  const grid = document.getElementById('trading-books-grid');
  if (grid) {
    grid.innerHTML = books.map(book => {
      const bPnlColor = (book.realizedPnL || 0) >= 0 ? 'var(--green)' : 'var(--red)';
      const bPnlSign = (book.realizedPnL || 0) >= 0 ? '+' : '';
      const trades = (book.trades || []);
      const bookId = book.id;

      return `
        <div class="card">
          <div class="card-header">
            <span class="card-title">${book.name}</span>
            <span style="font-size:13px;font-weight:700;color:${bPnlColor}">${bPnlSign}$${(book.realizedPnL||0).toFixed(2)}</span>
          </div>
          <div class="card-body">
            <div style="display:flex;gap:16px;margin-bottom:8px;font-size:13px;">
              <span>Balance: <strong>$${(book.balance||0).toFixed(2)}</strong> / $${(book.bankroll||0).toFixed(2)}</span>
            </div>
            <div style="display:flex;gap:12px;flex-wrap:wrap;">
              <span class="tag tag-green">${book.wins||0}W</span>
              <span class="tag tag-red">${book.losses||0}L</span>
              <span class="tag tag-yellow">${book.open||0} open</span>
            </div>
          </div>
          ${trades.length > 0 ? `
          <div class="card-footer" style="display:block;padding-top:12px;">
            <div style="cursor:pointer;font-size:12px;font-weight:600;color:var(--accent);margin-bottom:8px;" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none';this.textContent=this.nextElementSibling.style.display==='none'?'‚ñ∂ Show ${trades.length} trades':'‚ñº Hide trades'">‚ñ∂ Show ${trades.length} trades</div>
            <div style="display:none;">
              <table style="width:100%;font-size:12px;border-collapse:collapse;">
                <thead><tr style="color:var(--text-dim);text-align:left;">
                  <th style="padding:4px 6px;">Market</th>
                  <th style="padding:4px 6px;">Position</th>
                  <th style="padding:4px 6px;">Stake</th>
                  <th style="padding:4px 6px;">Status</th>
                  <th style="padding:4px 6px;">P&L</th>
                </tr></thead>
                <tbody>
                  ${trades.map(t => {
                    const sColor = t.status === 'won' ? 'var(--green)' : t.status === 'lost' ? 'var(--red)' : 'var(--yellow)';
                    const sBg = t.status === 'won' ? 'rgba(74,222,128,0.15)' : t.status === 'lost' ? 'rgba(248,113,113,0.15)' : 'rgba(251,191,36,0.15)';
                    const tPnl = t.pnl != null ? (t.pnl >= 0 ? '+' : '') + '$' + t.pnl.toFixed(2) : '‚Äî';
                    const tPnlColor = t.pnl != null ? (t.pnl >= 0 ? 'var(--green)' : 'var(--red)') : 'var(--text-dim)';
                    return `<tr title="${(t.reasoning||'').replace(/"/g,'&quot;')}" style="border-top:1px solid var(--border);">
                      <td style="padding:6px;">${t.market}</td>
                      <td style="padding:6px;">${t.position}</td>
                      <td style="padding:6px;">$${(t.stake||0).toFixed(2)}</td>
                      <td style="padding:6px;"><span style="padding:2px 6px;border-radius:4px;font-weight:600;font-size:11px;background:${sBg};color:${sColor};">${t.status}</span></td>
                      <td style="padding:6px;color:${tPnlColor};font-weight:600;">${tPnl}</td>
                    </tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }).join('');
  }
}

// Trading Charts
let chartPnl = null, chartWinrate = null, chartBalance = null;
let chartRangePnl = '1D', chartRangeBalance = '1D';
let _tradingBooks = []; // cached for re-render on range change

const BOOK_COLORS = {
  'Tennis': '#10b981',
  'Polymarket': '#8b5cf6',
  'Crypto 15m': '#f59e0b',
  'Polymarket 5m': '#3b82f6'
};
function getBookColor(name) {
  return BOOK_COLORS[name] || '#' + ((Math.abs(name.split('').reduce((a,c)=>a+c.charCodeAt(0),0))*2654435761)>>>0).toString(16).slice(0,6).padStart(6,'a');
}

function getRangeCutoff(range) {
  if (range === 'ALL') return null;
  const now = new Date();
  if (range === '1H') return new Date(now - 60*60*1000);
  if (range === '6H') return new Date(now - 6*60*60*1000);
  if (range === '1D') return new Date(now - 24*60*60*1000);
  if (range === '1W') return new Date(now - 7*24*60*60*1000);
  if (range === '1M') return new Date(now - 30*24*60*60*1000);
  return null;
}

function formatLabel(dateStr, range) {
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  if (range === '1H') return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
  if (range === '6H') return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
  if (range === '1D') return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
  if (range === '1W') return d.toLocaleDateString('en-US', { weekday: 'short' });
  if (range === '1M') return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  // ALL ‚Äî dates
  return dateStr.slice(0, 10);
}

function getDateKey(dateStr, range) {
  if (range === '1H' || range === '6H' || range === '1D') return dateStr; // keep full timestamp for granular grouping
  return (dateStr || '').slice(0, 10);
}

function setChartRange(chart, range) {
  // Update toggle buttons
  const container = document.getElementById('toggle-' + (chart === 'pnl' ? 'pnl' : 'balance'));
  if (container) {
    container.querySelectorAll('.time-toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.range === range));
  }
  if (chart === 'pnl') { chartRangePnl = range; updatePnlChart(); }
  else { chartRangeBalance = range; updateBalanceChart(); }
}

function collectResolvedTrades(books) {
  const allResolved = [];
  const bookMap = {};
  books.forEach(book => {
    const resolved = (book.trades || []).filter(t => t.status === 'won' || t.status === 'lost');
    if (resolved.length === 0) return;
    bookMap[book.name] = { color: getBookColor(book.name), resolved };
    resolved.forEach(t => {
      allResolved.push({ ...t, bookName: book.name, sortDate: t.closedAt || t.enteredAt || '' });
    });
  });
  return { allResolved, bookMap };
}

function filterByRange(trades, range) {
  const cutoff = getRangeCutoff(range);
  if (!cutoff) return trades;
  return trades.filter(t => {
    const d = new Date(t.sortDate || t.closedAt || t.enteredAt || 0);
    return d >= cutoff;
  });
}

const darkGrid = 'rgba(255,255,255,0.08)';
const defaultOpts = {
  responsive: true, maintainAspectRatio: false,
  animation: { duration: 400 },
  plugins: { legend: { labels: { color: '#e0e0e8', font: { size: 11 } } } },
  scales: {
    x: { ticks: { color: '#8888a0', font: { size: 10 } }, grid: { color: darkGrid } },
    y: { ticks: { color: '#8888a0', font: { size: 10 } }, grid: { color: darkGrid } }
  }
};

function updatePnlChart() {
  const books = _tradingBooks;
  const { allResolved, bookMap } = collectResolvedTrades(books);
  const filtered = filterByRange(allResolved, chartRangePnl);
  const range = chartRangePnl;

  const pnlCanvas = document.getElementById('chart-pnl');
  const pnlEmpty = document.getElementById('chart-pnl-empty');

  if (filtered.length === 0) {
    pnlCanvas.style.display = 'none'; pnlEmpty.style.display = 'block';
    if (chartPnl) { chartPnl.data.labels = []; chartPnl.data.datasets = []; chartPnl.update(); }
    return;
  }
  pnlCanvas.style.display = 'block'; pnlEmpty.style.display = 'none';

  filtered.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
  const dateKeys = [...new Set(filtered.map(t => getDateKey(t.sortDate, range)))].sort();
  const labels = dateKeys.map(d => formatLabel(d, range));

  const datasets = [];
  Object.keys(bookMap).forEach(name => {
    const info = bookMap[name];
    const bookFiltered = filterByRange(info.resolved.map(t => ({ ...t, sortDate: t.closedAt || t.enteredAt || '' })), range);
    bookFiltered.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
    let cum = 0;
    const cumByDate = {};
    bookFiltered.forEach(t => {
      const d = getDateKey(t.sortDate, range);
      cum += (t.pnl || 0);
      cumByDate[d] = cum;
    });
    let last = 0;
    const data = dateKeys.map(d => { if (cumByDate[d] !== undefined) last = cumByDate[d]; return last; });
    datasets.push({
      label: name, data, borderColor: info.color, backgroundColor: 'transparent',
      borderWidth: 2, pointRadius: 2, tension: 0.3
    });
  });
  const totalData = dateKeys.map((_, i) => datasets.reduce((s, ds) => s + ds.data[i], 0));
  datasets.push({
    label: 'Total', data: totalData, borderColor: '#ffffff', backgroundColor: 'transparent',
    borderWidth: 3, pointRadius: 2, tension: 0.3
  });

  if (chartPnl) {
    chartPnl.data.labels = labels;
    chartPnl.data.datasets = datasets;
    chartPnl.update();
  } else {
    chartPnl = new Chart(pnlCanvas, {
      type: 'line',
      data: { labels, datasets },
      options: { ...defaultOpts, plugins: { ...defaultOpts.plugins, tooltip: { mode: 'index', intersect: false } } }
    });
  }
}

function updateBalanceChart() {
  const books = _tradingBooks;
  const { allResolved } = collectResolvedTrades(books);
  const filtered = filterByRange(allResolved, chartRangeBalance);
  const range = chartRangeBalance;

  const balCanvas = document.getElementById('chart-balance');
  const balEmpty = document.getElementById('chart-bal-empty');

  if (filtered.length === 0) {
    balCanvas.style.display = 'none'; balEmpty.style.display = 'block';
    if (chartBalance) { chartBalance.data.labels = []; chartBalance.data.datasets = []; chartBalance.update(); }
    return;
  }
  balCanvas.style.display = 'block'; balEmpty.style.display = 'none';

  filtered.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
  const currentBalance = books.reduce((s, b) => s + (b.balance || 0), 0);
  const totalCurrentPnL = books.reduce((s, b) => s + (b.realizedPnL || 0), 0);
  const startBalance = currentBalance - totalCurrentPnL;

  // For filtered view, compute starting balance as startBalance + sum of PnL before cutoff
  const cutoff = getRangeCutoff(range);
  let preFilterPnL = 0;
  if (cutoff) {
    allResolved.forEach(t => {
      const d = new Date(t.sortDate || 0);
      if (d < cutoff) preFilterPnL += (t.pnl || 0);
    });
  }
  const filteredStart = startBalance + preFilterPnL;

  const dateKeys = [...new Set(filtered.map(t => getDateKey(t.sortDate, range)))].sort();
  const labels = dateKeys.map(d => formatLabel(d, range));
  let cum = 0;
  const pnlByDate = {};
  filtered.sort((a, b) => a.sortDate.localeCompare(b.sortDate));
  filtered.forEach(t => {
    const d = getDateKey(t.sortDate, range);
    cum += (t.pnl || 0);
    pnlByDate[d] = cum;
  });
  let last = 0;
  const balData = dateKeys.map(d => { if (pnlByDate[d] !== undefined) last = pnlByDate[d]; return filteredStart + last; });

  const dataset = {
    label: 'Balance', data: balData,
    borderColor: '#4a9eff', backgroundColor: 'rgba(74,158,255,0.15)',
    fill: true, borderWidth: 2, pointRadius: 2, tension: 0.3
  };

  if (chartBalance) {
    chartBalance.data.labels = labels;
    chartBalance.data.datasets = [dataset];
    chartBalance.update();
  } else {
    chartBalance = new Chart(balCanvas, {
      type: 'line',
      data: { labels, datasets: [dataset] },
      options: { ...defaultOpts, plugins: { ...defaultOpts.plugins, legend: { display: false } } }
    });
  }
}

function renderTradingCharts(books) {
  const section = document.getElementById('trading-charts-section');
  if (!section) return;
  _tradingBooks = books;

  const { allResolved, bookMap } = collectResolvedTrades(books);
  const hasData = allResolved.length > 0;
  section.style.display = 'block';

  // Destroy old charts on full re-render
  if (chartPnl) { chartPnl.destroy(); chartPnl = null; }
  if (chartWinrate) { chartWinrate.destroy(); chartWinrate = null; }
  if (chartBalance) { chartBalance.destroy(); chartBalance = null; }

  // --- P&L chart ---
  updatePnlChart();

  // --- Win Rate (horizontal bar) ‚Äî always all-time ---
  const wrCanvas = document.getElementById('chart-winrate');
  const wrEmpty = document.getElementById('chart-wr-empty');
  if (!hasData) {
    wrCanvas.style.display = 'none'; wrEmpty.style.display = 'block';
  } else {
    wrCanvas.style.display = 'block'; wrEmpty.style.display = 'none';
    const labels = [], data = [], colors = [];
    Object.keys(bookMap).forEach(name => {
      const trades = bookMap[name].resolved;
      const wins = trades.filter(t => t.status === 'won').length;
      const wr = Math.round(wins / trades.length * 100);
      labels.push(name); data.push(wr); colors.push(bookMap[name].color);
    });
    chartWinrate = new Chart(wrCanvas, {
      type: 'bar',
      data: { labels, datasets: [{ data, backgroundColor: colors, borderRadius: 6, barThickness: 28 }] },
      options: {
        ...defaultOpts, indexAxis: 'y',
        plugins: { ...defaultOpts.plugins, legend: { display: false } },
        scales: {
          x: { ...defaultOpts.scales.x, max: 100, ticks: { ...defaultOpts.scales.x.ticks, callback: v => v + '%' } },
          y: { ...defaultOpts.scales.y }
        }
      }
    });
  }

  // --- Balance chart ---
  updateBalanceChart();
}

// Kanban columns config
const KANBAN_COLUMNS = [
  { id: 'idea', label: 'Ideas', dot: 'dot-idea' },
  { id: 'planning', label: 'Planning', dot: 'dot-planning' },
  { id: 'active', label: 'In Progress', dot: 'dot-active' },
  { id: 'review', label: 'Review', dot: 'dot-review' },
  { id: 'done', label: 'Done', dot: 'dot-done' }
];
// ========== TRADING JAVASCRIPT END ==========

function renderGrowth() {
  const container = document.getElementById('growth-content');
  if (!container) return;
  const g = DATA.growth;
  if (!g) { container.innerHTML = '<p style="color:var(--text-dim)">No growth data yet.</p>'; return; }

  const pillars = (g.pillars||[]);
  const skills = (g.skills||[]);
  const checkins = (g.monthlyCheckins||[]);

  // Pillar progress
  function pillarProgress(p) {
    const items = (p.items||[]);
    if (!items.length) return 0;
    return Math.round(items.filter(i => i.done).length / items.length * 100);
  }

  let html = '';

  // Goal banner
  html += `<div style="background:linear-gradient(135deg,var(--surface2),var(--surface));border:1px solid var(--accent);border-radius:12px;padding:20px;margin-bottom:24px;">
    <div style="font-size:13px;color:var(--accent);font-weight:600;margin-bottom:4px;">THE GOAL</div>
    <div style="font-size:20px;font-weight:700;color:var(--text);">${g.goal||''}</div>
    <div style="font-size:13px;color:var(--text-dim);margin-top:8px;">${g.currentRole||''} ¬∑ ${g.company||''}</div>
  </div>`;

  // Pillars
  html += '<div style="margin-bottom:32px;">';
  html += '<h3 style="font-size:15px;font-weight:700;color:var(--text);margin:0 0 16px 0;">Growth Pillars</h3>';

  pillars.forEach(p => {
    const pct = pillarProgress(p);
    const items = (p.items||[]);
    const highItems = items.filter(i => i.priority === 'high' && !i.done);
    
    html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <span style="font-size:18px;">${p.icon||''}</span>
          <span style="font-size:15px;font-weight:700;color:var(--text);margin-left:8px;">${p.name||''}</span>
          <span style="font-size:12px;color:var(--text-dim);margin-left:8px;">${p.phase||''}</span>
        </div>
        <span style="font-size:13px;font-weight:600;color:var(--accent);">${pct}%</span>
      </div>
      <div style="background:var(--surface2);border-radius:4px;height:6px;margin-bottom:16px;overflow:hidden;">
        <div style="background:var(--accent);height:100%;width:${pct}%;border-radius:4px;transition:width 0.3s;"></div>
      </div>
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;">${p.description||''}</div>`;

    items.forEach((item, idx) => {
      const priorityColor = item.priority === 'high' ? '#f87171' : item.priority === 'medium' ? '#fbbf24' : 'var(--text-dim)';
      const cadenceBadge = item.cadence ? `<span style="font-size:10px;background:var(--surface2);color:var(--text-dim);padding:2px 6px;border-radius:4px;margin-left:6px;">${item.cadence}</span>` : '';
      html += `<div style="display:flex;align-items:flex-start;gap:10px;padding:8px 0;border-top:1px solid var(--border);">
        <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleGrowthItem('${p.id}',${idx},this.checked)" style="margin-top:2px;accent-color:var(--accent);cursor:pointer;">
        <div style="flex:1;">
          <span style="font-size:13px;color:${item.done ? 'var(--text-dim)' : 'var(--text)'};${item.done ? 'text-decoration:line-through;' : ''}">${item.text}</span>
          ${cadenceBadge}
        </div>
        <span style="width:8px;height:8px;border-radius:50%;background:${priorityColor};flex-shrink:0;margin-top:6px;" title="${item.priority} priority"></span>
      </div>`;
    });

    html += '</div>';
  });
  html += '</div>';

  // Skills
  html += '<div style="margin-bottom:32px;">';
  html += '<h3 style="font-size:15px;font-weight:700;color:var(--text);margin:0 0 16px 0;">Strategic Skills Track</h3>';
  html += '<div class="card-grid" style="grid-template-columns:repeat(auto-fill,minmax(260px,1fr));">';

  skills.forEach(s => {
    const ratingDisplay = s.rating ? `<span style="font-size:24px;font-weight:700;color:var(--accent);">${s.rating}/5</span>` : `<span style="font-size:12px;color:var(--text-dim);">Not rated</span>`;
    const reading = (s.reading||[]);

    html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:15px;font-weight:700;color:var(--text);">${s.icon||''} ${s.name||''}</span>
        ${ratingDisplay}
      </div>
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">${s.description||''}</div>
      <div style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:4px;">Weekly Exercise:</div>
      <div style="font-size:12px;color:var(--text);margin-bottom:12px;">${s.exercise||''}</div>
      ${reading.length ? `<div style="font-size:11px;color:var(--text-dim);">üìö ${reading.join(' ¬∑ ')}</div>` : ''}
    </div>`;
  });

  html += '</div></div>';

  // Monthly check-in section
  html += `<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;">
    <h3 style="font-size:15px;font-weight:700;color:var(--text);margin:0 0 12px 0;">Monthly Check-Ins</h3>
    <div style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Review cadence: ${g.reviewCadence||'Monthly'} ¬∑ Last updated: ${g.lastUpdated||'‚Äî'}</div>`;

  if (checkins.length === 0) {
    html += '<p style="font-size:13px;color:var(--text-dim);font-style:italic;">No check-ins yet. First one coming soon.</p>';
  } else {
    checkins.slice().reverse().forEach(c => {
      html += `<div style="border-top:1px solid var(--border);padding:12px 0;">
        <div style="font-weight:600;font-size:13px;color:var(--accent);margin-bottom:6px;">${c.date||''}</div>
        <div style="font-size:13px;color:var(--text);white-space:pre-wrap;">${c.notes||''}</div>
      </div>`;
    });
  }

  html += '</div>';

  container.innerHTML = html;
}

async function toggleGrowthItem(pillarId, itemIdx, checked) {
  const g = DATA.growth;
  if (!g) return;
  const pillar = (g.pillars||[]).find(p => p.id === pillarId);
  if (!pillar || !(pillar.items||[])[itemIdx]) return;
  pillar.items[itemIdx].done = checked;
  renderGrowth();
  await saveData('Growth item updated');
}

function renderProjects() {
  // Update sidebar badge
  const activeCount = DATA.projects.filter(p => p.status !== 'done' && p.status !== 'archived').length;
  const projBadge = document.getElementById('project-count');
  if (projBadge) {
    projBadge.textContent = activeCount;
    projBadge.style.display = activeCount > 0 ? 'inline' : 'none';
  }

  const board = document.getElementById('kanban-board');
  board.innerHTML = KANBAN_COLUMNS.map(col => {
    const projects = DATA.projects.filter(p => p.status === col.id);
    const taskCounts = projects.map(p => {
      const total = DATA.tasks.filter(t => t.project === p.id).length;
      const done = DATA.tasks.filter(t => t.project === p.id && t.done).length;
      return { total, done };
    });

    return `
      <div class="kanban-column" data-column="${col.id}"
           ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${col.id}')">
        <div class="kanban-column-header">
          <span class="column-dot ${col.dot}"></span>
          ${col.label}
          <span class="count">${projects.length}</span>
        </div>
        <div class="kanban-cards">
          ${projects.map((p, i) => `
            <div class="kanban-card" draggable="true" data-project-id="${p.id}"
                 ondragstart="onDragStart(event, '${p.id}')" ondragend="onDragEnd(event)"
                 onclick="openProjectModal('${p.id}')">
              <div class="kanban-card-title">${p.name}</div>
              <div class="kanban-card-desc">${p.description}</div>
              ${(p.nextSteps||[]).length ? `
                <div style="font-size:11px;color:var(--text);margin-bottom:8px;">
                  <strong>Next:</strong> <span style="color:var(--text-dim)">${typeof (p.nextSteps||[])[0] === 'string' ? (p.nextSteps||[])[0] : (p.nextSteps||[])[0].text}</span>
                  ${(p.nextSteps||[]).length > 1 ? `<span style="color:var(--text-dim);font-style:italic"> +${(p.nextSteps||[]).length - 1} more</span>` : ''}
                </div>
              ` : ''}
              <div class="kanban-card-footer">
                ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
              </div>
              <div class="kanban-card-meta">
                <span class="kanban-card-date">Since ${p.started}</span>
                ${taskCounts[i].total > 0 ? `
                  <span class="kanban-card-tasks">‚úÖ ${taskCounts[i].done}/${taskCounts[i].total}</span>
                ` : ''}
              </div>
            </div>
          `).join('')}
          <div class="kanban-drop-zone" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${col.id}')"></div>
        </div>
      </div>
    `;
  }).join('');

  // Render archived projects
  const archived = DATA.projects.filter(p => p.status === 'archived');
  const archiveSection = document.getElementById('archived-projects');
  const archiveCount = document.getElementById('archive-count');
  const archiveList = document.getElementById('archive-list');
  if (archived.length > 0) {
    archiveSection.style.display = 'block';
    archiveCount.textContent = archived.length;
    archiveList.innerHTML = archived.map(p => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface2);border-radius:8px;margin-bottom:6px;">
        <div>
          <div style="font-size:13px;font-weight:600;color:var(--text-dim);">${p.name}</div>
          <div style="font-size:11px;color:var(--text-dim);">${p.description || ''} ¬∑ Archived ${p.archivedAt ? new Date(p.archivedAt).toLocaleDateString() : ''}</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button onclick="restoreProject('${p.id}')" style="padding:6px 12px;background:var(--blue);border:none;border-radius:6px;color:#fff;font-size:11px;cursor:pointer;">Restore</button>
          <button onclick="deleteProject('${p.id}')" style="padding:6px 12px;background:var(--red);border:none;border-radius:6px;color:#fff;font-size:11px;cursor:pointer;">Delete</button>
        </div>
      </div>
    `).join('');
  } else {
    archiveSection.style.display = 'none';
  }
}

function toggleArchive() {
  const list = document.getElementById('archive-list');
  const icon = document.getElementById('archive-toggle-icon');
  if (list.style.display === 'none') {
    list.style.display = 'block';
    icon.textContent = '‚ñº';
  } else {
    list.style.display = 'none';
    icon.textContent = '‚ñ∂';
  }
}

// Task Detail Modal
let activeTaskId = null;

// Safe ID for use in onclick HTML attributes (handles string and number IDs)
function safeId(id) { return typeof id === 'string' ? "'" + id.replace(/'/g,"\\'") + "'" : id; }

function openTaskModal(taskId) {
  activeTaskId = taskId;
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  if (!task.messages) task.messages = [];
  
  const project = DATA.projects.find(p => p.id === task.project);
  const projectName = project ? project.name : 'General';
  const projectGoal = project ? project.goal : '';
  const ownerBadge = task.owner === 'k2' ? 'ü§ñ' : 'üë§';
  const ownerLabel = task.owner === 'k2' ? 'K-2' : 'Ryan';
  const priorityCycle = { high: 'medium', medium: 'low', low: 'high' };

  const isK2 = task.owner === 'k2';
  const k2Status = task.k2Status || 'pending';
  const k2StatusConfig = { pending: { icon: '‚è≥', label: 'Pending', color: 'var(--text-dim)' }, 'in-progress': { icon: 'üî®', label: 'In Progress', color: 'var(--orange)' }, review: { icon: 'üëÄ', label: 'Review', color: 'var(--yellow)' }, done: { icon: '‚úÖ', label: 'Done', color: 'var(--green)' } };
  const statusInfo = (isK2 ? k2StatusConfig[k2Status] : null) || k2StatusConfig.pending;

  // Left element: checkbox for Ryan, status for K-2
  const leftElModal = isK2
    ? `<span style="font-size:20px;flex-shrink:0;margin-top:2px;" title="${statusInfo.label}">${statusInfo.icon}</span>`
    : `<div class="task-check ${task.done ? 'done' : ''}" onclick="toggleTask(${safeId(task.id)});openTaskModal(${safeId(task.id)})" style="margin-top:2px;flex-shrink:0;"></div>`;

  // Activity log
  const activity = task.activity || [];
  const activityActionIcons = { started: 'üî®', completed: '‚úÖ', queued: 'üöÄ', rework: 'üîÑ', accepted: 'üëç', created: 'üìù' };

  document.getElementById('task-modal-content').innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
      ${leftElModal}
      <div style="flex:1;">
        <h3 style="font-size:16px;font-weight:700;cursor:pointer;${task.done ? 'text-decoration:line-through;color:var(--text-dim)' : ''}" onclick="editTaskField(${safeId(task.id)},'text',this)" title="Click to edit">${task.text || task.title || 'Untitled'}</h3>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center;">
          <span style="cursor:pointer;font-size:14px;background:var(--surface2);padding:2px 8px;border-radius:6px;border:1px solid var(--border);" onclick="cycleTaskOwner(${safeId(task.id)})" title="Click to reassign">${ownerBadge} ${ownerLabel}</span>
          ${isK2 ? `<span style="font-size:11px;padding:2px 8px;border-radius:6px;font-weight:600;color:${statusInfo.color};background:color-mix(in srgb, ${statusInfo.color} 15%, transparent);">${statusInfo.icon} ${statusInfo.label}</span>` : ''}
          <span class="tag tag-blue">${projectName}</span>
          <span class="task-priority priority-${task.priority}" style="cursor:pointer;" onclick="cycleTaskPriority(${safeId(task.id)})" title="Click to cycle priority">${task.priority}</span>
          <span class="tag tag-purple">${task.created}</span>
        </div>
      </div>
    </div>

    ${task.context ? `
    <div style="margin-bottom:12px;background:var(--surface2);border-radius:8px;padding:10px 12px;border-left:3px solid var(--accent2);cursor:pointer;" onclick="editTaskField(${safeId(task.id)},'context',this.querySelector('.ctx-text'))" title="Click to edit context">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent2);font-weight:600;margin-bottom:4px;">Context</div>
      <div class="ctx-text" style="font-size:12px;color:var(--text-dim);line-height:1.5;">${task.context}</div>
    </div>
    ` : `
    <div style="margin-bottom:12px;font-size:12px;color:var(--text-dim);cursor:pointer;padding:8px;border:1px dashed var(--border);border-radius:8px;text-align:center;" onclick="editTaskField(${safeId(task.id)},'context',this)">+ Add context</div>
    `}

    ${projectGoal ? `
    <div style="margin-bottom:12px;background:var(--surface2);border-radius:8px;padding:10px 12px;border-left:3px solid var(--green);">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--green);font-weight:600;margin-bottom:4px;">üéØ Project Goal ‚Äî ${projectName}</div>
      <div style="font-size:12px;color:var(--text-dim);line-height:1.5;">${projectGoal}</div>
    </div>
    ` : ''}

    ${isK2 && k2Status === 'pending' && !task.done ? `
    <div style="margin-bottom:12px;">
      <button onclick="queueTaskForK2(${safeId(task.id)})" style="width:100%;padding:10px;background:var(--green);border:none;border-radius:8px;color:#000;font-size:13px;font-weight:600;cursor:pointer;">‚ñ∂ Queue for K-2</button>
    </div>
    ` : ''}

    ${isK2 && k2Status === 'review' ? `
    <div style="margin-bottom:12px;display:flex;gap:8px;">
      <button onclick="acceptK2Task(${safeId(task.id)})" style="flex:1;padding:10px;background:var(--green);border:none;border-radius:8px;color:#000;font-size:13px;font-weight:600;cursor:pointer;">üëç Accept</button>
      <button onclick="reworkK2Task(${safeId(task.id)})" style="flex:1;padding:10px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;">üëé Rework</button>
    </div>
    ` : ''}

    ${activity.length > 0 ? `
    <div style="margin-bottom:12px;">
      <div style="font-size:12px;font-weight:600;color:var(--text-dim);margin-bottom:8px;">Recent Activity</div>
      <div style="display:flex;flex-direction:column;gap:6px;">
        ${[...activity].reverse().map(a => `
          <div style="display:flex;gap:8px;padding:8px 10px;background:var(--surface2);border-radius:8px;font-size:12px;">
            <span style="flex-shrink:0;">${activityActionIcons[a.action] || 'üìå'}</span>
            <div style="flex:1;">
              <div style="font-weight:600;color:var(--text);text-transform:capitalize;">${a.action}</div>
              ${a.detail ? `<div style="color:var(--text-dim);margin-top:2px;line-height:1.5;">${a.detail}</div>` : ''}
            </div>
            <span style="font-size:10px;color:var(--text-dim);flex-shrink:0;white-space:nowrap;">${a.date ? new Date(a.date).toLocaleDateString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'}) : ''}</span>
          </div>
        `).join('')}
      </div>
    </div>
    ` : ''}

    <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:var(--text-dim);">Thread</div>
    <div id="task-thread" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;">
      ${task.messages.length === 0 ? 
        '<div style="font-size:12px;color:var(--text-dim);padding:16px;text-align:center;background:var(--surface2);border-radius:8px;">No messages yet. Send an instruction or update below.</div>' :
        task.messages.map(m => `
          <div style="display:flex;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:8px;${m.from === 'k2' ? 'border-left:3px solid var(--accent)' : 'border-left:3px solid var(--green)'};">
            <div style="flex-shrink:0;font-size:14px;">${m.from === 'k2' ? 'ü§ñ' : 'üë§'}</div>
            <div style="flex:1;">
              <div style="font-size:11px;color:var(--text-dim);margin-bottom:2px;">${m.from === 'k2' ? 'K-2' : 'Ryan'} ¬∑ ${m.time}</div>
              <div style="font-size:13px;line-height:1.5;">${m.text}</div>
            </div>
          </div>
        `).join('')
      }
    </div>

    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">
      <button onclick="deleteTask(${safeId(task.id)})" style="width:100%;padding:8px 12px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:12px;cursor:pointer;">Delete Task</button>
    </div>
  `;

  document.getElementById('task-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Scroll thread to bottom
  setTimeout(() => {
    const thread = document.getElementById('task-thread');
    if (thread) thread.scrollTop = thread.scrollHeight;
  }, 50);
}

async function deleteTask(taskId) {
  if (!confirm('Delete this task?')) return;
  DATA.tasks = DATA.tasks.filter(t => t.id != taskId);
  await saveData();
  closeTaskModal();
  renderTasks();
  renderProjects();
}

function closeTaskModal() {
  document.getElementById('task-modal').style.display = 'none';
  document.body.style.overflow = '';
  activeTaskId = null;
}

async function sendTaskMessage() {
  const input = document.getElementById('task-msg-input');
  const text = input.value.trim();
  if (!text || !activeTaskId) return;

  const task = DATA.tasks.find(t => t.id === activeTaskId);
  if (!task) return;
  if (!task.messages) task.messages = [];

  const now = new Date();
  const time = now.toISOString().replace('T', ' ').slice(0, 16);

  task.messages.push({
    from: 'ryan',
    text: text,
    time: time
  });

  // Also add to inbox for K-2 to pick up
  if (!DATA.inbox) DATA.inbox = [];
  DATA.inbox.push({
    taskId: activeTaskId,
    taskText: task.text,
    message: text,
    time: time,
    read: false
  });

  input.value = '';
  await saveData();
  openTaskModal(activeTaskId); // Re-render
}

// Project Detail Modal
function openProjectModal(projectId) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p) return;
  if (!p.notes) p.notes = [];
  if (!p.goal) p.goal = '';
  const tasks = DATA.tasks.filter(t => t.project === p.id);
  const decisions = DATA.decisions.filter(d => d.project === p.id);
  const discussions = DATA.discussions.filter(d => d.project === p.id);

  const priorityColors = { high: 'var(--red)', medium: 'var(--yellow)', low: 'var(--text-dim)' };
  const priorityDots = { high: 'üî¥', medium: 'üü°', low: '‚ö™' };

  document.getElementById('modal-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
      <span class="status-dot status-${p.status}" style="width:12px;height:12px;"></span>
      <h3 style="font-size:18px;font-weight:700;">${p.name}</h3>
    </div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;" onclick="editProjectField('${p.id}','description',this)" title="Click to edit">${p.description}</p>

    <!-- Goal / Definition of Done -->
    <div style="margin-bottom:16px;background:var(--surface2);border-radius:8px;padding:12px;border-left:3px solid var(--green);">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--green);font-weight:600;margin-bottom:4px;">üéØ Goal / What Done Looks Like</div>
      <p style="font-size:13px;color:var(--text);line-height:1.6;cursor:pointer;" onclick="editProjectField('${p.id}','goal',this)" title="Click to edit">${p.goal || '<span style=color:var(--text-dim)>Click to define the goal...</span>'}</p>
    </div>

    <div style="margin-bottom:16px;">
      <label style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;">Status</label>
      <select onchange="changeProjectStatus('${p.id}', this.value)" style="display:block;width:100%;margin-top:4px;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
        ${KANBAN_COLUMNS.map(col => `<option value="${col.id}" ${p.status === col.id ? 'selected' : ''}>${col.label}</option>`).join('')}
      </select>
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Tags</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
        <span class="tag tag-purple">Since ${p.started}</span>
      </div>
    </div>

    ${(p.nextSteps||[]).length ? `
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-size:12px;font-weight:600;">Next Steps</div>
          <div style="display:flex;gap:6px;align-items:center;">
            <span onclick="window._hideDoneSteps=!window._hideDoneSteps;openProjectModal('${p.id}')" style="font-size:11px;color:var(--text-dim);cursor:pointer;padding:2px 8px;background:${window._hideDoneSteps ? 'var(--accent)' : 'var(--surface2)'};border:1px solid var(--border);border-radius:6px;">${window._hideDoneSteps ? 'üëÅ Show done' : 'üôà Hide done'}</span>
            <button onclick="addNextStep('${p.id}')" style="font-size:11px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--accent);padding:4px 10px;cursor:pointer;">+ Add</button>
          </div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;overflow:hidden;">
          ${(p.nextSteps||[]).map((s, i) => {
            const text = typeof s === 'string' ? s : s.text;
            const pri = typeof s === 'string' ? 'medium' : (s.priority || 'medium');
            const status = (typeof s === 'object' && s.status) || 'pending';
            if (window._hideDoneSteps && status === 'done') return '';
            const statusBadge = status === 'queued' ? '<span style="font-size:10px;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px;">‚è≥ Queued</span>'
              : status === 'in-progress' ? '<span style="font-size:10px;background:var(--orange);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">üî® In Progress</span>'
              : status === 'done' ? '<span style="font-size:10px;background:var(--green);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">‚úÖ Done</span>'
              : status === 'review' ? '<span style="font-size:10px;background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">üëÄ Review</span>'
              : '';
            const showDoIt = status === 'pending';
            const showAccept = status === 'review';
            return `
            <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);font-size:12px;${status === 'done' ? 'opacity:0.5;' : ''}">
              <span style="cursor:pointer;font-size:14px;" onclick="cycleStepPriority('${p.id}',${i})" title="${pri} priority">${priorityDots[pri]}</span>
              <span style="flex:1;cursor:pointer;${status === 'done' ? 'text-decoration:line-through;' : ''}" onclick="editNextStep('${p.id}',${i},this)" title="Click to edit">${text}</span>
              ${statusBadge}
              ${showDoIt ? `<button onclick="queueStep('${p.id}',${i})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;" title="Send to K-2">‚ñ∂ Do it</button>` : ''}
              ${showAccept ? `
                <button onclick="acceptStep('${p.id}',${i})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;" title="Accept">üëç</button>
                <button onclick="rejectStep('${p.id}',${i})" style="background:var(--red);border:none;border-radius:6px;color:#fff;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;" title="Reject">üëé</button>
              ` : ''}
              <button onclick="deleteStep('${p.id}',${i})" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:12px;padding:4px;" title="Delete">‚úï</button>
            </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : `
      <div style="margin-bottom:16px;">
        <button onclick="addNextStep('${p.id}')" style="width:100%;padding:10px;background:var(--surface2);border:1px dashed var(--border);border-radius:8px;color:var(--accent);font-size:12px;cursor:pointer;">+ Add First Step</button>
      </div>
    `}

    ${tasks.length ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Tasks (${tasks.filter(t=>!t.done).length}/${tasks.length})</div>
        <div style="max-height:120px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:8px;">
          ${tasks.map(t => `
            <div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;cursor:pointer;" onclick="openTaskModal(${safeId(t.id)})">
              <div class="task-check ${t.done ? 'done' : ''}" style="width:16px;height:16px;margin-top:0;"></div>
              <span style="flex:1;${t.done ? 'text-decoration:line-through;color:var(--text-dim);' : ''}">${t.text}</span>
              <span class="task-priority priority-${t.priority}" style="font-size:9px;padding:1px 4px;">${t.priority}</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    ${(p.notes||[]).length ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Notes</div>
        <div style="background:var(--surface2);border-radius:8px;padding:12px;max-height:100px;overflow-y:auto;">
          ${(p.notes||[]).map(n => `
            <div style="font-size:12px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border);">
              <div style="color:var(--text-dim);font-size:10px;margin-bottom:2px;">${n.date} ¬∑ ${n.author}</div>
              <div class="md-content">${renderMarkdown(n.text)}</div>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);display:flex;gap:8px;">
      <button onclick="archiveProject('${p.id}')" style="flex:1;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;">Archive</button>
      <button onclick="deleteProject('${p.id}')" style="flex:1;padding:8px 12px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:12px;cursor:pointer;">Delete</button>
    </div>
  `;

  document.getElementById('project-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeProjectModal() {
  document.getElementById('project-modal').style.display = 'none';
  document.body.style.overflow = '';
}

async function changeProjectStatus(projectId, newStatus) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  project.status = newStatus;
  await saveData();
  renderProjects();
  closeProjectModal();
}

async function archiveProject(projectId) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  if (!confirm(`Archive "${project.name}"? You can restore it later from the archive.`)) return;
  project.status = 'archived';
  project.archivedAt = new Date().toISOString();
  await saveData();
  renderProjects();
  closeProjectModal();
}

async function deleteProject(projectId) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  if (!confirm(`Permanently delete "${project.name}"? This cannot be undone.`)) return;
  DATA.projects = DATA.projects.filter(p => p.id !== projectId);
  // Also remove associated tasks
  DATA.tasks = (DATA.tasks || []).filter(t => t.project !== projectId);
  await saveData();
  renderProjects();
  renderTasks();
  closeProjectModal();
}

async function restoreProject(projectId) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  project.status = 'active';
  delete project.archivedAt;
  await saveData();
  renderProjects();
}

// Drag and drop for Kanban
let draggedProjectId = null;

function onDragStart(event, projectId) {
  draggedProjectId = projectId;
  event.target.classList.add('dragging');
}

function onDragEnd(event) {
  event.target.classList.remove('dragging');
  draggedProjectId = null;
}

function onDragOver(event) {
  event.preventDefault();
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.add('over');
}

function onDragLeave(event) {
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.remove('over');
}

async function onDrop(event, newStatus) {
  event.preventDefault();
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.remove('over');
  
  if (!draggedProjectId) return;
  
  const project = DATA.projects.find(p => p.id === draggedProjectId);
  if (!project || project.status === newStatus) return;
  
  project.status = newStatus;
  await saveData();
  renderProjects();
}

// Render Tasks
function renderTasks() {
  const taskContainer = document.getElementById('task-list');
  if (!taskContainer) return;

  const activeFilter = document.querySelector('.filter-btn.active[data-group="tasks"]')?.dataset.filter || 'my';
  let filteredTasks = DATA.tasks;
  
  console.log('renderTasks() called:', {
    totalTasks: DATA.tasks.length,
    activeFilter: activeFilter,
    recentTasks: DATA.tasks.slice(-3).map(t => ({id: t.id, text: t.text.substring(0, 30), owner: t.owner, done: t.done}))
  });

  if (activeFilter === 'my') {
    filteredTasks = DATA.tasks.filter(t => {
      const notDone = (!t.done && t.status !== 'done');
      const isMyTask = (t.owner === 'ryan' || !t.owner);
      const passes = notDone && isMyTask;
      if (!passes && (t.id > 1771000000000)) { // Debug recent tasks
        console.log('Task filtered out:', {
          id: t.id, 
          text: t.text.substring(0, 30), 
          done: t.done, 
          status: t.status, 
          owner: t.owner,
          notDone: notDone,
          isMyTask: isMyTask
        });
      }
      return passes;
    });
  } else if (activeFilter === 'k2') {
    filteredTasks = DATA.tasks.filter(t => (!t.done && t.status !== 'done') && t.owner === 'k2');
  } else if (activeFilter === 'done') {
    filteredTasks = DATA.tasks.filter(t => t.done || t.status === 'done');
  }
  
  console.log('Filtered tasks:', {
    filter: activeFilter,
    beforeFiltering: DATA.tasks.length,
    afterFiltering: filteredTasks.length
  });

  taskContainer.innerHTML = filteredTasks.map(task => {
    const project = DATA.projects.find(p => p.id === task.project);
    const projectName = project ? project.name : 'General';

    const taskText = task.text || task.title || 'Untitled';
    const taskId = typeof task.id === 'string' ? "'" + task.id.replace(/'/g,"\\'") + "'" : task.id;
    const isK2 = task.owner === 'k2';
    const ownerBadge = isK2 ? 'ü§ñ' : 'üë§';
    const k2Status = task.k2Status || 'pending';
    const k2StatusConfig = { pending: { icon: '‚è≥', label: 'Pending', color: 'var(--text-dim)' }, 'in-progress': { icon: 'üî®', label: 'In Progress', color: 'var(--orange)' }, review: { icon: 'üëÄ', label: 'Review', color: 'var(--yellow)' }, done: { icon: '‚úÖ', label: 'Done', color: 'var(--green)' } };
    const statusInfo = k2StatusConfig[k2Status] || k2StatusConfig.pending;

    // K-2 tasks: status indicator + Do it (only pending) + review actions
    // Ryan tasks: normal checkbox
    let leftEl, actionBtns = '';
    if (isK2) {
      leftEl = `<span style="font-size:16px;flex-shrink:0;margin-top:1px;" title="${statusInfo.label}">${statusInfo.icon}</span>`;
      if (k2Status === 'pending' && !task.done) {
        actionBtns = `<button onclick="event.stopPropagation();queueTaskForK2(${taskId})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 10px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;margin-right:8px;" title="Queue for K-2">‚ñ∂ Do it</button>`;
      } else if (k2Status === 'review') {
        actionBtns = `
          <button onclick="event.stopPropagation();acceptK2Task(${taskId})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;margin-right:4px;" title="Accept">üëç</button>
          <button onclick="event.stopPropagation();reworkK2Task(${taskId})" style="background:var(--red);border:none;border-radius:6px;color:#fff;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;margin-right:8px;" title="Rework">üëé</button>`;
      }
    } else {
      leftEl = `<div class="task-check ${task.done ? 'done' : ''}" onclick="event.stopPropagation();toggleTask(${taskId})"></div>`;
    }

    return `
      <li class="task-item" onclick="openTaskModal(${taskId})">
        ${leftEl}
        <div class="task-content ${task.done ? 'done' : ''}">
          <div style="display:flex;align-items:center;gap:6px;">
            <span title="${isK2 ? 'K-2' : 'Ryan'}">${ownerBadge}</span>
            <span>${taskText}</span>
            ${isK2 ? `<span style="font-size:10px;padding:1px 6px;border-radius:4px;font-weight:600;color:${statusInfo.color};background:color-mix(in srgb, ${statusInfo.color} 15%, transparent);">${statusInfo.label}</span>` : ''}
          </div>
          ${task.context ? `<div style="font-size:11px;color:var(--text-dim);margin-top:2px;font-style:italic;opacity:0.8;">${task.context}</div>` : ''}
          <div class="task-meta">
            ${projectName} ‚Ä¢ ${task.created}${task.source === 'jot' ? ' ‚Ä¢ üìù from jot' : ''}
          </div>
        </div>
        ${actionBtns}
        <div class="task-priority priority-${task.priority}">${task.priority}</div>
      </li>
    `;
  }).join('');

  // Update badge counts
  const pendingCount = DATA.tasks.filter(t => !t.done).length;
  const badge = document.getElementById('task-count');
  if (badge) {
    badge.textContent = pendingCount;
    badge.style.display = pendingCount > 0 ? 'inline' : 'none';
  }

  // Populate project dropdown
  const projectSelect = document.getElementById('new-task-project');
  if (projectSelect) {
    projectSelect.innerHTML = '<option value="">No Project</option>' +
      DATA.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  }
}

async function addTask() {
  const input = document.getElementById('new-task-input');
  const priority = document.getElementById('new-task-priority').value;
  const project = document.getElementById('new-task-project').value;

  const text = input.value.trim();
  if (!text) return;

  const newTask = {
    id: Date.now(),
    text: text,
    priority: priority,
    project: project,
    owner: 'ryan',
    done: false,
    created: (function(){var d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")})(),
    messages: []
  };

  DATA.tasks.push(newTask);
  input.value = '';

  await saveData();
  renderTasks();
}

async function toggleTask(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;

  task.done = !task.done;

  // Sync linked jot
  if (task.linkedJotId) {
    const jot = DATA.jots.find(j => j.id === task.linkedJotId);
    if (jot) jot.done = task.done;
  }

  await saveData();
  renderTasks();
  renderJots();
}

async function queueTaskForK2(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const taskText = task.text || task.title || '';
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'execute-task',
    taskId: task.id,
    taskText: taskText,
    status: 'pending',
    created: new Date().toISOString()
  });
  if (!task.activity) task.activity = [];
  task.activity.push({ action: 'queued', detail: 'Task queued for K-2 execution', date: new Date().toISOString() });
  await saveData();
  showToast('üöÄ Queued for K-2');
  renderTasks();
  if (activeTaskId) openTaskModal(activeTaskId);
}

async function acceptK2Task(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  task.k2Status = 'done';
  task.done = true;
  if (!task.activity) task.activity = [];
  task.activity.push({ action: 'accepted', detail: 'Ryan accepted the completed work', date: new Date().toISOString() });
  await saveData();
  showToast('üëç Task accepted');
  renderTasks();
  if (activeTaskId) openTaskModal(activeTaskId);
}

async function reworkK2Task(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const feedback = prompt('What needs to change?');
  if (feedback === null) return;
  task.k2Status = 'pending';
  if (!task.activity) task.activity = [];
  task.activity.push({ action: 'rework', detail: feedback, date: new Date().toISOString() });
  // Queue rework command for K-2
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'rework-task',
    taskId: task.id,
    taskText: task.text || task.title || '',
    feedback: feedback,
    status: 'pending',
    created: new Date().toISOString()
  });
  await saveData();
  showToast('üëé Sent back for rework');
  renderTasks();
  if (activeTaskId) openTaskModal(activeTaskId);
}

async function cycleTaskOwner(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  task.owner = task.owner === 'k2' ? 'ryan' : 'k2';
  await saveData();
  renderTasks();
  openTaskModal(taskId);
}

async function cycleTaskPriority(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const cycle = { high: 'medium', medium: 'low', low: 'high' };
  task.priority = cycle[task.priority] || 'high';
  await saveData();
  renderTasks();
  openTaskModal(taskId);
}

async function editTaskField(taskId, field, el) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const currentVal = task[field] || '';
  const isTitle = field === 'text';

  const input = document.createElement(isTitle ? 'input' : 'textarea');
  if (isTitle) input.type = 'text';
  input.value = currentVal;
  input.style.cssText = `width:100%;background:var(--surface2);border:1px solid var(--accent);border-radius:8px;color:var(--text);padding:8px 10px;font-size:${isTitle ? '16px;font-weight:700' : '12px'};font-family:inherit;${isTitle ? '' : 'min-height:50px;resize:vertical;'}outline:none;`;

  const save = async () => {
    const newVal = input.value.trim();
    if (newVal !== currentVal) {
      task[field] = newVal;
      if (field === 'text' && task.title) task.title = newVal;
      await saveData();
    }
    openTaskModal(taskId);
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (isTitle || e.metaKey || e.ctrlKey)) { e.preventDefault(); save(); }
    if (e.key === 'Escape') openTaskModal(taskId);
  });
  input.addEventListener('blur', save);

  el.replaceWith(input);
  input.focus();
}

// Setup task filters
document.querySelectorAll('.filter-btn[data-group="tasks"]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn[data-group="tasks"]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTasks();
  });
});

// Render Discussions
function renderDiscussions() {
  const container = document.getElementById('discussions-list');
  if (!container) return;

  container.innerHTML = DATA.discussions.map(discussion => `
    <div class="thread">
      <div class="thread-header" onclick="toggleThread(this)">
        <span class="thread-toggle">‚ñ∂</span>
        <span class="thread-title">${discussion.title}</span>
        <span class="thread-date">${discussion.date}</span>
      </div>
      <div class="thread-body">
        <p style="margin-bottom:12px;">${discussion.summary}</p>
        
        ${discussion.keyPoints && discussion.keyPoints.length ? `
          <div style="margin-bottom:12px;">
            <strong style="font-size:12px;color:var(--text);margin-bottom:4px;display:block;">Key Points:</strong>
            <ul style="margin-left:16px;">
              ${discussion.keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${discussion.openQuestions && discussion.openQuestions.length ? `
          <div style="margin-bottom:12px;">
            <strong style="font-size:12px;color:var(--orange);margin-bottom:4px;display:block;">Open Questions:</strong>
            <ul style="margin-left:16px;">
              ${discussion.openQuestions.map(q => `<li style="color:var(--orange);">${q}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${discussion.project ? `
          <div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border);">
            <span class="tag tag-blue">${DATA.projects.find(p => p.id === discussion.project)?.name || 'Unknown Project'}</span>
          </div>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function toggleThread(element) {
  const thread = element.closest('.thread');
  thread.classList.toggle('open');
}

// Render Decisions
function renderDecisions() {
  const container = document.getElementById('decisions-timeline');
  if (!container) return;

  const sortedDecisions = [...DATA.decisions].sort((a, b) => b.date.localeCompare(a.date));

  container.innerHTML = sortedDecisions.map(decision => `
    <div class="timeline-item">
      <div class="timeline-date">${decision.date}</div>
      <div class="timeline-content">
        <div style="font-weight:600;margin-bottom:4px;">${decision.decision}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;">${decision.rationale}</div>
        ${decision.project ? `<span class="tag tag-blue">${DATA.projects.find(p => p.id === decision.project)?.name || 'Unknown Project'}</span>` : ''}
      </div>
    </div>
  `).join('');
}

// Render Notes
let activeNoteId = null;
let noteAutoSaveTimer = null;

function renderNotes() {
  const container = document.getElementById('notes-list');
  if (!container) return;

  const sortedNotes = [...DATA.notes].sort((a, b) => b.created.localeCompare(a.created));

  if (sortedNotes.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:40px;font-size:14px;">No notes yet. Create one to get started.</div>';
  } else {
    container.innerHTML = sortedNotes.map(note => {
      const noteId = note.id;
      const hasResponse = note.k2Response;
      const isPending = note.k2Status === 'pending';
      const title = note.title || note.text.split('\n')[0].slice(0, 60) || 'Untitled';
      const projectLabel = note.projectId ? (DATA.projects.find(p => p.id === note.projectId)||{}).name || '' : '';

      return `
        <div class="card note-card" data-note-id="${noteId}">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
            <input type="text" class="note-title-inline" value="${title}" 
                   style="background:none;border:none;font-size:14px;font-weight:600;color:var(--text);flex:1;outline:none;cursor:pointer;"
                   onchange="updateNoteTitle('${noteId}', this.value)"
                   onclick="event.stopPropagation()"
                   ondblclick="openNoteEditor('${noteId}'); event.stopPropagation();">
            <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;margin-left:12px;">
              <span style="font-size:10px;color:var(--text-dim);">${note.created}</span>
              ${projectLabel ? '<span class="tag tag-blue" style="font-size:9px;">' + projectLabel + '</span>' : ''}
              ${isPending ? '<span style="font-size:10px;color:var(--yellow);">‚è≥</span>' : ''}
              ${hasResponse ? '<span style="font-size:10px;color:var(--accent);">ü§ñ</span>' : ''}
              <button onclick="openNoteEditor('${noteId}'); event.stopPropagation();" 
                      style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:12px;padding:2px;" title="Expand">‚§¢</button>
              <button onclick="requestK2TakeFromNote('${noteId}'); event.stopPropagation();" 
                      style="background:none;border:none;color:var(--accent);cursor:pointer;font-size:12px;padding:2px;">ü§ñ</button>
              <button onclick="deleteNote('${noteId}'); event.stopPropagation();" 
                      style="background:none;border:none;color:var(--red);cursor:pointer;font-size:12px;padding:2px;">üóë</button>
            </div>
          </div>
          <div class="note-editor-inline" id="note-editor-${noteId}" 
               style="min-height:100px;border:1px solid var(--border);border-radius:8px;padding:12px;position:relative;">
            <div onclick="openNoteEditor('${noteId}')" 
                 style="position:absolute;top:-4px;right:8px;color:var(--text-dim);cursor:pointer;font-size:12px;opacity:0.7;z-index:10;" 
                 title="Double-click title or click here to expand">‚§¢ Expand</div>
          </div>
          ${hasResponse ? `
            <div style="margin-top:12px;padding:12px;background:rgba(74,158,255,0.08);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;">
              <div style="font-size:12px;color:var(--accent);font-weight:600;margin-bottom:4px;">ü§ñ K-2's Take</div>
              <div class="md-content" style="font-size:13px;color:var(--text);line-height:1.6;">${renderMarkdown(note.k2Response)}</div>
            </div>
          ` : ''}
        </div>
      `;
    }).join('');

    // Initialize inline editors for all notes
    sortedNotes.forEach(note => {
      // Try to initialize immediately
      initNoteInlineEditor(note.id);
      
      // If TipTap isn't ready, retry after a short delay
      if (!window.Editor || !window.StarterKit) {
        setTimeout(() => {
          console.log('Retrying TipTap initialization for note:', note.id);
          initNoteInlineEditor(note.id);
        }, 500);
      }
    });
  }
}

function openNoteEditor(noteId) {
  let note;
  if (noteId) {
    note = DATA.notes.find(n => n.id === noteId);
    if (!note) return;
  } else {
    const now = new Date();
    const dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + now.toTimeString().slice(0,5);
    note = { id: 'note-' + Date.now(), title: '', text: '', created: dateStr };
    DATA.notes.push(note);
  }
  activeNoteId = note.id;

  // Show editor, hide list
  document.getElementById('note-editor-view').style.display = 'block';
  document.querySelector('#page-notes > .page-header').style.display = 'none';
  document.getElementById('notes-list').style.display = 'none';

  // Populate
  document.getElementById('note-title-input').value = note.title || '';
  
  // Initialize TipTap editor for full-screen mode
  initFullScreenEditor(note.id, note.text || '');

  // Project dropdown
  const sel = document.getElementById('note-project-link');
  sel.innerHTML = '<option value="">No project</option>' + DATA.projects.map(p => '<option value="' + p.id + '"' + (note.projectId === p.id ? ' selected' : '') + '>' + p.name + '</option>').join('');

  // K-2 response
  const k2Block = document.getElementById('note-k2-response');
  if (note.k2Response) {
    k2Block.style.display = 'block';
    document.getElementById('note-k2-text').innerHTML = renderMarkdown(note.k2Response);
    document.getElementById('note-k2-date').textContent = note.k2RespondedAt || '';
    document.getElementById('note-k2-btn').textContent = 'ü§ñ Get Fresh Take';
  } else {
    k2Block.style.display = 'none';
    document.getElementById('note-k2-btn').textContent = 'ü§ñ Get K-2\'s Take';
  }

  // Auto-save on typing
  const titleInput = document.getElementById('note-title-input');
  const statusEl = document.getElementById('note-save-status');

  const autoSave = () => {
    clearTimeout(noteAutoSaveTimer);
    statusEl.textContent = 'Saving...';
    noteAutoSaveTimer = setTimeout(async () => {
      note.title = titleInput.value.trim();
      
      // Get content from TipTap editor or fallback textarea
      if (fullScreenEditor) {
        const html = fullScreenEditor.getHTML();
        note.text = convertHTMLToText(html);
      } else {
        // Fallback: try to get from textarea
        const textarea = document.querySelector('#note-body-input textarea');
        if (textarea) {
          note.text = textarea.value.trim();
        }
      }
      
      // Extract and create tasks from note content
      const taskCount = extractAndCreateTasks(note.text, note.projectId);
      if (taskCount > 0) {
        console.log(`Created ${taskCount} tasks from note:`, note.id);
        showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
        renderTasks(); // Refresh tasks view
      }
      
      await saveData();
      statusEl.textContent = 'Saved ‚úì';
    }, 1500);
  };

  titleInput.oninput = autoSave;
  
  // TipTap editor handles its own auto-save via onUpdate callback
  // No need to set up bodyInput.oninput since it's now a TipTap editor

  // Link callback for notes ‚Äî links project to the note
  bodyInput._richOnLink = (item) => {
    if (item.type === 'project') {
      note.projectId = item.id;
      document.getElementById('note-project-link').value = item.id;
    }
  };

  // Cmd+S to force save, also extract tasks from [] syntax
  // TipTap editor handles its own keyboard events
  // Removed bodyInput.onkeydown since body is now a TipTap editor
  titleInput.onkeydown = (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 's') {
      e.preventDefault();
      clearTimeout(noteAutoSaveTimer);
      note.title = titleInput.value.trim();
      
      // Get content from TipTap editor or fallback textarea
      if (fullScreenEditor) {
        const html = fullScreenEditor.getHTML();
        note.text = convertHTMLToText(html);
      } else {
        // Fallback: try to get from textarea
        const textarea = document.querySelector('#note-body-input textarea');
        if (textarea) {
          note.text = textarea.value.trim();
        }
      }
      
      // Extract and create tasks from note content
      const taskCount = extractAndCreateTasks(note.text, note.projectId);
      if (taskCount > 0) {
        showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
        renderTasks(); // Refresh tasks view
      }
      
      saveData().then(() => { statusEl.textContent = 'Saved ‚úì'; });
    }
  };

  // Focus the editor after a brief delay to ensure it's fully initialized
  setTimeout(() => {
    if (fullScreenEditor) {
      fullScreenEditor.commands.focus('end');
    }
  }, 100);
  
  // Debug logging
  console.log('Opening note editor for:', note.id);
  console.log('Note title:', note.title);
  console.log('Note text:', note.text);
}

async function closeNoteEditor() {
  if (activeNoteId) {
    const note = DATA.notes.find(n => n.id === activeNoteId);
    if (note) {
      clearTimeout(noteAutoSaveTimer);
      note.title = document.getElementById('note-title-input').value.trim();
      
      // Get content from TipTap editor or fallback textarea
      if (fullScreenEditor) {
        const html = fullScreenEditor.getHTML();
        note.text = convertHTMLToText(html);
      } else {
        // Fallback: try to get from textarea
        const textarea = document.querySelector('#note-body-input textarea');
        if (textarea) {
          note.text = textarea.value.trim();
        } else {
          note.text = document.getElementById('note-body-input').textContent || '';
        }
      }
      
      // Extract and create tasks from note content
      if (note.text) {
        const taskCount = extractAndCreateTasks(note.text, note.projectId);
        if (taskCount > 0) {
          console.log(`Created ${taskCount} tasks from note when closing editor:`, note.id);
          showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
        }
      }
      
      // Remove empty untitled notes
      if (!note.title && !note.text) {
        DATA.notes = DATA.notes.filter(n => n.id !== activeNoteId);
      }
      await saveData();
    }
    
    // Clean up full-screen editor
    if (fullScreenEditor) {
      fullScreenEditor.destroy();
      fullScreenEditor = null;
    }
  }
  activeNoteId = null;
  document.getElementById('note-editor-view').style.display = 'none';
  document.querySelector('#page-notes > .page-header').style.display = '';
  document.getElementById('notes-list').style.display = '';
  
  // Destroy existing inline editors to force refresh with updated content
  if (window._noteEditors) {
    Object.values(window._noteEditors).forEach(editorData => {
      if (editorData.editor && editorData.editor.destroy) {
        editorData.editor.destroy();
      }
    });
    window._noteEditors = {};
  }
  
  renderNotes();
}

async function linkNoteToProject() {
  const note = DATA.notes.find(n => n.id === activeNoteId);
  if (!note) return;
  note.projectId = document.getElementById('note-project-link').value || undefined;
  await saveData();
  document.getElementById('note-save-status').textContent = 'Saved ‚úì';
}

async function deleteCurrentNote() {
  if (!activeNoteId) return;
  if (!confirm('Delete this note?')) return;
  DATA.notes = DATA.notes.filter(n => n.id !== activeNoteId);
  await saveData();
  activeNoteId = null;
  closeNoteEditor();
}

async function requestK2TakeFromEditor() {
  const note = DATA.notes.find(n => n.id === activeNoteId);
  if (!note) return;
  // Save current text first
  note.title = document.getElementById('note-title-input').value.trim();
  note.text = document.getElementById('note-body-input').value.trim();
  note.k2Status = 'pending';
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'analyze-note',
    noteId: note.id,
    noteText: (note.title ? note.title + '\n\n' : '') + note.text,
    status: 'pending',
    created: new Date().toISOString()
  });
  await saveData();
  document.getElementById('note-k2-btn').textContent = '‚è≥ K-2 thinking...';
  document.getElementById('note-k2-btn').disabled = true;
}

// Inline note editing functions
if (!window._noteEditors) {
  window._noteEditors = {};
}

// Full-screen editor instance
let fullScreenEditor = null;

function initNoteInlineEditor(noteId) {
  // Clean up existing editor first
  if (window._noteEditors && window._noteEditors[noteId]) {
    if (window._noteEditors[noteId].editor && window._noteEditors[noteId].editor.destroy) {
      window._noteEditors[noteId].editor.destroy();
    }
    delete window._noteEditors[noteId];
  }

  const note = DATA.notes.find(n => n.id === noteId);
  if (!note) {
    console.warn('Note not found for inline editor:', noteId);
    return;
  }

  const container = document.getElementById(`note-editor-${noteId}`);
  if (!container) {
    console.warn('Container not found for note editor:', noteId);
    return;
  }
  
  // Clear container
  container.innerHTML = '';
  
  console.log('Initializing inline editor for note:', noteId, note);

  // Import TipTap if available, otherwise use simple textarea  
  if (window.Editor && window.StarterKit && window.TaskList && window.TaskItem) {
    console.log('Creating TipTap editor for note:', noteId, 'with content:', note.text);
    const htmlContent = convertTextToHTML(note.text || '');
    console.log('Converted HTML content:', htmlContent);
    
    const editor = new window.Editor({
      element: container,
      extensions: [
        window.StarterKit,
        window.TaskList.configure({ nested: true }),
        window.TaskItem.configure({ nested: true })
      ],
      content: htmlContent,
      onUpdate: ({ editor }) => {
        clearTimeout(window._noteEditors[noteId].saveTimer);
        window._noteEditors[noteId].saveTimer = setTimeout(async () => {
          const updatedNote = DATA.notes.find(n => n.id === noteId);
          if (updatedNote) {
            // Convert HTML back to markdown-like plain text for storage
            const html = editor.getHTML();
            const plainText = convertHTMLToText(html);
            updatedNote.text = plainText;
            
            // Extract and create tasks from note content
            const taskCount = extractAndCreateTasks(plainText, updatedNote.projectId);
            if (taskCount > 0) {
              console.log(`Created ${taskCount} tasks from note:`, noteId);
              showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
              renderTasks(); // Refresh tasks view if it's visible
            }
            
            await saveData();
            console.log('Saved note content via inline editor:', noteId);
          }
        }, 1500);
      },
      editorProps: {
        attributes: {
          style: 'outline: none; min-height: 80px; padding: 8px;'
        }
      }
    });

    window._noteEditors[noteId] = { editor, saveTimer: null };
    console.log('TipTap editor created for note:', noteId);
  } else {
    // Fallback to textarea - also check why TipTap failed
    console.log('Using textarea fallback for note:', noteId);
    console.log('TipTap availability check:', {
      Editor: !!window.Editor,
      StarterKit: !!window.StarterKit,
      TaskList: !!window.TaskList,
      TaskItem: !!window.TaskItem
    });
    
    const textContent = note.text || '';
    
    container.innerHTML = `<div style="padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:4px;">
      <div style="font-size:11px;color:var(--text-dim);margin-bottom:8px;">Rich editor loading... Using plain text fallback.</div>
      <textarea style="width:100%;height:80px;background:none;border:none;color:var(--text);outline:none;resize:vertical;font-family:inherit;" onchange="updateNoteText('${noteId}', this.value)" placeholder="Start writing...">${textContent}</textarea>
    </div>`;
  }
}

async function updateNoteTitle(noteId, newTitle) {
  const note = DATA.notes.find(n => n.id === noteId);
  if (!note) return;
  note.title = newTitle.trim();
  await saveData();
}

async function updateNoteText(noteId, newText) {
  const note = DATA.notes.find(n => n.id === noteId);
  if (!note) return;
  note.text = newText.trim();
  
  // Extract and create tasks from note content
  const taskCount = extractAndCreateTasks(note.text, note.projectId);
  if (taskCount > 0) {
    console.log(`Created ${taskCount} tasks from note via textarea:`, noteId);
    showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
    renderTasks(); // Refresh tasks view
  }
  
  await saveData();
  console.log('Updated note text via textarea fallback:', noteId);
}

// Debug function to check editor status
function debugNoteEditors() {
  console.log('Active note editors:', window._noteEditors);
  console.log('TipTap available:', !!window.Editor);
  console.log('StarterKit available:', !!window.StarterKit);
}

// Convert plain text to basic HTML for TipTap display (safe conversion)
function convertTextToHTML(text) {
  if (!text || text.trim() === '') return '<p></p>';
  
  // If it's already HTML, return as-is
  if (text.includes('<') && text.includes('>')) {
    return text;
  }
  
  // Split into lines for processing
  const lines = text.split('\n');
  const result = [];
  let i = 0;
  
  while (i < lines.length) {
    const line = lines[i].trim();
    
    // Skip empty lines
    if (line === '') {
      i++;
      continue;
    }
    
    // Handle headers (# ## ###)
    if (line.match(/^#{1,6}\s+/)) {
      const level = line.match(/^#+/)[0].length;
      const text = line.replace(/^#+\s+/, '');
      result.push(`<h${level}>${text}</h${level}>`);
      i++;
      continue;
    }
    
    // Handle task items ([] or [x])
    if (line.match(/^\s*\[\s*\]\s+/) || line.match(/^\s*\[x\]\s+/i)) {
      const checked = line.match(/^\s*\[x\]\s+/i) ? 'true' : 'false';
      const checkboxHtml = checked === 'true' ? '<input type="checkbox" checked>' : '<input type="checkbox">';
      const taskText = line.replace(/^\s*\[[x\s]*\]\s+/i, '');
      result.push(`<ul data-type="taskList"><li data-type="taskItem" data-checked="${checked}"><label>${checkboxHtml}</label><div><p>${taskText}</p></div></li></ul>`);
      i++;
      continue;
    }
    
    // Handle bullet points (- or *)
    if (line.match(/^\s*[-*]\s+/)) {
      const bulletText = line.replace(/^\s*[-*]\s+/, '');
      
      // Collect consecutive bullet points
      const bulletItems = [bulletText];
      i++;
      while (i < lines.length && lines[i].trim().match(/^\s*[-*]\s+/)) {
        bulletItems.push(lines[i].trim().replace(/^\s*[-*]\s+/, ''));
        i++;
      }
      
      // Create bullet list
      const listItems = bulletItems.map(item => `<li><p>${item}</p></li>`).join('');
      result.push(`<ul>${listItems}</ul>`);
      continue;
    }
    
    // Handle numbered lists (1. 2. etc.)
    if (line.match(/^\s*\d+\.\s+/)) {
      const numberText = line.replace(/^\s*\d+\.\s+/, '');
      
      // Collect consecutive numbered items
      const numberItems = [numberText];
      i++;
      while (i < lines.length && lines[i].trim().match(/^\s*\d+\.\s+/)) {
        numberItems.push(lines[i].trim().replace(/^\s*\d+\.\s+/, ''));
        i++;
      }
      
      // Create numbered list
      const listItems = numberItems.map(item => `<li><p>${item}</p></li>`).join('');
      result.push(`<ol>${listItems}</ol>`);
      continue;
    }
    
    // Regular paragraph
    result.push(`<p>${line}</p>`);
    i++;
  }
  
  return result.length > 0 ? result.join('') : '<p></p>';
}

// Convert HTML back to plain text with markdown-like formatting
function convertHTMLToText(html) {
  if (!html || html.trim() === '' || html === '<p></p>') return '';
  
  const tempDiv = document.createElement('div');
  tempDiv.innerHTML = html;
  
  let result = [];
  
  // Process each top-level element
  Array.from(tempDiv.children).forEach(element => {
    const tagName = element.tagName.toLowerCase();
    
    switch (tagName) {
      case 'h1':
        result.push(`# ${element.textContent}`);
        break;
      case 'h2':
        result.push(`## ${element.textContent}`);
        break;
      case 'h3':
        result.push(`### ${element.textContent}`);
        break;
      case 'h4':
        result.push(`#### ${element.textContent}`);
        break;
      case 'h5':
        result.push(`##### ${element.textContent}`);
        break;
      case 'h6':
        result.push(`###### ${element.textContent}`);
        break;
      case 'ul':
        if (element.hasAttribute('data-type') && element.getAttribute('data-type') === 'taskList') {
          // Task list
          Array.from(element.children).forEach(li => {
            const isChecked = li.getAttribute('data-checked') === 'true';
            const checkbox = isChecked ? '[x]' : '[]';
            const text = li.textContent || '';
            result.push(`${checkbox} ${text}`);
          });
        } else {
          // Regular bullet list
          Array.from(element.children).forEach(li => {
            result.push(`- ${li.textContent || ''}`);
          });
        }
        break;
      case 'ol':
        // Numbered list
        Array.from(element.children).forEach((li, index) => {
          result.push(`${index + 1}. ${li.textContent || ''}`);
        });
        break;
      case 'p':
        const paragraphText = element.textContent || '';
        if (paragraphText.trim() !== '') {
          result.push(paragraphText);
        }
        break;
      default:
        const defaultText = element.textContent || '';
        if (defaultText.trim() !== '') {
          result.push(defaultText);
        }
    }
  });
  
  return result.join('\n');
}

// Initialize full-screen TipTap editor
function initFullScreenEditor(noteId, content) {
  const container = document.getElementById('note-body-input');
  if (!container) {
    console.error('Full-screen editor container not found');
    return;
  }
  
  // Destroy existing editor if any
  if (fullScreenEditor) {
    fullScreenEditor.destroy();
    fullScreenEditor = null;
  }
  
  // Clear container
  container.innerHTML = '';
  
  if (window.Editor && window.StarterKit && window.TaskList && window.TaskItem) {
    console.log('Creating full-screen TipTap editor for note:', noteId);
    const htmlContent = convertTextToHTML(content);
    console.log('Full-screen editor content:', htmlContent);
    
    fullScreenEditor = new window.Editor({
      element: container,
      extensions: [
        window.StarterKit,
        window.TaskList.configure({ nested: true }),
        window.TaskItem.configure({ nested: true })
      ],
      content: htmlContent,
      onUpdate: ({ editor }) => {
        clearTimeout(noteAutoSaveTimer);
        const statusEl = document.getElementById('note-save-status');
        if (statusEl) statusEl.textContent = 'Saving...';
        
        noteAutoSaveTimer = setTimeout(async () => {
          const updatedNote = DATA.notes.find(n => n.id === noteId);
          if (updatedNote) {
            const html = editor.getHTML();
            const plainText = convertHTMLToText(html);
            updatedNote.text = plainText;
            
            // Extract and create tasks from note content
            const taskCount = extractAndCreateTasks(plainText, updatedNote.projectId);
            if (taskCount > 0) {
              console.log(`Created ${taskCount} tasks from note:`, noteId);
              showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from note`);
            }
            
            await saveData();
            if (statusEl) statusEl.textContent = 'Saved ‚úì';
            console.log('Auto-saved full-screen note:', noteId);
          }
        }, 1500);
      },
      editorProps: {
        attributes: {
          style: 'outline: none; min-height: 40vh; padding: 16px; font-size: 15px; line-height: 1.8;'
        }
      }
    });
    
    console.log('Full-screen TipTap editor created');
    
    // Focus the editor
    setTimeout(() => {
      fullScreenEditor.commands.focus('end');
    }, 100);
  } else {
    console.warn('TipTap not available for full-screen editor, using fallback');
    container.innerHTML = `<textarea placeholder="Start writing... (Rich editor loading...)" style="width:100%;min-height:40vh;padding:16px;background:none;border:none;color:var(--text);font-size:15px;line-height:1.8;resize:none;outline:none;font-family:inherit;">${content}</textarea>`;
  }
}

async function deleteNote(noteId) {
  if (!confirm('Delete this note?')) return;
  DATA.notes = DATA.notes.filter(n => n.id !== noteId);
  if (window._noteEditors[noteId]) {
    if (window._noteEditors[noteId].editor) {
      window._noteEditors[noteId].editor.destroy();
    }
    delete window._noteEditors[noteId];
  }
  await saveData();
  renderNotes();
}

async function requestK2TakeFromNote(noteId) {
  const note = DATA.notes.find(n => n.id === noteId);
  if (!note) return;
  
  // Get current text from editor
  if (window._noteEditors[noteId] && window._noteEditors[noteId].editor) {
    note.text = window._noteEditors[noteId].editor.getHTML();
  }
  
  note.k2Status = 'pending';
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'analyze-note',
    noteId: note.id,
    noteText: (note.title ? note.title + '\n\n' : '') + note.text,
    status: 'pending',
    created: new Date().toISOString()
  });
  await saveData();
  showToast('ü§ñ K-2 will analyze this note');
  renderNotes();
}

async function createNewNote() {
  const now = new Date();
  const dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0') + ' ' + now.toTimeString().slice(0,5);
  const note = { id: 'note-' + Date.now(), title: 'New Note', text: '<p>Start writing...</p>', created: dateStr };
  DATA.notes.push(note);
  await saveData();
  renderNotes();
  
  // Automatically open the new note in full-screen editor
  setTimeout(() => openNoteEditor(note.id), 100);
}

// Jots functionality
let dailyDocSearchQuery = '';

function filterDailyDocs() {
  dailyDocSearchQuery = (document.getElementById('jot-search')?.value || '').trim().toLowerCase();
  renderDailyDocs();
}

// ‚ïê‚ïê‚ïê Daily Docs System (TipTap Editor) ‚ïê‚ïê‚ïê
window._todayEditor = null;
window._previousEditors = {};
window._openDocDays = new Set();
window._dailyDocSaveTimer = null;

function getTodayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function getDayName(dateStr) {
  const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  return days[new Date(dateStr + 'T00:00:00').getDay()];
}

// Migration: convert old jots to dailyDocs
function migrateJotsToDailyDocs() {
  if (!DATA.jots || DATA.jots.length === 0) return;
  if (!DATA.dailyDocs) DATA.dailyDocs = {};

  // Group jots by date
  const byDate = {};
  (DATA.jots || []).forEach(j => {
    if (!byDate[j.date]) byDate[j.date] = [];
    byDate[j.date].push(j);
  });

  for (const [date, jots] of Object.entries(byDate)) {
    if (DATA.dailyDocs[date]) continue; // already migrated
    const sorted = jots.sort((a,b) => (a.order||0) - (b.order||0));
    let html = '';
    for (const jot of sorted) {
      const time = (jot.time || '').slice(-5);
      const timeSpan = time ? `<span class="jot-time-inline">${time}</span>` : '';
      
      // Build mention badges
      let mentions = '';
      if (jot.projectId) {
        const proj = (DATA.projects||[]).find(p => p.id === jot.projectId);
        if (proj) mentions += ` <span class="mention-project" data-id="${proj.id}">@${proj.name}</span>`;
      }
      if (jot.noteId) {
        const note = (DATA.notes||[]).find(n => (n.id||'') == jot.noteId);
        if (note) mentions += ` <span class="mention-note" data-id="${note.id}">#${(note.title || note.created || 'note').slice(0,20)}</span>`;
      }
      
      const text = (jot.text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      
      if (jot.done !== undefined && (text.match(/\[\s*\]/) || text.match(/\[x\]/i))) {
        // Task item
        const cleanText = text.replace(/\[\s*\]/g, '').replace(/\[x\]/gi, '').trim();
        html += `<ul data-type="taskList"><li data-type="taskItem" data-checked="${jot.done ? 'true' : 'false'}"><label><input type="checkbox" ${jot.done ? 'checked' : ''}></label><div><p>${timeSpan}${cleanText}${mentions}</p></div></li></ul>`;
      } else {
        html += `<p>${timeSpan}${text}${mentions}</p>`;
      }
    }
    
    const linkedProjects = [...new Set(sorted.filter(j => j.projectId).map(j => j.projectId))];
    const linkedNotes = [...new Set(sorted.filter(j => j.noteId).map(j => j.noteId))];
    
    // Extract tasks from migrated jots content
    const plainText = (html || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
    if (plainText) {
      const taskCount = extractAndCreateTasks(plainText, null);
      if (taskCount > 0) {
        console.log(`Created ${taskCount} tasks during jots migration for ${date}`);
      }
    }
    
    DATA.dailyDocs[date] = {
      content: html || '<p></p>',
      updatedAt: new Date().toISOString(),
      linkedProjects,
      linkedNotes
    };
  }
}

function renderJots() { renderDailyDocs(); }

function renderDailyDocs() {
  const today = getTodayStr();
  const dow = getDayName(today);
  
  const header = document.getElementById('jots-today-date');
  if (header) header.innerHTML = `${today} <span class="dow">${dow}</span>`;

  // Ensure today's doc exists
  if (!DATA.dailyDocs) DATA.dailyDocs = {};
  if (!DATA.dailyDocs[today]) {
    DATA.dailyDocs[today] = { content: '<p></p>', updatedAt: new Date().toISOString(), linkedProjects: [], linkedNotes: [] };
  }

  // Initialize today's editor (only once)
  if (!window._todayEditor) {
    initTodayEditor(today);
  } else {
    // Update content if loaded from server
    const doc = DATA.dailyDocs[today];
    if (doc && window._todayEditorDate !== today) {
      window._todayEditor.commands.setContent(doc.content || '<p></p>');
      window._todayEditorDate = today;
    }
  }

  // Render previous days
  renderPreviousDays(today);
}

function initTodayEditor(today) {
  // Will be initialized by the module script after TipTap loads
  window._todayEditorDate = today;
  window._pendingTodayInit = today;
  if (window._tiptapLoaded) {
    window._createTodayEditor(today);
  }
}

function renderPreviousDays(today) {
  const container = document.getElementById('daily-doc-previous');
  if (!container) return;

  const allDates = Object.keys(DATA.dailyDocs || {}).filter(d => d !== today).sort().reverse();
  
  // Filter by search
  const filteredDates = dailyDocSearchQuery
    ? allDates.filter(d => {
        const doc = DATA.dailyDocs[d];
        return doc && (doc.content || '').toLowerCase().includes(dailyDocSearchQuery);
      })
    : allDates;

  if (dailyDocSearchQuery && filteredDates.length === 0) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:24px;font-size:13px;">No notes matching "' + dailyDocSearchQuery + '"</div>';
    return;
  }

  // Destroy all stale previous-day editors before rebuilding DOM
  // (renderDailyDocs replaces container.innerHTML, so old editor nodes get detached)
  Object.keys(window._previousEditors || {}).forEach(date => {
    try { window._previousEditors[date].destroy(); } catch(e) {}
    delete window._previousEditors[date];
  });

  container.innerHTML = filteredDates.map(date => {
    const dow = getDayName(date);
    const doc = DATA.dailyDocs[date];
    const isOpen = dailyDocSearchQuery || window._openDocDays.has(date);
    // Get preview text (strip HTML)
    const previewText = (doc.content || '').replace(/<[^>]+>/g, '').slice(0, 80);
    
    return `
      <div class="jot-day-section">
        <div class="jot-day-header ${isOpen ? 'open' : ''}" data-date="${date}" onclick="toggleDocDay(this)">
          <span class="jot-day-toggle">${isOpen ? '‚ñº' : '‚ñ∂'}</span>
          <span>${date} ${dow}</span>
          ${!isOpen ? `<span style="color:var(--text-dim);font-size:11px;margin-left:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1;">${previewText}</span>` : ''}
        </div>
        <div class="jot-day-entries" id="doc-day-${date}" style="${isOpen ? '' : 'display:none;'}">
          <div class="daily-doc-editor readonly" id="doc-editor-${date}"></div>
        </div>
      </div>
    `;
  }).join('');

  // Initialize read-only editors for open days
  filteredDates.forEach(date => {
    if (dailyDocSearchQuery || window._openDocDays.has(date)) {
      initPreviousDayEditor(date);
    }
  });
}

function toggleDocDay(element) {
  const date = element.dataset.date;
  if (window._openDocDays.has(date)) {
    window._openDocDays.delete(date);
    element.classList.remove('open');
    // Destroy editor
    if (window._previousEditors[date]) {
      window._previousEditors[date].destroy();
      delete window._previousEditors[date];
    }
  } else {
    window._openDocDays.add(date);
    element.classList.add('open');
    // Re-render to create editor container, then init
    setTimeout(() => initPreviousDayEditor(date), 50);
  }
}

function initPreviousDayEditor(date) {
  if (window._previousEditors[date]) return;
  // If either TipTap or data isn't ready yet, retry until both are loaded
  if (!window._tiptapLoaded || !window._dataLoaded) {
    setTimeout(() => initPreviousDayEditor(date), 200);
    return;
  }
  const el = document.getElementById('doc-editor-' + date);
  if (!el) return;
  window._createReadonlyEditor(date, el);
}

function debouncedSaveDailyDoc() {
  if (window._dailyDocSaveTimer) clearTimeout(window._dailyDocSaveTimer);
  window._dailyDocSaveTimer = setTimeout(async () => {
    if (!window._todayEditor) return;
    const today = getTodayStr();
    const html = window._todayEditor.getHTML();
    
    if (!DATA.dailyDocs) DATA.dailyDocs = {};
    if (!DATA.dailyDocs[today]) DATA.dailyDocs[today] = {};
    DATA.dailyDocs[today].content = html;
    DATA.dailyDocs[today].updatedAt = new Date().toISOString();
    
    // Convert HTML to plain text and extract tasks
    const plainText = convertHTMLToText(html);
    if (plainText) {
      const taskCount = extractAndCreateTasks(plainText, null, { sourceDate: today }); // sync-replace, not accumulate
      if (taskCount > 0) {
        console.log(`Created ${taskCount} tasks from daily jot (${today}):`, plainText.substring(0, 100) + '...');
        showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from jot`);
        renderTasks(); // Refresh tasks view if visible
      }
    }
    
    // Extract linked projects/notes from mentions
    const doc = window._todayEditor.getJSON();
    const projects = new Set();
    const notes = new Set();
    function walkNodes(nodes) {
      if (!nodes) return;
      for (const node of nodes) {
        if (node.type === 'projectMention' && node.attrs?.id) projects.add(node.attrs.id);
        if (node.type === 'noteMention' && node.attrs?.id) notes.add(node.attrs.id);
        if (node.content) walkNodes(node.content);
      }
    }
    walkNodes(doc.content);
    DATA.dailyDocs[today].linkedProjects = [...projects];
    DATA.dailyDocs[today].linkedNotes = [...notes];
    
    await saveData();
  }, 1500);
}

// ‚ïê‚ïê‚ïê Universal Rich Text System ‚ïê‚ïê‚ïê
// Used by notes and other textarea-based inputs
window._acActive = false;
window._acItems = [];
window._acIdx = 0;
window._acTrigger = null;

function richInputCheck(textarea) {
  const val = textarea.value;
  const pos = textarea.selectionStart;
  const before = val.slice(0, pos);
  const atMatch = before.match(/@([^\s@#]*)$/);
  const hashMatch = before.match(/#([^\s@#]*)$/);
  if (atMatch) {
    const query = atMatch[1].toLowerCase();
    const items = (DATA.projects||[]).map(p => ({id: p.id, label: p.name, icon: 'üìÅ', type: 'project'}))
      .filter(i => i.label.toLowerCase().includes(query));
    showRichAutocomplete(textarea, items, 'project', pos - atMatch[0].length);
  } else if (hashMatch) {
    const query = hashMatch[1].toLowerCase();
    const items = (DATA.notes||[]).map(n => ({id: n.id, label: n.title || (n.text||'').slice(0,40) || n.created, icon: 'üìù', type: 'note'}))
      .filter(i => i.label.toLowerCase().includes(query));
    if (items.length > 0) showRichAutocomplete(textarea, items, 'note', pos - hashMatch[0].length);
    else hideRichAutocomplete();
  } else { hideRichAutocomplete(); }
}

function showRichAutocomplete(textarea, items, type, triggerPos) {
  if (items.length === 0) { hideRichAutocomplete(); return; }
  window._acActive = true; window._acItems = items; window._acIdx = 0;
  window._acTrigger = { type, startPos: triggerPos, textarea };
  let dropdown = document.getElementById('rich-autocomplete');
  if (!dropdown) { dropdown = document.createElement('div'); dropdown.id = 'rich-autocomplete'; dropdown.className = 'suggestion-dropdown'; document.body.appendChild(dropdown); }
  dropdown.innerHTML = items.map((item, i) =>
    `<div class="suggestion-item ${i === 0 ? 'active' : ''}" onmousedown="selectRichAutocomplete(${i})" onmouseenter="window._acIdx=${i};renderAcHighlight()">
      <span>${item.icon}</span><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.label}</span>
    </div>`
  ).join('');
  const rect = textarea.getBoundingClientRect();
  dropdown.style.left = rect.left + 'px'; dropdown.style.top = (rect.bottom + 4) + 'px'; dropdown.style.display = 'block';
}
function renderAcHighlight() { document.querySelectorAll('#rich-autocomplete .suggestion-item').forEach((el, i) => el.classList.toggle('active', i === window._acIdx)); }
function hideRichAutocomplete() { window._acActive = false; const d = document.getElementById('rich-autocomplete'); if (d) d.style.display = 'none'; }
function selectRichAutocomplete(idx) {
  const item = window._acItems[idx]; const trigger = window._acTrigger;
  if (!item || !trigger) { hideRichAutocomplete(); return; }
  const textarea = trigger.textarea; const val = textarea.value; const pos = textarea.selectionStart;
  const beforeTrigger = val.slice(0, trigger.startPos); const afterCursor = val.slice(pos);
  const insertText = (item.type === 'project' ? '@' : '#') + item.label + ' ';
  textarea.value = beforeTrigger + insertText + afterCursor;
  const newPos = beforeTrigger.length + insertText.length;
  textarea.setSelectionRange(newPos, newPos); textarea.focus();
  textarea.dispatchEvent(new Event('input', {bubbles: true}));
  if (textarea._richOnLink) textarea._richOnLink(item);
  hideRichAutocomplete();
}
function richInputKeydown(event) {
  if (!window._acActive) return;
  if (event.key === 'ArrowDown') { event.preventDefault(); window._acIdx = Math.min(window._acIdx + 1, window._acItems.length - 1); renderAcHighlight(); }
  else if (event.key === 'ArrowUp') { event.preventDefault(); window._acIdx = Math.max(window._acIdx - 1, 0); renderAcHighlight(); }
  else if (event.key === 'Enter' || event.key === 'Tab') { event.preventDefault(); selectRichAutocomplete(window._acIdx); }
  else if (event.key === 'Escape') { hideRichAutocomplete(); }
}
function extractAndCreateTasks(text, projectId, options) {
  if (!text) return 0;
  options = options || {};

  // If sourceDate given, remove undone previously-extracted tasks from that date first
  // This prevents duplicates as the user edits (replace, not accumulate)
  if (options.sourceDate) {
    DATA.tasks = DATA.tasks.filter(t =>
      !(t.source === 'jot' && t.sourceDate === options.sourceDate && !t.done)
    );
  }
  
  // Match both unchecked [] and checked [x] tasks  
  const taskMatches = text.match(/\[[x\s]*\][^\n]*/gi) || [];
  let createdCount = 0;
  
  taskMatches.forEach(match => {
    const isChecked = /\[x\]/i.test(match);
    let taskText = match
      .replace(/\[[x\s]*\]/gi, '')   // strip checkbox
      .replace(/https?:\/\/\S+/g, '') // strip URLs
      .replace(/(#\w+)/g, '')         // strip hashtags
      .replace(/@[^\s]+/g, '')        // strip @mentions
      .trim();
    
    if (!taskText) return;
    
    // Check if this exact task already exists (for non-jot sources)
    if (!options.sourceDate) {
      const existingTask = DATA.tasks.find(t => t.text === taskText);
      if (existingTask) {
        console.log('Task already exists, skipping:', taskText);
        return;
      }
    }
    
    const now = new Date();
    const dateStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
    
    const newTask = {
      id: Date.now() + Math.floor(Math.random()*1000), 
      text: taskText, 
      priority: 'medium', 
      project: projectId || '', 
      owner: 'ryan', 
      created: dateStr, 
      done: isChecked,
      source: options.sourceDate ? 'jot' : undefined,
      sourceDate: options.sourceDate || undefined,
    };
    
    DATA.tasks.push(newTask);
    createdCount++;
    console.log(`Created task from note: "${taskText}" (done: ${isChecked})`);
  });
  
  return createdCount;
}
function jotAutocompleteCheck(textarea) { richInputCheck(textarea); }
function jotAutocompleteKeydown(event) { richInputKeydown(event); }
function autoExpandTextarea(textarea) { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px'; }

// ‚ïê‚ïê‚ïê Markdown Renderer ‚ïê‚ïê‚ïê
function renderMarkdown(text) {
  if (!text) return '';
  let html = text;
  html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (m, lang, code) => '<pre><code class="lang-' + lang + '">' + code.trim() + '</code></pre>');
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  html = html.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;border-radius:8px;margin:6px 0;">');
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline;">$1</a>');
  html = html.replace(/(?<!href="|src=")(https?:\/\/[^\s<"]+)/g, (url) => {
    let display = url;
    try { const u = new URL(url); display = u.hostname + (u.pathname.length > 20 ? u.pathname.slice(0,20) + '‚Ä¶' : u.pathname); } catch(e) { if (url.length > 50) display = url.slice(0,50) + '‚Ä¶'; }
    return '<a href="' + url + '" target="_blank" rel="noopener" title="' + url.replace(/"/g,'&amp;quot;') + '" style="color:var(--accent);text-decoration:underline;word-break:break-all;">' + display + '</a>';
  });
  html = html.replace(/^#### (.+)$/gm, '<h4 style="font-size:13px;font-weight:600;margin:6px 0 2px;">$1</h4>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1 style="font-size:18px;font-weight:700;margin:8px 0 4px;">$1</h1>');
  html = html.replace(/^---+$/gm, '<hr style="border:none;border-top:1px solid var(--border);margin:12px 0;">');
  html = html.replace(/^&gt; (.+)$/gm, '<blockquote style="border-left:3px solid var(--accent);padding:4px 12px;margin:6px 0;color:var(--text-dim);font-style:italic;">$1</blockquote>');
  html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/~~(.+?)~~/g, '<del style="color:var(--text-dim);">$1</del>');
  html = html.replace(/==(.+?)==/g, '<mark style="background:rgba(255,213,79,0.3);padding:1px 3px;border-radius:3px;">$1</mark>');
  html = html.replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)+)/gm, (match, headerRow, sepRow, bodyRows) => {
    const headers = headerRow.split('|').filter(c => c.trim());
    const rows = bodyRows.trim().split('\n').map(r => r.split('|').filter(c => c.trim()));
    return '<table style="width:100%;border-collapse:collapse;margin:8px 0;font-size:12px;"><thead><tr>' + headers.map(h => '<th style="padding:6px 8px;border:1px solid var(--border);background:var(--surface2);text-align:left;">' + h.trim() + '</th>').join('') + '</tr></thead><tbody>' + rows.map(r => '<tr>' + r.map(c => '<td style="padding:6px 8px;border:1px solid var(--border);">' + c.trim() + '</td>').join('') + '</tr>').join('') + '</tbody></table>';
  });
  html = html.replace(/^((?:[ ]*[-*+] .+\n?)+)/gm, (block) => {
    const items = block.trim().split('\n').map(line => {
      const indent = line.match(/^(\s*)/)[1].length;
      const text = line.replace(/^\s*[-*+] /, '');
      return '<li style="margin:2px 0;margin-left:' + (indent > 0 ? indent * 8 : 0) + 'px;">' + text + '</li>';
    });
    return '<ul style="margin:4px 0 4px 18px;font-size:inherit;">' + items.join('') + '</ul>';
  });
  html = html.replace(/^((?:[ ]*\d+\. .+\n?)+)/gm, (block) => {
    const items = block.trim().split('\n').map(line => {
      const text = line.replace(/^\s*\d+\. /, '');
      return '<li style="margin:2px 0;">' + text + '</li>';
    });
    return '<ol style="margin:4px 0 4px 18px;font-size:inherit;">' + items.join('') + '</ol>';
  });
  html = html.replace(/(?<![&\w])(#\w+)/g, '<span class="jot-tag">$1</span>');
  html = html.replace(/\n\n+/g, '</p><p style="margin:8px 0;">');
  html = html.replace(/\n/g, '<br>');
  html = '<p style="margin:0;">' + html + '</p>';
  html = html.replace(/<p style="margin:0;"><\/p>/g, '');
  html = html.replace(/<p style="margin:8px 0;"><\/p>/g, '');
  return html;
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT NEXT STEPS ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function addNextStep(projectId) {
  const text = prompt('New step:');
  if (!text || !text.trim()) return;
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p) return;
  if (!p.nextSteps) p.nextSteps = [];
  p.nextSteps.push({ text: text.trim(), priority: 'medium', status: 'pending' });
  await saveData();
  openProjectModal(projectId);
}

async function queueStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const text = typeof step === 'string' ? step : step.text;

  // Add command to queue
  const cmd = {
    id: 'cmd-' + Date.now(),
    type: 'execute-step',
    projectId: projectId,
    stepIndex: stepIdx,
    stepText: text,
    status: 'pending',
    created: new Date().toISOString()
  };
  DATA.commands = DATA.commands || [];
  DATA.commands.push(cmd);

  // Update step status to queued
  if (typeof step === 'string') {
    p.nextSteps[stepIdx] = { text: step, status: 'queued' };
  } else {
    step.status = 'queued';
  }

  await saveData();
  openProjectModal(projectId);
}

async function acceptStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  if (typeof step === 'object') step.status = 'done';
  else p.nextSteps[stepIdx] = { text: step, status: 'done' };

  await saveData();
  openProjectModal(projectId);
}

async function rejectStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const reason = prompt('What needs to change?');
  if (reason === null) return;

  const step = p.nextSteps[stepIdx];
  if (typeof step === 'object') {
    step.status = '';
    step.reworkReason = reason;
  } else {
    p.nextSteps[stepIdx] = { text: step, status: '', reworkReason: reason };
  }

  // Queue rework command
  const cmd = {
    id: 'cmd-' + Date.now(),
    type: 'rework',
    projectId: projectId,
    stepIndex: stepIdx,
    stepText: typeof step === 'string' ? step : step.text,
    reason: reason,
    status: 'pending',
    created: new Date().toISOString()
  };
  DATA.commands = DATA.commands || [];
  DATA.commands.push(cmd);

  await saveData();
  openProjectModal(projectId);
}

async function deleteStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps) return;

  p.nextSteps.splice(stepIdx, 1);
  await saveData();
  openProjectModal(projectId);
}

async function cycleStepPriority(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const cycle = { high: 'medium', medium: 'low', low: 'high', '': 'high' };

  if (typeof step === 'string') {
    p.nextSteps[stepIdx] = { text: step, priority: 'high' };
  } else {
    step.priority = cycle[step.priority || ''] || 'high';
  }

  await saveData();
  openProjectModal(projectId);
}

async function editNextStep(projectId, stepIdx, el) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const currentText = typeof step === 'string' ? step : step.text;

  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentText;
  input.style.cssText = 'width:100%;background:var(--surface2);border:1px solid var(--accent);border-radius:4px;color:var(--text);padding:4px 8px;font-size:12px;';

  const save = async () => {
    const newText = input.value.trim();
    if (newText && newText !== currentText) {
      if (typeof step === 'string') {
        p.nextSteps[stepIdx] = newText;
      } else {
        step.text = newText;
      }
      await saveData();
    }
    openProjectModal(projectId);
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); save(); }
    if (e.key === 'Escape') openProjectModal(projectId);
  });
  input.addEventListener('blur', save);

  el.replaceWith(input);
  input.focus();
  input.select();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initKeyboardShortcuts() {
  // Cmd+K: Open search (works from anywhere)
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
  });

  document.addEventListener('keydown', (e) => {
    // Don't fire when typing in inputs/textareas
    const tag = document.activeElement?.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || document.activeElement?.isContentEditable) return;

    // Don't fire with modifier keys (except shift for ?)
    if (e.ctrlKey || e.metaKey || e.altKey) return;

    switch (e.key) {
      case 'n': // New jot
        e.preventDefault();
        navigateTo('jots');
        setTimeout(() => document.getElementById('jot-input')?.focus(), 100);
        break;
      case '/': // Search jots
        e.preventDefault();
        navigateTo('jots');
        setTimeout(() => document.getElementById('jot-search')?.focus(), 100);
        break;
      case 't': // New task
        e.preventDefault();
        navigateTo('tasks');
        setTimeout(() => document.getElementById('new-task-input')?.focus(), 100);
        break;
      case 'd': // Dashboard
        e.preventDefault();
        navigateTo('dashboard');
        break;
      case 'j': // Jots
        e.preventDefault();
        navigateTo('jots');
        break;
      case 'p': // Projects
        e.preventDefault();
        navigateTo('projects');
        break;
      case '?': // Show shortcuts help
        e.preventDefault();
        toggleShortcutsHelp();
        break;
      case 'Escape': // Close modals
        closeAllModals();
        break;
    }
  });
}

function toggleShortcutsHelp() {
  let help = document.getElementById('shortcuts-help');
  if (help) {
    help.remove();
    return;
  }
  help = document.createElement('div');
  help.id = 'shortcuts-help';
  help.onclick = () => help.remove();
  help.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:flex;align-items:center;justify-content:center;';
  help.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:360px;width:90%;" onclick="event.stopPropagation()">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">‚å®Ô∏è Keyboard Shortcuts</h3>
      <div style="display:grid;grid-template-columns:40px 1fr;gap:8px 12px;font-size:13px;">
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">n</kbd><span>New jot</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">/</kbd><span>Search jots</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">t</kbd><span>New task</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">d</kbd><span>Dashboard</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">j</kbd><span>Jots</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">p</kbd><span>Projects</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">?</kbd><span>This help</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">esc</kbd><span>Close modals</span>
      </div>
      <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--text-dim);">Press any key or click outside to close</div>
    </div>
  `;
  document.body.appendChild(help);
}

function closeAllModals() {
  // Close any open modals
  document.querySelectorAll('[id$="-modal"]').forEach(m => {
    if (m.style.display !== 'none') m.style.display = 'none';
  });
  document.getElementById('shortcuts-help')?.remove();
  document.body.style.overflow = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SELECTION TOOLBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let selectionContext = { jotId: null, text: '', range: null };

function initSelectionToolbar() {
  const toolbar = document.getElementById('selection-toolbar');
  if (!toolbar) return;

  document.addEventListener('mouseup', (e) => {
    // Small delay to let selection finalize
    setTimeout(() => {
      const selection = window.getSelection();
      const text = selection.toString().trim();

      if (!text || text.length < 2) {
        toolbar.classList.remove('visible');
        return;
      }

      // Check if selection is inside a jot
      const jotEntry = selection.anchorNode?.parentElement?.closest?.('.jot-entry');
      if (!jotEntry) {
        toolbar.classList.remove('visible');
        return;
      }

      const jotId = parseInt(jotEntry.dataset.jotId);
      selectionContext = { jotId, text, range: selection.getRangeAt(0).cloneRange() };

      // Position toolbar above selection
      const rect = selection.getRangeAt(0).getBoundingClientRect();
      toolbar.style.left = Math.max(8, rect.left + rect.width / 2 - toolbar.offsetWidth / 2) + 'px';
      toolbar.style.top = (rect.top - 44 + window.scrollY) + 'px';
      toolbar.classList.add('visible');
    }, 10);
  });

  document.addEventListener('mousedown', (e) => {
    if (!e.target.closest('.selection-toolbar')) {
      toolbar.classList.remove('visible');
    }
  });
}

async function selectionToTask() {
  const { jotId, text } = selectionContext;
  if (!text) return;

  const taskText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/`/g, '').trim();
  if (!taskText) return;

  const now = new Date();
  const newTask = {
    id: Date.now(),
    text: taskText,
    priority: 'medium',
    project: '',
    owner: 'ryan',
    done: false,
    created: now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0") + "-" + String(now.getDate()).padStart(2,"0"),
    source: 'jot',
    linkedJotId: jotId || null,
    messages: []
  };

  DATA.tasks.push(newTask);
  await saveData();
  renderTasks();

  // Hide toolbar and show confirmation
  document.getElementById('selection-toolbar').classList.remove('visible');
  window.getSelection().removeAllRanges();
  
  // Brief toast
  showToast('‚òëÔ∏è Task created: ' + taskText.slice(0, 40) + (taskText.length > 40 ? '...' : ''));
}

async function selectionFormat(wrapper) {
  const { jotId, text } = selectionContext;
  if (!jotId || !text) return;

  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  const wrapped = wrapper + text + wrapper;
  jot.text = jot.text.replace(text, wrapped);

  // Extract and create tasks from updated jot (legacy system)
  const taskCount = extractAndCreateTasks(jot.text, jot.projectId);
  if (taskCount > 0) {
    console.log(`Created ${taskCount} tasks from legacy jot:`, jot.id);
    showToast(`${taskCount} task${taskCount > 1 ? 's' : ''} created from jot`);
    renderTasks();
  }

  await saveData();
  renderJots();
  document.getElementById('selection-toolbar').classList.remove('visible');
}

async function selectionHighlight() {
  const { jotId } = selectionContext;
  if (!jotId) return;

  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  jot.pinned = !jot.pinned;
  await saveData();
  renderJots();
  document.getElementById('selection-toolbar').classList.remove('visible');
  showToast(jot.pinned ? 'üîñ Jot pinned' : 'üìå Jot unpinned');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SITEWIDE SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _searchDebounce = null;
let _searchSelectedIdx = -1;
let _searchResults = [];

function openSearch() {
  const overlay = document.getElementById('search-overlay');
  overlay.classList.add('active');
  const input = document.getElementById('search-input');
  input.value = '';
  document.getElementById('search-results').innerHTML = '';
  _searchSelectedIdx = -1;
  _searchResults = [];
  setTimeout(() => input.focus(), 50);
  input.addEventListener('keydown', handleSearchKeydown);
}

function closeSearch() {
  document.getElementById('search-overlay').classList.remove('active');
  document.getElementById('search-input').removeEventListener('keydown', handleSearchKeydown);
}

function handleSearchKeydown(e) {
  if (e.key === 'Escape') { e.preventDefault(); closeSearch(); return; }
  const items = document.querySelectorAll('.search-result-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _searchSelectedIdx = Math.min(_searchSelectedIdx + 1, items.length - 1);
    updateSearchSelection(items);
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _searchSelectedIdx = Math.max(_searchSelectedIdx - 1, 0);
    updateSearchSelection(items);
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (_searchSelectedIdx >= 0 && _searchSelectedIdx < _searchResults.length) {
      activateSearchResult(_searchResults[_searchSelectedIdx]);
    }
  }
}

function updateSearchSelection(items) {
  items.forEach((el, i) => el.classList.toggle('selected', i === _searchSelectedIdx));
  items[_searchSelectedIdx]?.scrollIntoView({ block: 'nearest' });
}

function onSearchInput() {
  clearTimeout(_searchDebounce);
  _searchDebounce = setTimeout(() => {
    const q = (document.getElementById('search-input').value || '').trim().toLowerCase();
    if (!q) {
      document.getElementById('search-results').innerHTML = '';
      _searchResults = [];
      _searchSelectedIdx = -1;
      return;
    }
    performSearch(q);
  }, 150);
}

function highlightMatch(text, query) {
  if (!text) return '';
  const idx = text.toLowerCase().indexOf(query);
  if (idx === -1) return escapeHtml(text.length > 80 ? text.slice(0, 80) + '‚Ä¶' : text);
  const start = Math.max(0, idx - 30);
  const end = Math.min(text.length, idx + query.length + 50);
  let snippet = (start > 0 ? '‚Ä¶' : '') + text.slice(start, end) + (end < text.length ? '‚Ä¶' : '');
  return snippet.replace(new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi'), '<mark>$1</mark>');
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function performSearch(q) {
  const results = [];
  const typeConfig = [
    { type: 'Projects', icon: 'üöÄ', items: DATA.projects || [], fields: ['name', 'description', 'goal'], navigate: (item) => ({ page: 'projects', action: () => openProjectModal(item.id) }) },
    { type: 'Notes', icon: 'üìù', items: DATA.notes || [], fields: ['title', 'content'], navigate: (item) => ({ page: 'notes' }) },
    { type: 'Daily Notes', icon: '‚úèÔ∏è', items: Object.entries(DATA.dailyDocs || {}).map(([date, doc]) => ({ date, text: (doc.content||'').replace(/<[^>]+>/g, '') })), fields: ['text', 'date'], navigate: (item) => ({ page: 'jots' }) },
    { type: 'Tasks', icon: '‚úÖ', items: DATA.tasks || [], fields: ['text'], navigate: (item) => ({ page: 'tasks' }) },
    { type: 'Discussions', icon: 'üí¨', items: DATA.discussions || [], fields: ['title'], navigate: (item) => ({ page: 'discussions' }) },
    { type: 'Decisions', icon: '‚öñÔ∏è', items: DATA.decisions || [], fields: ['text', 'context'], navigate: (item) => ({ page: 'decisions' }) },
  ];

  // Also search project nextSteps and notes
  for (const p of (DATA.projects || [])) {
    for (const step of (p.nextSteps || [])) {
      const stepText = typeof step === 'string' ? step : (step.text || '');
      if (stepText.toLowerCase().includes(q)) {
        results.push({ type: 'Tasks', icon: '‚úÖ', title: stepText, snippet: `Project: ${p.name}`, nav: { page: 'projects', action: () => openProjectModal(p.id) } });
      }
    }
    for (const note of (p.notes || [])) {
      const noteText = typeof note === 'string' ? note : (note.text || note.content || '');
      if (noteText.toLowerCase().includes(q)) {
        results.push({ type: 'Notes', icon: 'üìù', title: noteText.slice(0, 80), snippet: `Project: ${p.name}`, nav: { page: 'projects', action: () => openProjectModal(p.id) } });
      }
    }
  }

  // Search discussion topics
  for (const d of (DATA.discussions || [])) {
    for (const topic of (d.topics || [])) {
      const topicText = topic.text || topic.title || (typeof topic === 'string' ? topic : '');
      if (topicText.toLowerCase().includes(q)) {
        results.push({ type: 'Discussions', icon: 'üí¨', title: topicText.slice(0, 80), snippet: `Discussion: ${d.title || ''}`, nav: { page: 'discussions' } });
      }
    }
  }

  for (const cfg of typeConfig) {
    for (const item of cfg.items) {
      for (const field of cfg.fields) {
        const val = item[field];
        if (val && typeof val === 'string' && val.toLowerCase().includes(q)) {
          const nav = cfg.navigate(item);
          results.push({ type: cfg.type, icon: cfg.icon, title: item.name || item.title || (val.slice(0, 60)), snippet: highlightMatch(val, q), nav, field });
          break; // one match per item
        }
      }
    }
  }

  // Deduplicate by title
  const seen = new Set();
  _searchResults = results.filter(r => {
    const key = r.type + ':' + r.title;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });

  _searchSelectedIdx = _searchResults.length > 0 ? 0 : -1;
  renderSearchResults(q);
}

function renderSearchResults(q) {
  const container = document.getElementById('search-results');
  if (_searchResults.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:24px;color:var(--text-dim);font-size:13px;">No results found</div>';
    return;
  }

  // Group by type
  const groups = {};
  for (const r of _searchResults) {
    if (!groups[r.type]) groups[r.type] = [];
    groups[r.type].push(r);
  }

  let html = '';
  let idx = 0;
  for (const [type, items] of Object.entries(groups)) {
    html += `<div class="search-group-label">${items[0].icon} ${type}</div>`;
    for (const r of items) {
      const selected = idx === _searchSelectedIdx ? ' selected' : '';
      const title = escapeHtml(r.title || '');
      html += `<div class="search-result-item${selected}" data-idx="${idx}" onclick="activateSearchResult(_searchResults[${idx}])">
        <span class="sr-icon">${r.icon}</span>
        <div class="sr-body">
          <div class="sr-title">${title}</div>
          ${r.snippet ? `<div class="sr-snippet">${r.snippet}</div>` : ''}
        </div>
      </div>`;
      idx++;
    }
  }
  container.innerHTML = html;
}

function activateSearchResult(result) {
  closeSearch();
  if (result.nav) {
    navigateTo(result.nav.page);
    if (result.nav.action) setTimeout(result.nav.action, 100);
  }
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:400;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;';
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOT DRAG-REORDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Legacy jot drag functions (no-ops for backward compat)
function jotDragStart() {}
function jotDragOver() {}
function jotDragLeave() {}
async function jotDrop() {}
function initJotDragDrop() {}
function handleJotFileAttach() {}
function processDroppedFiles() {}
function removePendingFile() {}
async function editJotLinks() {}
async function saveJotLinks() {}

/* Removed legacy jot drag/drop/file code ‚Äî replaced by TipTap editor */
void function legacyJotStub() {
}();

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('k2auth') === 'true' && localStorage.getItem('gh_token')) {
    GH_TOKEN = localStorage.getItem('gh_token');
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-main').style.display = 'flex';
    loadData();
    initSelectionToolbar();
    initKeyboardShortcuts();
  }
});
</script>
<!-- Selection Toolbar -->
<div class="selection-toolbar" id="selection-toolbar">
  <button class="sel-btn sel-task" onclick="selectionToTask()">‚òëÔ∏è Task</button>
  <div class="sel-divider"></div>
  <button class="sel-btn" onclick="selectionFormat('**')"><b>B</b></button>
  <button class="sel-btn" onclick="selectionFormat('*')"><i>I</i></button>
  <button class="sel-btn" onclick="selectionFormat('`')">&lt;/&gt;</button>
  <div class="sel-divider"></div>
  <button class="sel-btn" onclick="selectionHighlight()">üîñ Pin</button>
</div>
<!-- TipTap Editor Module -->
<script type="module">
import { Editor } from 'https://esm.sh/@tiptap/core@2.11.5';
import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.11.5';
import TaskList from 'https://esm.sh/@tiptap/extension-task-list@2.11.5';
import TaskItem from 'https://esm.sh/@tiptap/extension-task-item@2.11.5';
import Link from 'https://esm.sh/@tiptap/extension-link@2.11.5';
import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.11.5';
import Typography from 'https://esm.sh/@tiptap/extension-typography@2.11.5';
import { Node, mergeAttributes } from 'https://esm.sh/@tiptap/core@2.11.5';
import { PluginKey, Plugin } from 'https://esm.sh/@tiptap/pm@2.11.5/state';

// Make TipTap available globally for note editors
window.Editor = Editor;
window.StarterKit = StarterKit;
window.TaskList = TaskList;
window.TaskItem = TaskItem;

// Custom Mention Nodes
const ProjectMention = Node.create({
  name: 'projectMention',
  group: 'inline',
  inline: true,
  selectable: false,
  atom: true,
  addAttributes() {
    return {
      id: { default: null },
      label: { default: null },
    };
  },
  parseHTML() {
    return [{ tag: 'span.mention-project' }];
  },
  renderHTML({ node, HTMLAttributes }) {
    return ['span', mergeAttributes(HTMLAttributes, {
      class: 'mention-project',
      'data-id': node.attrs.id,
    }), `@${node.attrs.label}`];
  },
});

const NoteMention = Node.create({
  name: 'noteMention',
  group: 'inline',
  inline: true,
  selectable: false,
  atom: true,
  addAttributes() {
    return {
      id: { default: null },
      label: { default: null },
    };
  },
  parseHTML() {
    return [{ tag: 'span.mention-note' }];
  },
  renderHTML({ node, HTMLAttributes }) {
    return ['span', mergeAttributes(HTMLAttributes, {
      class: 'mention-note',
      'data-id': node.attrs.id,
    }), `#${node.attrs.label}`];
  },
});

// Slash command menu
const slashCommands = [
  { label: 'Heading 1', icon: 'H1', desc: 'Big heading', action: (editor) => editor.chain().focus().toggleHeading({ level: 1 }).run() },
  { label: 'Heading 2', icon: 'H2', desc: 'Medium heading', action: (editor) => editor.chain().focus().toggleHeading({ level: 2 }).run() },
  { label: 'Heading 3', icon: 'H3', desc: 'Small heading', action: (editor) => editor.chain().focus().toggleHeading({ level: 3 }).run() },
  { label: 'Bullet List', icon: '‚Ä¢', desc: 'Unordered list', action: (editor) => editor.chain().focus().toggleBulletList().run() },
  { label: 'Numbered List', icon: '1.', desc: 'Ordered list', action: (editor) => editor.chain().focus().toggleOrderedList().run() },
  { label: 'Task List', icon: '‚òë', desc: 'Checkboxes', action: (editor) => editor.chain().focus().toggleTaskList().run() },
  { label: 'Code Block', icon: '<>', desc: 'Code snippet', action: (editor) => editor.chain().focus().toggleCodeBlock().run() },
  { label: 'Blockquote', icon: '‚ùù', desc: 'Quote text', action: (editor) => editor.chain().focus().toggleBlockquote().run() },
  { label: 'Divider', icon: '‚Äî', desc: 'Horizontal rule', action: (editor) => editor.chain().focus().setHorizontalRule().run() },
];

let slashMenuEl = null;
let slashMenuIdx = 0;
let slashMenuOpen = false;
let slashMenuEditor = null;
let slashMenuPos = 0;
let slashFilterText = '';

function showSlashMenu(editor, coords, filterText) {
  slashMenuEditor = editor;
  slashFilterText = filterText;
  const filtered = slashCommands.filter(c => c.label.toLowerCase().includes(filterText.toLowerCase()));
  if (filtered.length === 0) { hideSlashMenu(); return; }
  
  if (!slashMenuEl) {
    slashMenuEl = document.createElement('div');
    slashMenuEl.className = 'slash-menu';
    document.body.appendChild(slashMenuEl);
  }
  
  slashMenuIdx = 0;
  slashMenuOpen = true;
  slashMenuEl.innerHTML = filtered.map((cmd, i) =>
    `<div class="slash-menu-item ${i === 0 ? 'active' : ''}" data-idx="${i}">
      <span class="sm-icon">${cmd.icon}</span>
      <span class="sm-label">${cmd.label}</span>
      <span class="sm-desc">${cmd.desc}</span>
    </div>`
  ).join('');
  
  slashMenuEl.style.left = coords.left + 'px';
  slashMenuEl.style.top = (coords.bottom + 4) + 'px';
  slashMenuEl.style.display = 'block';
  
  slashMenuEl.querySelectorAll('.slash-menu-item').forEach(item => {
    item.addEventListener('mousedown', (e) => {
      e.preventDefault();
      const idx = parseInt(item.dataset.idx);
      selectSlashCommand(filtered[idx]);
    });
  });
}

function hideSlashMenu() {
  slashMenuOpen = false;
  if (slashMenuEl) slashMenuEl.style.display = 'none';
}

function selectSlashCommand(cmd) {
  if (!cmd || !slashMenuEditor) return;
  // Delete the slash and filter text
  const { from } = slashMenuEditor.state.selection;
  const textBefore = slashMenuEditor.state.doc.textBetween(Math.max(0, from - 20), from);
  const slashIdx = textBefore.lastIndexOf('/');
  if (slashIdx >= 0) {
    const deleteFrom = from - (textBefore.length - slashIdx);
    slashMenuEditor.chain().focus().deleteRange({ from: deleteFrom, to: from }).run();
  }
  cmd.action(slashMenuEditor);
  hideSlashMenu();
}

// Suggestion dropdown for @ and #
let suggestionEl = null;
let suggestionOpen = false;
let suggestionItems = [];
let suggestionIdx = 0;
let suggestionType = null; // 'project' or 'note'
let suggestionEditor = null;
let suggestionTriggerPos = 0;

function showSuggestion(editor, type, coords, items, triggerPos) {
  if (items.length === 0) { hideSuggestion(); return; }
  suggestionEditor = editor;
  suggestionType = type;
  suggestionItems = items;
  suggestionIdx = 0;
  suggestionOpen = true;
  suggestionTriggerPos = triggerPos;
  
  if (!suggestionEl) {
    suggestionEl = document.createElement('div');
    suggestionEl.className = 'suggestion-dropdown';
    document.body.appendChild(suggestionEl);
  }
  
  suggestionEl.innerHTML = items.map((item, i) =>
    `<div class="suggestion-item ${i === 0 ? 'active' : ''}" data-idx="${i}">
      <span>${type === 'project' ? 'üìÅ' : 'üìù'}</span>
      <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${item.label}</span>
    </div>`
  ).join('');
  
  suggestionEl.style.left = coords.left + 'px';
  suggestionEl.style.top = (coords.bottom + 4) + 'px';
  suggestionEl.style.display = 'block';
  
  suggestionEl.querySelectorAll('.suggestion-item').forEach(item => {
    item.addEventListener('mousedown', (e) => {
      e.preventDefault();
      selectSuggestion(parseInt(item.dataset.idx));
    });
  });
}

function hideSuggestion() {
  suggestionOpen = false;
  if (suggestionEl) suggestionEl.style.display = 'none';
}

function selectSuggestion(idx) {
  const item = suggestionItems[idx];
  if (!item || !suggestionEditor) { hideSuggestion(); return; }
  
  const { from } = suggestionEditor.state.selection;
  const deleteFrom = suggestionTriggerPos;
  
  const nodeType = suggestionType === 'project' ? 'projectMention' : 'noteMention';
  
  suggestionEditor.chain()
    .focus()
    .deleteRange({ from: deleteFrom, to: from })
    .insertContent([
      { type: nodeType, attrs: { id: item.id, label: item.label } },
      { type: 'text', text: ' ' },
    ])
    .run();
  
  hideSuggestion();
}

// Floating toolbar
let floatToolbarEl = null;

function createFloatingToolbar() {
  if (floatToolbarEl) return floatToolbarEl;
  floatToolbarEl = document.createElement('div');
  floatToolbarEl.className = 'editor-float-toolbar';
  floatToolbarEl.innerHTML = `
    <button class="eft-btn" data-cmd="bold" title="Bold"><b>B</b></button>
    <button class="eft-btn" data-cmd="italic" title="Italic"><i>I</i></button>
    <button class="eft-btn" data-cmd="strike" title="Strikethrough"><s>S</s></button>
    <button class="eft-btn" data-cmd="code" title="Code">&lt;/&gt;</button>
    <div class="eft-divider"></div>
    <button class="eft-btn" data-cmd="h2" title="Heading">H2</button>
    <button class="eft-btn" data-cmd="link" title="Link">üîó</button>
  `;
  document.body.appendChild(floatToolbarEl);
  
  floatToolbarEl.querySelectorAll('.eft-btn').forEach(btn => {
    btn.addEventListener('mousedown', (e) => {
      e.preventDefault();
      const cmd = btn.dataset.cmd;
      const editor = window._todayEditor;
      if (!editor) return;
      switch(cmd) {
        case 'bold': editor.chain().focus().toggleBold().run(); break;
        case 'italic': editor.chain().focus().toggleItalic().run(); break;
        case 'strike': editor.chain().focus().toggleStrike().run(); break;
        case 'code': editor.chain().focus().toggleCode().run(); break;
        case 'h2': editor.chain().focus().toggleHeading({ level: 2 }).run(); break;
        case 'link':
          const url = prompt('URL:');
          if (url) editor.chain().focus().setLink({ href: url }).run();
          break;
      }
      updateFloatingToolbar(editor);
    });
  });
  
  return floatToolbarEl;
}

function updateFloatingToolbar(editor) {
  if (!floatToolbarEl) return;
  floatToolbarEl.querySelectorAll('.eft-btn').forEach(btn => {
    const cmd = btn.dataset.cmd;
    let active = false;
    switch(cmd) {
      case 'bold': active = editor.isActive('bold'); break;
      case 'italic': active = editor.isActive('italic'); break;
      case 'strike': active = editor.isActive('strike'); break;
      case 'code': active = editor.isActive('code'); break;
      case 'h2': active = editor.isActive('heading', { level: 2 }); break;
      case 'link': active = editor.isActive('link'); break;
    }
    btn.classList.toggle('is-active', active);
  });
}

function showFloatingToolbar(editor) {
  const toolbar = createFloatingToolbar();
  const { from, to } = editor.state.selection;
  if (from === to) { hideFloatingToolbar(); return; }
  
  const coords = editor.view.coordsAtPos(from);
  toolbar.style.left = coords.left + 'px';
  toolbar.style.top = (coords.top - 44) + 'px';
  toolbar.classList.add('visible');
  updateFloatingToolbar(editor);
}

function hideFloatingToolbar() {
  if (floatToolbarEl) floatToolbarEl.classList.remove('visible');
}

// Slash/mention plugin for TipTap
function createInputPlugin() {
  return new Plugin({
    key: new PluginKey('slashMention'),
    props: {
      handleKeyDown(view, event) {
        if (slashMenuOpen) {
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            const filtered = slashCommands.filter(c => c.label.toLowerCase().includes(slashFilterText.toLowerCase()));
            slashMenuIdx = Math.min(slashMenuIdx + 1, filtered.length - 1);
            slashMenuEl?.querySelectorAll('.slash-menu-item').forEach((el, i) => el.classList.toggle('active', i === slashMenuIdx));
            return true;
          }
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            slashMenuIdx = Math.max(slashMenuIdx - 1, 0);
            slashMenuEl?.querySelectorAll('.slash-menu-item').forEach((el, i) => el.classList.toggle('active', i === slashMenuIdx));
            return true;
          }
          if (event.key === 'Enter') {
            event.preventDefault();
            const filtered = slashCommands.filter(c => c.label.toLowerCase().includes(slashFilterText.toLowerCase()));
            selectSlashCommand(filtered[slashMenuIdx]);
            return true;
          }
          if (event.key === 'Escape') {
            hideSlashMenu();
            return true;
          }
        }
        if (suggestionOpen) {
          if (event.key === 'ArrowDown') {
            event.preventDefault();
            suggestionIdx = Math.min(suggestionIdx + 1, suggestionItems.length - 1);
            suggestionEl?.querySelectorAll('.suggestion-item').forEach((el, i) => el.classList.toggle('active', i === suggestionIdx));
            return true;
          }
          if (event.key === 'ArrowUp') {
            event.preventDefault();
            suggestionIdx = Math.max(suggestionIdx - 1, 0);
            suggestionEl?.querySelectorAll('.suggestion-item').forEach((el, i) => el.classList.toggle('active', i === suggestionIdx));
            return true;
          }
          if (event.key === 'Enter' || event.key === 'Tab') {
            event.preventDefault();
            selectSuggestion(suggestionIdx);
            return true;
          }
          if (event.key === 'Escape') {
            hideSuggestion();
            return true;
          }
        }
        return false;
      },
    },
  });
}

// Get cursor coordinates
function getCursorCoords(editor) {
  const { from } = editor.state.selection;
  try {
    return editor.view.coordsAtPos(from);
  } catch {
    return { left: 100, top: 100, bottom: 120 };
  }
}

// Check for slash commands and mentions on update
function handleEditorUpdate(editor) {
  const { from } = editor.state.selection;
  const textBefore = editor.state.doc.textBetween(Math.max(0, from - 30), from, '\n');
  
  // Slash commands: only at start of line or after whitespace
  const slashMatch = textBefore.match(/(?:^|\n)\/?([a-zA-Z]*)$/);
  if (textBefore.match(/(?:^|\n)\/([a-zA-Z]*)$/)) {
    const filter = slashMatch ? slashMatch[1] : '';
    const coords = getCursorCoords(editor);
    showSlashMenu(editor, coords, filter);
    return;
  } else {
    hideSlashMenu();
  }
  
  // @ mentions
  const atMatch = textBefore.match(/@([^\s@#]*)$/);
  if (atMatch) {
    const query = atMatch[1].toLowerCase();
    const items = (window.DATA?.projects || [])
      .map(p => ({ id: p.id, label: p.name }))
      .filter(i => i.label.toLowerCase().includes(query));
    const triggerPos = from - atMatch[0].length;
    const coords = getCursorCoords(editor);
    showSuggestion(editor, 'project', coords, items, triggerPos);
    return;
  }
  
  // # mentions
  const hashMatch = textBefore.match(/#([^\s@#]*)$/);
  if (hashMatch) {
    const query = hashMatch[1].toLowerCase();
    const items = (window.DATA?.notes || [])
      .map(n => ({ id: n.id || '', label: n.title || (n.text || '').slice(0, 40) || n.created || 'note' }))
      .filter(i => i.label.toLowerCase().includes(query));
    const triggerPos = from - hashMatch[0].length;
    const coords = getCursorCoords(editor);
    showSuggestion(editor, 'note', coords, items, triggerPos);
    return;
  }
  
  hideSuggestion();
}

// Create editor instance
function createEditor(element, content, options = {}) {
  const extensions = [
    StarterKit.configure({
      heading: { levels: [1, 2, 3] },
    }),
    TaskList,
    TaskItem.configure({ nested: true }),
    Link.configure({ openOnClick: true, HTMLAttributes: { class: '' } }),
    Placeholder.configure({ placeholder: options.placeholder || 'Start typing...' }),
    Typography,
    ProjectMention,
    NoteMention,
  ];
  
  const editor = new Editor({
    element,
    extensions,
    content: content || '<p></p>',
    editable: options.editable !== false,
    editorProps: {
      attributes: { class: 'ProseMirror' },
    },
    onCreate({ editor }) {
      if (options.editable !== false) {
        // Register the plugin
        const { state } = editor;
        const newState = state.reconfigure({
          plugins: [...state.plugins, createInputPlugin()],
        });
        editor.view.updateState(newState);
      }
    },
    onUpdate({ editor }) {
      if (options.editable === false) return;
      handleEditorUpdate(editor);
      if (options.onUpdate) options.onUpdate(editor);
    },
    onSelectionUpdate({ editor }) {
      if (options.editable === false) return;
      const { from, to } = editor.state.selection;
      if (from !== to) {
        showFloatingToolbar(editor);
      } else {
        hideFloatingToolbar();
      }
    },
    onBlur() {
      // Delay hiding to allow toolbar clicks
      setTimeout(() => hideFloatingToolbar(), 200);
    },
  });
  
  return editor;
}

// Initialize today's editor
window._createTodayEditor = function(today) {
  const el = document.getElementById('daily-doc-today-editor');
  if (!el || window._todayEditor) return;
  
  const doc = window.DATA?.dailyDocs?.[today];
  const content = doc?.content || '<p></p>';
  
  window._todayEditor = createEditor(el, content, {
    placeholder: "What's on your mind? Type / for commands, @ for projects, # for notes...",
    onUpdate: () => window.debouncedSaveDailyDoc(),
  });
  
  // Focus
  setTimeout(() => window._todayEditor?.commands?.focus?.('end'), 100);
};

// Initialize read-only editor for previous day
window._createReadonlyEditor = function(date, el) {
  if (window._previousEditors[date]) return;
  const doc = window.DATA?.dailyDocs?.[date];
  if (!doc) return;
  
  window._previousEditors[date] = createEditor(el, doc.content || '<p></p>', {
    editable: false,
  });
};

// Mark TipTap as loaded and init pending editor
window._tiptapLoaded = true;
if (window._pendingTodayInit) {
  window._createTodayEditor(window._pendingTodayInit);
}
// Init any previous-day editors that were open before TipTap loaded
if (window._openDocDays) {
  window._openDocDays.forEach(date => {
    const el = document.getElementById('doc-editor-' + date);
    if (el) window._createReadonlyEditor(date, el);
  });
}
</script>
</body>
</html>