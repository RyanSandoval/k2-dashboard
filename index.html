<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>K-2 Command Center</title>
<style>
  :root {
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --border: #2a2a3a;
    --text: #e0e0e8;
    --text-dim: #8888a0;
    --accent: #4a9eff;
    --accent2: #7c5cff;
    --green: #4ade80;
    --yellow: #fbbf24;
    --red: #f87171;
    --orange: #fb923c;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Layout */
  .app { display: flex; height: 100vh; }
  .sidebar {
    width: 240px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    padding: 20px 0;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
  }
  .sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }
  .sidebar-header h1 {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: -0.3px;
  }
  .sidebar-header h1 span { color: var(--accent); }
  .sidebar-header p { font-size: 11px; color: var(--text-dim); margin-top: 4px; }
  .nav-section { padding: 8px 12px; }
  .nav-section-title {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    padding: 8px 8px 4px;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    color: var(--text-dim);
    transition: all 0.15s;
  }
  .nav-item:hover { background: var(--surface2); color: var(--text); }
  .nav-item.active { background: var(--accent); color: #fff; }
  .nav-item .icon { font-size: 16px; width: 20px; text-align: center; }
  .nav-item .badge {
    margin-left: auto;
    background: var(--accent2);
    color: #fff;
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 600;
  }
  .sidebar-footer {
    margin-top: auto;
    padding: 12px 20px;
    border-top: 1px solid var(--border);
    font-size: 11px;
    color: var(--text-dim);
  }

  /* Main Content */
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
  }
  .page { display: none; }
  .page.active { display: block; }
  .page-header {
    margin-bottom: 24px;
  }
  .page-header h2 {
    font-size: 24px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }
  .page-header p { color: var(--text-dim); font-size: 14px; margin-top: 4px; }

  /* Cards */
  .card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
  }
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: border-color 0.15s;
  }
  .card:hover { border-color: var(--accent); }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }
  .card-title { font-size: 15px; font-weight: 600; }
  .card-body { font-size: 13px; color: var(--text-dim); line-height: 1.6; }
  .card-footer {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  /* Tags & Badges */
  .tag {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 6px;
    font-weight: 500;
  }
  .tag-blue { background: rgba(74,158,255,0.15); color: var(--accent); }
  .tag-purple { background: rgba(124,92,255,0.15); color: var(--accent2); }
  .tag-green { background: rgba(74,222,128,0.15); color: var(--green); }
  .tag-yellow { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .tag-red { background: rgba(248,113,113,0.15); color: var(--red); }
  .tag-orange { background: rgba(251,146,60,0.15); color: var(--orange); }

  .status-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    display: inline-block;
  }
  .status-active { background: var(--green); }
  .status-planning { background: var(--yellow); }
  .status-blocked { background: var(--red); }
  .status-idea { background: var(--accent); }

  /* Stat Cards */
  .stat-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
  }
  .stat-card .label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-card .value { font-size: 28px; font-weight: 700; margin-top: 4px; }
  .stat-card .sub { font-size: 12px; color: var(--text-dim); margin-top: 2px; }

  /* Discussion Thread */
  .thread {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 12px;
    overflow: hidden;
  }
  .thread-header {
    padding: 16px 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .thread-header:hover { background: var(--surface2); }
  .thread-title { font-weight: 600; font-size: 14px; flex: 1; }
  .thread-date { font-size: 12px; color: var(--text-dim); }
  .thread-body {
    padding: 0 20px 16px;
    font-size: 13px;
    color: var(--text-dim);
    line-height: 1.7;
    display: none;
  }
  .thread.open .thread-body { display: block; }
  .thread-toggle { color: var(--text-dim); font-size: 12px; transition: transform 0.2s; }
  .thread.open .thread-toggle { transform: rotate(90deg); }

  /* Tasks */
  .task-list { list-style: none; }
  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
  }
  .task-item:last-child { border-bottom: none; }
  .task-check {
    width: 18px; height: 18px;
    border: 2px solid var(--border);
    border-radius: 4px;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .task-check:hover { border-color: var(--accent); }
  .task-check.done { background: var(--green); border-color: var(--green); }
  .task-check.done::after { content: "‚úì"; color: #000; font-size: 12px; font-weight: 700; }
  .task-content { flex: 1; }
  .task-content.done { text-decoration: line-through; color: var(--text-dim); }
  .task-meta { font-size: 11px; color: var(--text-dim); margin-top: 2px; }
  .task-priority {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .priority-high { background: rgba(248,113,113,0.15); color: var(--red); }
  .priority-medium { background: rgba(251,191,36,0.15); color: var(--yellow); }
  .priority-low { background: rgba(74,158,255,0.15); color: var(--accent); }

  /* Quick Add */
  .quick-add {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .quick-add input, .quick-add select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    color: var(--text);
    font-size: 13px;
    outline: none;
  }
  .quick-add input { flex: 1; }
  .quick-add input:focus { border-color: var(--accent); }
  .quick-add select { width: 120px; }
  .quick-add button {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
  }
  .quick-add button:hover { opacity: 0.9; }

  /* Notes */
  .note-editor {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .note-editor textarea {
    width: 100%;
    min-height: 120px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    outline: none;
  }
  .note-editor textarea:focus { border-color: var(--accent); }
  .note-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }
  .btn {
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface2);
    color: var(--text);
  }
  .btn:hover { border-color: var(--accent); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Timeline */
  .timeline { position: relative; padding-left: 24px; }
  .timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border);
  }
  .timeline-item {
    position: relative;
    padding-bottom: 24px;
  }
  .timeline-item::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 4px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--accent);
    border: 2px solid var(--bg);
  }
  .timeline-date { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
  .timeline-content { font-size: 13px; line-height: 1.6; }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .filter-btn {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-dim);
  }
  .filter-btn:hover, .filter-btn.active {
    border-color: var(--accent);
    color: var(--text);
  }

  /* Kanban */
  .kanban {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding-bottom: 16px;
    min-height: 500px;
  }
  .kanban-column {
    min-width: 280px;
    width: 280px;
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 160px);
  }
  .kanban-column-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    font-weight: 600;
    flex-shrink: 0;
  }
  .kanban-column-header .count {
    background: var(--surface2);
    color: var(--text-dim);
    font-size: 11px;
    padding: 2px 7px;
    border-radius: 10px;
    font-weight: 500;
  }
  .kanban-cards {
    padding: 12px;
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .kanban-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    cursor: grab;
    transition: all 0.15s;
  }
  .kanban-card:hover { border-color: var(--accent); transform: translateY(-1px); }
  .kanban-card.dragging { opacity: 0.5; }
  .kanban-card-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; }
  .kanban-card-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; margin-bottom: 10px; }
  .kanban-card-footer { display: flex; gap: 4px; flex-wrap: wrap; }
  .kanban-card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; }
  .kanban-card-date { font-size: 10px; color: var(--text-dim); }
  .kanban-card-tasks { font-size: 10px; color: var(--text-dim); }
  .column-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .dot-idea { background: var(--accent); }
  .dot-planning { background: var(--yellow); }
  .dot-active { background: var(--orange); }
  .dot-review { background: var(--accent2); }
  .dot-done { background: var(--green); }
  .kanban-drop-zone {
    min-height: 40px;
    border: 2px dashed transparent;
    border-radius: 8px;
    transition: all 0.2s;
  }
  .kanban-drop-zone.over {
    border-color: var(--accent);
    background: rgba(74,158,255,0.05);
  }

  /* Jots */
  .jots-date-header {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 16px;
    letter-spacing: -0.5px;
  }
  .jots-date-header .dow { color: var(--accent); }
  .jot-input-wrap {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    align-items: flex-end;
    position: relative;
  }
  .jot-input-wrap textarea {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 16px;
    color: var(--text);
    font-size: 14px;
    outline: none;
    resize: none;
    overflow: hidden;
    min-height: 48px;
    max-height: 200px;
    font-family: inherit;
    line-height: 1.5;
  }
  .jot-input-wrap textarea:focus { border-color: var(--accent); }
  .jot-input-wrap textarea::placeholder { color: var(--text-dim); }
  .jot-attach-btn {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text-dim);
    cursor: pointer;
    padding: 12px;
    font-size: 18px;
    transition: all 0.15s;
    flex-shrink: 0;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .jot-attach-btn:hover { border-color: var(--accent); color: var(--accent); }
  .jot-images-preview { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
  .jot-images-preview .jot-img-thumb {
    width: 60px; height: 60px; border-radius: 8px; object-fit: cover; border: 1px solid var(--border);
    position: relative; cursor: pointer;
  }
  .jot-images-preview .jot-img-remove {
    position: absolute; top: -6px; right: -6px; background: var(--red); color: #fff; border: none;
    border-radius: 50%; width: 18px; height: 18px; font-size: 11px; cursor: pointer; display: flex;
    align-items: center; justify-content: center; line-height: 1;
  }
  .jot-img-wrap { position: relative; display: inline-block; }
  /* Markdown rendering in jots */
  .jot-text h2 { font-size: 15px; font-weight: 700; margin: 4px 0 2px; }
  .jot-text h3 { font-size: 14px; font-weight: 600; margin: 3px 0 2px; }
  .jot-text code {
    background: rgba(74,158,255,0.12); padding: 1px 5px; border-radius: 4px;
    font-family: 'SF Mono', 'Fira Code', monospace; font-size: 12.5px; color: var(--accent);
  }
  .jot-text pre {
    background: #1e1e2e; border: 1px solid var(--border); border-radius: 8px;
    padding: 12px; margin: 6px 0; overflow-x: auto; font-size: 12.5px; line-height: 1.5;
  }
  .jot-text pre code {
    background: none; padding: 0; color: #abb2bf; font-size: 12.5px;
  }
  .jot-text pre .kw { color: #c678dd; }
  .jot-text pre .str { color: #98c379; }
  .jot-text pre .num { color: #d19a66; }
  .jot-text pre .cmt { color: #5c6370; font-style: italic; }
  .jot-text pre .fn { color: #61afef; }
  .jot-text pre .op { color: #56b6c2; }
  .jot-text ul { margin: 4px 0 4px 18px; font-size: 14px; }
  .jot-text li { margin: 2px 0; }
  .jot-text a { color: var(--accent); text-decoration: underline; }
  .jot-text .jot-img-full { max-width: 100%; border-radius: 8px; margin: 6px 0; max-height: 300px; }
  /* Edit mode */
  .jot-edit-wrap { flex: 1; }
  .jot-edit-wrap textarea {
    width: 100%; background: var(--surface2); border: 1px solid var(--accent); border-radius: 8px;
    padding: 8px 10px; color: var(--text); font-size: 13px; font-family: inherit; resize: vertical;
    min-height: 36px; outline: none; line-height: 1.5;
  }
  /* edit actions removed ‚Äî blur/enter to save */
  .jot-text { cursor: pointer; }
  .jot-text:hover { opacity: 0.85; }
  .jot-entry {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    padding: 12px 14px;
    border-radius: 10px;
    transition: background 0.1s;
    position: relative;
  }
  .jot-entry:hover { background: var(--surface2); }
  .jot-entry .jot-check {
    width: 22px; height: 22px;
    border: 2px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    flex-shrink: 0;
    margin-top: 1px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
    -webkit-tap-highlight-color: transparent;
  }
  .jot-entry .jot-check:hover { border-color: var(--accent); }
  .jot-entry .jot-check.done { background: var(--green); border-color: var(--green); }
  .jot-entry .jot-check.done::after { content: "‚úì"; color: #000; font-size: 13px; font-weight: 700; }
  .jot-text { flex: 1; font-size: 14px; line-height: 1.5; }
  .jot-text.done { text-decoration: line-through; color: var(--text-dim); }
  .jot-text .jot-tag { color: var(--accent); font-weight: 500; }
  .jot-time { font-size: 11px; color: var(--text-dim); flex-shrink: 0; margin-top: 3px; }
  .jot-delete {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-dim);
    font-size: 14px;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.15s;
    padding: 4px 8px;
    border-radius: 4px;
  }
  .jot-entry:hover .jot-delete { opacity: 1; }
  .jot-delete:hover { color: var(--red); background: rgba(248,113,113,0.1); }

  /* Selection toolbar */
  .selection-toolbar {
    position: fixed;
    display: none;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 4px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 300;
    gap: 2px;
    align-items: center;
  }
  .selection-toolbar.visible { display: flex; }
  .sel-btn {
    background: none;
    border: none;
    color: var(--text);
    padding: 6px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 600;
    white-space: nowrap;
    transition: background 0.15s;
  }
  .sel-btn:hover { background: var(--surface2); }
  .sel-btn.sel-task { color: var(--green); }
  .sel-btn.sel-task:hover { background: rgba(74,222,128,0.12); }
  .sel-divider { width: 1px; height: 20px; background: var(--border); margin: 0 2px; }

  .jot-file-chip {
    display: inline-flex; align-items: center; gap: 6px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 4px 10px; font-size: 12px; color: var(--text);
  }
  .jot-file-link {
    display: inline-flex; align-items: center; gap: 4px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 6px; padding: 4px 10px; font-size: 12px;
    color: var(--accent); text-decoration: none; margin-top: 6px; margin-right: 6px;
  }
  .jot-file-link:hover { border-color: var(--accent); }
  .jot-files { margin-top: 8px; }
  .jot-day-section { margin-top: 16px; }
  .jot-day-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-dim);
    -webkit-tap-highlight-color: transparent;
  }
  .jot-day-header:hover { color: var(--text); }
  .jot-day-toggle { font-size: 10px; transition: transform 0.2s; }
  .jot-day-header.open .jot-day-toggle { transform: rotate(90deg); }
  .jot-day-entries { display: none; }
  .jot-day-header.open + .jot-day-entries { display: block; }

  @media (max-width: 768px) {
    .jot-delete { opacity: 0.6; }
    .jot-entry .jot-check { width: 28px; height: 28px; }
    .jot-entry .jot-check.done::after { font-size: 16px; }
    .jot-entry { padding: 14px 12px; }
  }

  /* Mobile Nav */
  .mobile-nav {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--surface);
    border-top: 1px solid var(--border);
    padding: 8px 0 env(safe-area-inset-bottom, 8px);
    z-index: 100;
    justify-content: space-around;
  }
  .mobile-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 10px;
    color: var(--text-dim);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .mobile-nav-item .icon { font-size: 20px; }
  .mobile-nav-item.active { color: var(--accent); }

  /* Responsive */
  @media (max-width: 768px) {
    .sidebar { display: none; }
    .mobile-nav { display: flex; }
    .main { padding: 16px; padding-bottom: 80px; }
    .card-grid { grid-template-columns: 1fr; }
    .stat-row { grid-template-columns: 1fr 1fr; }
    .kanban { flex-direction: column; min-height: auto; gap: 12px; }
    .kanban-column { width: 100%; min-width: 100%; max-height: none; }
    .kanban-card { cursor: pointer; }
    .quick-add { flex-wrap: wrap; }
    .quick-add input { min-width: 100%; }
    .quick-add select { flex: 1; }
  }
</style>
</head>
<body>
<!-- Login Screen -->
<div id="login-screen" style="display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg);">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:320px;text-align:center;">
    <div style="font-size:32px;margin-bottom:8px;">ü§ñ</div>
    <h2 style="font-size:20px;margin-bottom:4px;">K-2 HQ</h2>
    <p style="color:var(--text-dim);font-size:13px;margin-bottom:24px;">Enter access code</p>
    <input type="password" id="login-code" placeholder="Access code" 
      style="width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;text-align:center;outline:none;margin-bottom:12px;"
      onkeydown="if(event.key==='Enter')checkLogin()">
    <div id="token-field" style="display:none;">
      <input type="password" id="login-token" placeholder="GitHub token (first time only)" 
        style="width:100%;padding:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;text-align:center;outline:none;margin-bottom:12px;"
        onkeydown="if(event.key==='Enter')checkLogin()">
      <p style="font-size:10px;color:var(--text-dim);margin-bottom:12px;">Stored in browser session only. Never sent anywhere except GitHub API.</p>
    </div>
    <button onclick="checkLogin()" 
      style="width:100%;padding:12px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:14px;font-weight:600;cursor:pointer;">
      Enter
    </button>
    <p id="login-error" style="color:var(--red);font-size:12px;margin-top:12px;display:none;">Wrong code. Try again.</p>
  </div>
</div>
<script>
  const ACCESS_HASH = "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"; // SHA-256 of "123"
  async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
  }
  async function checkLogin() {
    const code = document.getElementById('login-code').value;
    const hash = await sha256(code);
    if (hash !== ACCESS_HASH) {
      document.getElementById('login-error').style.display = 'block';
      document.getElementById('login-code').value = '';
      return;
    }
    // Check if we have a token already
    let token = localStorage.getItem('gh_token');
    const tokenInput = document.getElementById('login-token');
    if (!token && tokenInput.value) {
      token = tokenInput.value.trim();
    }
    if (!token) {
      // Show token field
      document.getElementById('token-field').style.display = 'block';
      document.getElementById('login-token').focus();
      if (!tokenInput.value) return;
    }
    localStorage.setItem('k2auth', 'true');
    localStorage.setItem('gh_token', token);
    GH_TOKEN = token;
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-main').style.display = 'flex';
    loadData();
  }
  // Auto-login if already authed this session
  if (localStorage.getItem('k2auth') === 'true' && localStorage.getItem('gh_token')) {
    document.getElementById('login-screen').style.display = 'none';
  }
</script>

<div class="app" id="app-main" style="display:none;">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>ü§ñ <span>K-2</span> HQ</h1>
      <p>Command Center</p>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Overview</div>
      <div class="nav-item" data-page="dashboard">
        <span class="icon">üìä</span> Dashboard
      </div>
      <!-- Viking AI Insights lives in Notes page -->
    </div>
    <div class="nav-section">
      <div class="nav-item active" data-page="jots">
        <span class="icon">‚úèÔ∏è</span> Jots
      </div>
      <div class="nav-section-title">Work</div>
      <div class="nav-item" data-page="projects">
        <span class="icon">üöÄ</span> Projects
        <span class="badge" id="project-count">0</span>
      </div>
      <div class="nav-item" data-page="tasks">
        <span class="icon">‚úÖ</span> Tasks
        <span class="badge" id="task-count">0</span>
      </div>
      <div class="nav-item" data-page="discussions">
        <span class="icon">üí¨</span> Discussions
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-section-title">Reference</div>
      <div class="nav-item" data-page="decisions">
        <span class="icon">‚öñÔ∏è</span> Decisions
      </div>
      <div class="nav-item" data-page="notes">
        <span class="icon">üìù</span> Notes
      </div>
    </div>
    <div class="sidebar-footer">
      Last synced: <span id="last-sync">just now</span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main">

    <!-- Dashboard Page -->
    <div class="page" id="page-dashboard">
      <div class="page-header">
        <h2>Dashboard</h2>
        <p>Overview of active work and recent activity</p>
      </div>

      <div class="stat-row" id="stats-row">
        <!-- Populated by JS -->
      </div>

      <h3 style="font-size:16px; margin-bottom:12px;">Active Projects</h3>
      <div class="card-grid" id="dashboard-projects">
        <!-- Populated by JS -->
      </div>

      <div id="inbox-alert" style="display:none;background:rgba(74,158,255,0.1);border:1px solid var(--accent);border-radius:12px;padding:16px;margin-bottom:24px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:20px;">üì®</span>
          <div>
            <div style="font-size:14px;font-weight:600;">Pending messages for K-2</div>
            <div id="inbox-count" style="font-size:12px;color:var(--text-dim);"></div>
          </div>
        </div>
      </div>

      <div id="dashboard-jots-card" class="card" style="margin-bottom:24px;display:none;cursor:pointer;" onclick="navigateTo('jots')">
        <div class="card-header">
          <span class="card-title">‚úèÔ∏è Today's Jots</span>
          <span style="font-size:12px;color:var(--accent);font-weight:500;">View all ‚Üí</span>
        </div>
        <div class="card-body" id="dashboard-jots-entries"></div>
      </div>

      <h3 style="font-size:16px; margin-bottom:12px;">Recent Activity</h3>
      <div class="timeline" id="dashboard-timeline">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Jots Page -->
    <div class="page active" id="page-jots">
      <div class="page-header">
        <div class="jots-date-header" id="jots-today-date"></div>
        <p>Quick capture ‚Äî type and hit enter</p>
      </div>
      <div style="margin-bottom:12px;">
        <input type="text" id="jot-search" placeholder="üîç Search jots... (text, #tags)" oninput="filterJots()" style="width:100%;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:13px;outline:none;transition:border-color 0.2s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div id="jot-images-preview" class="jot-images-preview"></div>
      <div class="jot-input-wrap" id="jot-drop-zone">
        <textarea id="jot-input" rows="1" placeholder="What's on your mind? Use #tags, [] for checkboxes, **bold**, *italic*..." onkeydown="handleJotKeydown(event)" oninput="autoExpandTextarea(this)"></textarea>
        <input type="file" id="jot-file-input" accept="*/*" multiple style="display:none" onchange="handleJotFileAttach(event)">
        <button class="jot-attach-btn" onclick="document.getElementById('jot-file-input').click()" title="Attach file">üìé</button>
        <div id="jot-drop-overlay" style="display:none;position:absolute;inset:0;background:rgba(74,158,255,0.12);border:2px dashed var(--accent);border-radius:12px;z-index:10;pointer-events:none;align-items:center;justify-content:center;">
          <span style="color:var(--accent);font-weight:600;font-size:14px;">Drop files here</span>
        </div>
      </div>
      <div id="jots-today-entries"></div>
      <div id="jots-previous-days"></div>
    </div>

    <!-- Projects Page (Kanban) -->
    <div class="page" id="page-projects">
      <div class="page-header">
        <h2>Projects</h2>
        <p>Drag cards between columns to update status</p>
      </div>
      <div class="kanban" id="kanban-board">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Tasks Page -->
    <div class="page" id="page-tasks">
      <div class="page-header">
        <h2>Tasks</h2>
        <p>Things to get done</p>
      </div>
      <div class="quick-add">
        <input type="text" id="new-task-input" placeholder="Add a task..." onkeydown="if(event.key==='Enter')addTask()">
        <select id="new-task-priority">
          <option value="medium">Medium</option>
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
        <select id="new-task-project">
          <option value="">No Project</option>
        </select>
        <button onclick="addTask()">Add</button>
      </div>
      <div class="filter-bar">
        <button class="filter-btn active" data-filter="my" data-group="tasks">üë§ My Tasks</button>
        <button class="filter-btn" data-filter="k2" data-group="tasks">ü§ñ K-2's Tasks</button>
        <button class="filter-btn" data-filter="all" data-group="tasks">All</button>
        <button class="filter-btn" data-filter="done" data-group="tasks">Done</button>
      </div>
      <div class="card">
        <ul class="task-list" id="task-list">
          <!-- Populated by JS -->
        </ul>
      </div>
    </div>

    <!-- Discussions Page -->
    <div class="page" id="page-discussions">
      <div class="page-header">
        <h2>Discussions</h2>
        <p>Key conversations and their context</p>
      </div>
      <div id="discussions-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Decisions Page -->
    <div class="page" id="page-decisions">
      <div class="page-header">
        <h2>Decisions</h2>
        <p>Choices made and their rationale</p>
      </div>
      <div id="decisions-timeline" class="timeline">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Notes Page -->
    <div class="page" id="page-notes">
      <div class="page-header">
        <h2>Notes</h2>
        <p>Think out loud ‚Äî K-2 weighs in with analysis, ideas & pushback</p>
      </div>

      <!-- Viking AI Insights Section -->
      <div id="notes-insights-section" style="margin-bottom:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="font-size:15px;font-weight:700;color:var(--accent);margin:0;">üöÄ Viking AI Insights</h3>
          <span id="notes-insights-count" style="font-size:11px;color:var(--text-dim);"></span>
        </div>
        <div class="filter-bar" id="notes-insights-filters" style="margin-bottom:12px;">
          <button class="filter-btn active" data-filter="all" data-group="notes-insights">All</button>
          <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
          <button class="filter-btn" data-filter="New" data-group="notes-insights">New</button>
          <button class="filter-btn" data-filter="Reviewed" data-group="notes-insights">Reviewed</button>
          <button class="filter-btn" data-filter="In Progress" data-group="notes-insights">In Progress</button>
          <button class="filter-btn" data-filter="Done" data-group="notes-insights">Done</button>
          <div style="width:1px;height:20px;background:var(--border);margin:0 4px;"></div>
          <button class="filter-btn" data-filter="High" data-group="notes-insights">High</button>
          <button class="filter-btn" data-filter="Medium" data-group="notes-insights">Med</button>
        </div>
        <div id="notes-insights-grid" class="card-grid">
          <!-- Populated by JS -->
        </div>
      </div>

      <div style="border-top:1px solid var(--border);padding-top:16px;">
        <h3 style="font-size:15px;font-weight:700;color:var(--text);margin:0 0 12px 0;">üìù Notes</h3>
        <div class="note-editor">
          <textarea id="note-input" placeholder="Think out loud... K-2 will weigh in with analysis, ideas, and feedback"></textarea>
          <div class="note-actions">
            <button class="btn btn-primary" onclick="addNote()">Save Note</button>
          </div>
        </div>
        <div id="notes-list">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

  </div>

  <!-- AI Insight Detail Modal -->
  <div id="ai-insight-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeAIInsightModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:600px;margin:40px auto;padding:24px;position:relative;">
      <button onclick="closeAIInsightModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">‚úï</button>
      <div id="ai-insight-modal-content"></div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div id="task-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeTaskModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;margin:40px auto;display:flex;flex-direction:column;max-height:calc(100vh - 80px);position:relative;">
      <button onclick="closeTaskModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;z-index:1;">‚úï</button>
      <div id="task-modal-content" style="padding:24px;overflow-y:auto;flex:1;"></div>
      <div id="task-modal-input" style="padding:12px 24px 24px;border-top:1px solid var(--border);flex-shrink:0;">
        <div style="display:flex;gap:8px;">
          <input type="text" id="task-msg-input" placeholder="Message or instruction for K-2..." 
            style="flex:1;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;outline:none;"
            onkeydown="if(event.key==='Enter')sendTaskMessage()">
          <button onclick="sendTaskMessage()" style="padding:10px 16px;background:var(--accent);border:none;border-radius:8px;color:#fff;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;">Send to K-2</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Project Detail Modal -->
  <div id="project-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:200;padding:16px;overflow-y:auto;-webkit-overflow-scrolling:touch;" onclick="if(event.target===this)closeProjectModal()">
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;max-width:500px;margin:40px auto;padding:24px;position:relative;">
      <button onclick="closeProjectModal()" style="position:absolute;top:12px;right:16px;background:none;border:none;color:var(--text-dim);font-size:20px;cursor:pointer;">‚úï</button>
      <div id="modal-content"></div>
    </div>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="mobile-nav" id="mobile-nav">
    <div class="mobile-nav-item" data-page="dashboard" onclick="navigateTo('dashboard');setMobileActive(this)">
      <span class="icon">üìä</span>Home
    </div>
    <!-- Viking Insights removed from mobile nav -->
    <div class="mobile-nav-item active" data-page="jots" onclick="navigateTo('jots');setMobileActive(this)">
      <span class="icon">‚úèÔ∏è</span>Jots
    </div>
    <div class="mobile-nav-item" data-page="projects" onclick="navigateTo('projects');setMobileActive(this)">
      <span class="icon">üöÄ</span>Projects
    </div>
    <div class="mobile-nav-item" data-page="tasks" onclick="navigateTo('tasks');setMobileActive(this)">
      <span class="icon">‚úÖ</span>Tasks
    </div>
    <div class="mobile-nav-item" data-page="discussions" onclick="navigateTo('discussions');setMobileActive(this)">
      <span class="icon">üí¨</span>Chats
    </div>
  </div>
</div>

<script>
function setMobileActive(el) {
  document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
}

// ============================================================
// DATA STORE ‚Äî loaded from server, synced on every change
// ============================================================

let DATA = { projects: [], discussions: [], tasks: [], decisions: [], notes: [], timeline: [], jots: [], commands: [], vikingInsights: [] };

// ============================================================
// APP LOGIC
// ============================================================

// GitHub API Config
// Data stored in a PRIVATE repo (RyanSandoval/k2-data) ‚Äî never in the public repo
const DATA_REPO = 'RyanSandoval/k2-data';
const DATA_FILE = 'data.json';
let GH_TOKEN = localStorage.getItem('gh_token') || '';
let GH_SHA = '';

function ghHeaders() {
  return {
    'Authorization': `token ${GH_TOKEN}`,
    'Accept': 'application/vnd.github.v3+json',
    'Content-Type': 'application/json'
  };
}

async function loadData() {
  if (!GH_TOKEN) return;
  try {
    const res = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/${DATA_FILE}`, {
      headers: ghHeaders()
    });
    if (res.status === 404) {
      // First run ‚Äî create the file
      await saveData();
      return;
    }
    if (!res.ok) throw new Error(`GitHub API ${res.status}`);
    const file = await res.json();
    GH_SHA = file.sha;
    const d = JSON.parse(new TextDecoder().decode(Uint8Array.from(atob(file.content.replace(/\n/g, '')), c => c.charCodeAt(0))));
    DATA.projects = d.projects || [];
    DATA.discussions = d.discussions || [];
    DATA.tasks = d.tasks || [];
    DATA.decisions = d.decisions || [];
    DATA.notes = d.notes || [];
    DATA.timeline = d.timeline || [];
    DATA.inbox = d.inbox || [];
    DATA.jots = d.jots || [];
    DATA.commands = d.commands || [];
    DATA.vikingInsights = d.vikingInsights || [];
    renderAll();
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
  } catch(e) {
    console.error('Failed to load data:', e);
  }
}

async function saveData() {
  if (!GH_TOKEN) return;
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(DATA, null, 2))));
    const body = {
      message: `Data update ${new Date().toISOString()}`,
      content: content
    };
    if (GH_SHA) body.sha = GH_SHA;
    const res = await fetch(`https://api.github.com/repos/${DATA_REPO}/contents/${DATA_FILE}`, {
      method: 'PUT',
      headers: ghHeaders(),
      body: JSON.stringify(body)
    });
    if (!res.ok) {
      if (res.status === 409) { await loadData(); return; }
      throw new Error(`GitHub API ${res.status}`);
    }
    const result = await res.json();
    GH_SHA = result.content.sha;
    document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
  } catch(e) {
    console.error('Failed to save data:', e);
  }
}

function renderAll() {
  renderDashboard();
  renderProjects();
  renderTasks();
  renderDiscussions();
  renderDecisions();
  renderNotes();
  renderJots();
  renderAIInsights();
}

// Navigation
function navigateTo(page) {
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  const navItem = document.querySelector(`.nav-item[data-page="${page}"]`);
  if (navItem) navItem.classList.add('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  // Sync mobile nav
  document.querySelectorAll('.mobile-nav-item').forEach(i => {
    i.classList.toggle('active', i.dataset.page === page);
  });
  // Scroll to top
  document.querySelector('.main').scrollTop = 0;
  // Auto-focus jots input
  if (page === 'jots') {
    setTimeout(() => document.getElementById('jot-input')?.focus(), 100);
  }
}

document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => navigateTo(item.dataset.page));
});

// Render Dashboard
function renderDashboard() {
  console.log('[K2 Debug] renderDashboard called, DATA.projects:', DATA.projects.length, 'items, statuses:', DATA.projects.map(p=>p.status));
  const pendingTasks = DATA.tasks.filter(t => !t.done).length;
  const activeProjects = DATA.projects.filter(p => p.status === 'active').length;
  console.log('[K2 Debug] activeProjects:', activeProjects);
  const totalDecisions = DATA.decisions.length;
  const openQuestions = DATA.discussions.reduce((n, d) => n + (d.openQuestions || []).length, 0);

  document.getElementById('stats-row').innerHTML = `
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('projects')">
      <div class="label">Active Projects</div>
      <div class="value" style="color:var(--accent)">${activeProjects}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('tasks')">
      <div class="label">Pending Tasks</div>
      <div class="value" style="color:var(--yellow)">${pendingTasks}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('decisions')">
      <div class="label">Decisions Made</div>
      <div class="value" style="color:var(--green)">${totalDecisions}</div>
    </div>
    <div class="stat-card" style="cursor:pointer" onclick="navigateTo('discussions')">
      <div class="label">Open Questions</div>
      <div class="value" style="color:var(--orange)">${openQuestions}</div>
    </div>
  `;

  document.getElementById('dashboard-projects').innerHTML = DATA.projects.map(p => `
    <div class="card">
      <div class="card-header">
        <span class="card-title">${p.name}</span>
        <span class="status-dot status-${p.status}"></span>
      </div>
      <div class="card-body">${p.description}</div>
      <div class="card-footer">
        ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
      </div>
    </div>
  `).join('');

  const sortedTimeline = [...(DATA.timeline || [])].sort((a, b) => b.date.localeCompare(a.date));
  document.getElementById('dashboard-timeline').innerHTML = sortedTimeline.slice(0, 8).map(t => `
    <div class="timeline-item">
      <div class="timeline-date">${t.date}</div>
      <div class="timeline-content">${t.event}</div>
    </div>
  `).join('');

  // Inbox alert
  const inbox = (DATA.inbox || []).filter(m => !m.read);
  const inboxAlert = document.getElementById('inbox-alert');
  if (inboxAlert) {
    if (inbox.length > 0) {
      inboxAlert.style.display = 'block';
      document.getElementById('inbox-count').textContent = `${inbox.length} message${inbox.length > 1 ? 's' : ''} waiting`;
    } else {
      inboxAlert.style.display = 'none';
    }
  }
}

// Viking AI Insights Rendering (embedded in Notes page)
function renderAIInsights() {
  const insights = DATA.vikingInsights || [];
  
  // Update count label
  const countEl = document.getElementById('notes-insights-count');
  if (countEl) {
    const newCount = insights.filter(i => i.status === 'New').length;
    countEl.textContent = newCount > 0 ? `${newCount} new ¬∑ ${insights.length} total` : `${insights.length} total`;
  }

  // Hide section if no insights
  const section = document.getElementById('notes-insights-section');
  if (section) section.style.display = insights.length > 0 ? 'block' : 'none';

  renderFilteredAIInsights();
  setupAIInsightsFilters();
}

function renderFilteredAIInsights() {
  const insights = DATA.vikingInsights || [];
  const gridContainer = document.getElementById('notes-insights-grid');
  if (!gridContainer) return;

  const activeFilters = Array.from(document.querySelectorAll('#notes-insights-filters .filter-btn.active'))
    .map(btn => btn.dataset.filter)
    .filter(f => f !== 'all');

  let filteredInsights = insights;

  if (activeFilters.length > 0) {
    filteredInsights = insights.filter(insight => {
      return activeFilters.some(filter => 
        insight.category === filter || 
        insight.impact === filter || 
        insight.status === filter
      );
    });
  }

  // Sort by most recently updated (dateUpdated or dateAdded), newest first
  filteredInsights = [...filteredInsights].sort((a, b) => {
    const aDate = a.dateUpdated || a.dateAdded || '';
    const bDate = b.dateUpdated || b.dateAdded || '';
    return bDate.localeCompare(aDate);
  });

  gridContainer.innerHTML = filteredInsights.map(insight => {
    const impactColor = insight.impact === 'High' ? 'var(--red)' : 
                       insight.impact === 'Medium' ? 'var(--yellow)' : 'var(--green)';
    const statusColor = insight.status === 'New' ? 'var(--accent)' :
                       insight.status === 'Reviewed' ? 'var(--accent2)' :
                       insight.status === 'In Progress' ? 'var(--yellow)' :
                       insight.status === 'Done' ? 'var(--green)' : 'var(--text-dim)';

    return `
      <div class="card" style="cursor:pointer;" onclick="openAIInsightModal('${insight.id}')">
        <div class="card-header">
          <span class="card-title">${insight.title}</span>
          <div style="display:flex;gap:4px;align-items:center;">
            <span style="font-size:11px;font-weight:600;color:${impactColor};">P${insight.priority}</span>
          </div>
        </div>
        <div class="card-body">${insight.description}</div>
        <div class="card-footer" style="display:flex;justify-content:space-between;align-items:center;">
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <span class="tag tag-blue">${insight.category}</span>
            <span class="tag" style="background:rgba(${impactColor === 'var(--red)' ? '248,113,113' : impactColor === 'var(--yellow)' ? '251,191,36' : '74,222,128'},0.15);color:${impactColor};">${insight.impact}</span>
            <span class="tag" style="background:rgba(${statusColor === 'var(--accent)' ? '74,158,255' : statusColor === 'var(--accent2)' ? '124,92,255' : statusColor === 'var(--yellow)' ? '251,191,36' : statusColor === 'var(--green)' ? '74,222,128' : '136,136,160'},0.15);color:${statusColor};">${insight.status}</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);">${insight.dateAdded}</div>
        </div>
      </div>
    `;
  }).join('');
}

function setupAIInsightsFilters() {
  document.querySelectorAll('#notes-insights-filters .filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = btn.dataset.filter;
      
      if (filter === 'all') {
        document.querySelectorAll('#notes-insights-filters .filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      } else {
        document.querySelector('#notes-insights-filters .filter-btn[data-filter="all"]')?.classList.remove('active');
        btn.classList.toggle('active');
        // If nothing active, re-activate "all"
        const anyActive = document.querySelectorAll('#notes-insights-filters .filter-btn.active').length;
        if (!anyActive) document.querySelector('#notes-insights-filters .filter-btn[data-filter="all"]').classList.add('active');
      }
      
      renderFilteredAIInsights();
    });
  });
}

function openAIInsightModal(insightId) {
  const insight = DATA.vikingInsights.find(i => i.id === insightId);
  if (!insight) return;

  const modalContent = document.getElementById('ai-insight-modal-content');
  if (!modalContent) return;

  const impactColor = insight.impact === 'High' ? 'var(--red)' : 
                     insight.impact === 'Medium' ? 'var(--yellow)' : 'var(--green)';
  const statusColor = insight.status === 'New' ? 'var(--accent)' :
                     insight.status === 'Reviewed' ? 'var(--accent2)' :
                     insight.status === 'In Progress' ? 'var(--yellow)' :
                     insight.status === 'Done' ? 'var(--green)' : 'var(--text-dim)';

  modalContent.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;">
      <h3 style="font-size:18px;font-weight:700;flex:1;margin-right:16px;">${insight.title}</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <span style="font-size:12px;font-weight:600;color:${impactColor};">P${insight.priority}</span>
      </div>
    </div>

    <p style="font-size:14px;color:var(--text-dim);line-height:1.6;margin-bottom:20px;">${insight.description}</p>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
      <div>
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Category</div>
        <span class="tag tag-blue">${insight.category}</span>
      </div>
      <div>
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Impact</div>
        <span class="tag" style="background:rgba(${impactColor === 'var(--red)' ? '248,113,113' : impactColor === 'var(--yellow)' ? '251,191,36' : '74,222,128'},0.15);color:${impactColor};">${insight.impact}</span>
      </div>
    </div>

    <div style="margin-bottom:20px;">
      <label style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:8px;">Status</label>
      <select onchange="updateAIInsightStatus('${insight.id}', this.value)" style="width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
        <option value="New" ${insight.status === 'New' ? 'selected' : ''}>New</option>
        <option value="Reviewed" ${insight.status === 'Reviewed' ? 'selected' : ''}>Reviewed</option>
        <option value="In Progress" ${insight.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
        <option value="Done" ${insight.status === 'Done' ? 'selected' : ''}>Done</option>
        <option value="Dismissed" ${insight.status === 'Dismissed' ? 'selected' : ''}>Dismissed</option>
      </select>
    </div>

    ${insight.competitors ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;">Competitive Context</div>
        <div style="font-size:13px;color:var(--text);background:var(--surface2);padding:12px;border-radius:8px;border-left:3px solid var(--orange);">${insight.competitors}</div>
      </div>
    ` : ''}

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
      ${(insight.tags || []).map(tag => `<span class="tag tag-purple">${tag}</span>`).join('')}
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;font-size:12px;color:var(--text-dim);border-top:1px solid var(--border);padding-top:12px;">
      <div>Source: ${insight.source}</div>
      <div>Added: ${insight.dateAdded}</div>
    </div>
  `;

  document.getElementById('ai-insight-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeAIInsightModal() {
  document.getElementById('ai-insight-modal').style.display = 'none';
  document.body.style.overflow = '';
}

async function updateAIInsightStatus(insightId, newStatus) {
  const insight = DATA.vikingInsights.find(i => i.id === insightId);
  if (!insight) return;

  insight.status = newStatus;
  insight.dateUpdated = new Date().toISOString().slice(0, 10);
  await saveData();
  renderAIInsights();
  
  // Re-open modal to show updated status
  setTimeout(() => openAIInsightModal(insightId), 100);
}

// Kanban columns config
const KANBAN_COLUMNS = [
  { id: 'idea', label: 'Ideas', dot: 'dot-idea' },
  { id: 'planning', label: 'Planning', dot: 'dot-planning' },
  { id: 'active', label: 'In Progress', dot: 'dot-active' },
  { id: 'review', label: 'Review', dot: 'dot-review' },
  { id: 'done', label: 'Done', dot: 'dot-done' }
];

function renderProjects() {
  // Update sidebar badge
  const activeCount = DATA.projects.filter(p => p.status !== 'done').length;
  const projBadge = document.getElementById('project-count');
  if (projBadge) {
    projBadge.textContent = activeCount;
    projBadge.style.display = activeCount > 0 ? 'inline' : 'none';
  }

  const board = document.getElementById('kanban-board');
  board.innerHTML = KANBAN_COLUMNS.map(col => {
    const projects = DATA.projects.filter(p => p.status === col.id);
    const taskCounts = projects.map(p => {
      const total = DATA.tasks.filter(t => t.project === p.id).length;
      const done = DATA.tasks.filter(t => t.project === p.id && t.done).length;
      return { total, done };
    });

    return `
      <div class="kanban-column" data-column="${col.id}"
           ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${col.id}')">
        <div class="kanban-column-header">
          <span class="column-dot ${col.dot}"></span>
          ${col.label}
          <span class="count">${projects.length}</span>
        </div>
        <div class="kanban-cards">
          ${projects.map((p, i) => `
            <div class="kanban-card" draggable="true" data-project-id="${p.id}"
                 ondragstart="onDragStart(event, '${p.id}')" ondragend="onDragEnd(event)"
                 onclick="openProjectModal('${p.id}')">
              <div class="kanban-card-title">${p.name}</div>
              <div class="kanban-card-desc">${p.description}</div>
              ${(p.nextSteps||[]).length ? `
                <div style="font-size:11px;color:var(--text);margin-bottom:8px;">
                  <strong>Next:</strong> <span style="color:var(--text-dim)">${typeof (p.nextSteps||[])[0] === 'string' ? (p.nextSteps||[])[0] : (p.nextSteps||[])[0].text}</span>
                  ${(p.nextSteps||[]).length > 1 ? `<span style="color:var(--text-dim);font-style:italic"> +${(p.nextSteps||[]).length - 1} more</span>` : ''}
                </div>
              ` : ''}
              <div class="kanban-card-footer">
                ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
              </div>
              <div class="kanban-card-meta">
                <span class="kanban-card-date">Since ${p.started}</span>
                ${taskCounts[i].total > 0 ? `
                  <span class="kanban-card-tasks">‚úÖ ${taskCounts[i].done}/${taskCounts[i].total}</span>
                ` : ''}
              </div>
            </div>
          `).join('')}
          <div class="kanban-drop-zone" ondragover="onDragOver(event)" ondragleave="onDragLeave(event)" ondrop="onDrop(event, '${col.id}')"></div>
        </div>
      </div>
    `;
  }).join('');
}

// Task Detail Modal
let activeTaskId = null;

function openTaskModal(taskId) {
  activeTaskId = taskId;
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  if (!task.messages) task.messages = [];
  
  const project = DATA.projects.find(p => p.id === task.project);
  const projectName = project ? project.name : 'General';
  const projectGoal = project ? project.goal : '';
  const ownerBadge = task.owner === 'k2' ? 'ü§ñ' : 'üë§';
  const ownerLabel = task.owner === 'k2' ? 'K-2' : 'Ryan';
  const priorityCycle = { high: 'medium', medium: 'low', low: 'high' };

  document.getElementById('task-modal-content').innerHTML = `
    <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:16px;">
      <div class="task-check ${task.done ? 'done' : ''}" onclick="toggleTask(${JSON.stringify(task.id)});openTaskModal(${JSON.stringify(task.id)})" style="margin-top:2px;flex-shrink:0;"></div>
      <div style="flex:1;">
        <h3 style="font-size:16px;font-weight:700;cursor:pointer;${task.done ? 'text-decoration:line-through;color:var(--text-dim)' : ''}" onclick="editTaskField(${JSON.stringify(task.id)},'text',this)" title="Click to edit">${task.text || task.title || 'Untitled'}</h3>
        <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;align-items:center;">
          <span style="cursor:pointer;font-size:14px;background:var(--surface2);padding:2px 8px;border-radius:6px;border:1px solid var(--border);" onclick="cycleTaskOwner(${JSON.stringify(task.id)})" title="Click to reassign">${ownerBadge} ${ownerLabel}</span>
          <span class="tag tag-blue">${projectName}</span>
          <span class="task-priority priority-${task.priority}" style="cursor:pointer;" onclick="cycleTaskPriority(${JSON.stringify(task.id)})" title="Click to cycle priority">${task.priority}</span>
          <span class="tag tag-purple">${task.created}</span>
        </div>
      </div>
    </div>

    ${task.context ? `
    <div style="margin-bottom:12px;background:var(--surface2);border-radius:8px;padding:10px 12px;border-left:3px solid var(--accent2);cursor:pointer;" onclick="editTaskField(${JSON.stringify(task.id)},'context',this.querySelector('.ctx-text'))" title="Click to edit context">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--accent2);font-weight:600;margin-bottom:4px;">Context</div>
      <div class="ctx-text" style="font-size:12px;color:var(--text-dim);line-height:1.5;">${task.context}</div>
    </div>
    ` : `
    <div style="margin-bottom:12px;font-size:12px;color:var(--text-dim);cursor:pointer;padding:8px;border:1px dashed var(--border);border-radius:8px;text-align:center;" onclick="editTaskField(${JSON.stringify(task.id)},'context',this)">+ Add context</div>
    `}

    ${projectGoal ? `
    <div style="margin-bottom:12px;background:var(--surface2);border-radius:8px;padding:10px 12px;border-left:3px solid var(--green);">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--green);font-weight:600;margin-bottom:4px;">üéØ Project Goal ‚Äî ${projectName}</div>
      <div style="font-size:12px;color:var(--text-dim);line-height:1.5;">${projectGoal}</div>
    </div>
    ` : ''}

    ${task.owner === 'k2' && !task.done ? `
    <div style="margin-bottom:12px;">
      <button onclick="queueTaskForK2(${JSON.stringify(task.id)})" style="width:100%;padding:10px;background:var(--green);border:none;border-radius:8px;color:#000;font-size:13px;font-weight:600;cursor:pointer;">‚ñ∂ Queue for K-2</button>
    </div>
    ` : ''}

    <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:var(--text-dim);">Thread</div>
    <div id="task-thread" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;">
      ${task.messages.length === 0 ? 
        '<div style="font-size:12px;color:var(--text-dim);padding:16px;text-align:center;background:var(--surface2);border-radius:8px;">No messages yet. Send an instruction or update below.</div>' :
        task.messages.map(m => `
          <div style="display:flex;gap:10px;padding:10px 12px;background:var(--surface2);border-radius:8px;${m.from === 'k2' ? 'border-left:3px solid var(--accent)' : 'border-left:3px solid var(--green)'};">
            <div style="flex-shrink:0;font-size:14px;">${m.from === 'k2' ? 'ü§ñ' : 'üë§'}</div>
            <div style="flex:1;">
              <div style="font-size:11px;color:var(--text-dim);margin-bottom:2px;">${m.from === 'k2' ? 'K-2' : 'Ryan'} ¬∑ ${m.time}</div>
              <div style="font-size:13px;line-height:1.5;">${m.text}</div>
            </div>
          </div>
        `).join('')
      }
    </div>
  `;

  document.getElementById('task-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
  
  // Scroll thread to bottom
  setTimeout(() => {
    const thread = document.getElementById('task-thread');
    if (thread) thread.scrollTop = thread.scrollHeight;
  }, 50);
}

function closeTaskModal() {
  document.getElementById('task-modal').style.display = 'none';
  document.body.style.overflow = '';
  activeTaskId = null;
}

async function sendTaskMessage() {
  const input = document.getElementById('task-msg-input');
  const text = input.value.trim();
  if (!text || !activeTaskId) return;

  const task = DATA.tasks.find(t => t.id === activeTaskId);
  if (!task) return;
  if (!task.messages) task.messages = [];

  const now = new Date();
  const time = now.toISOString().replace('T', ' ').slice(0, 16);

  task.messages.push({
    from: 'ryan',
    text: text,
    time: time
  });

  // Also add to inbox for K-2 to pick up
  if (!DATA.inbox) DATA.inbox = [];
  DATA.inbox.push({
    taskId: activeTaskId,
    taskText: task.text,
    message: text,
    time: time,
    read: false
  });

  input.value = '';
  await saveData();
  openTaskModal(activeTaskId); // Re-render
}

// Project Detail Modal
function openProjectModal(projectId) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p) return;
  if (!p.notes) p.notes = [];
  if (!p.goal) p.goal = '';
  const tasks = DATA.tasks.filter(t => t.project === p.id);
  const decisions = DATA.decisions.filter(d => d.project === p.id);
  const discussions = DATA.discussions.filter(d => d.project === p.id);

  const priorityColors = { high: 'var(--red)', medium: 'var(--yellow)', low: 'var(--text-dim)' };
  const priorityDots = { high: 'üî¥', medium: 'üü°', low: '‚ö™' };

  document.getElementById('modal-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
      <span class="status-dot status-${p.status}" style="width:12px;height:12px;"></span>
      <h3 style="font-size:18px;font-weight:700;">${p.name}</h3>
    </div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;" onclick="editProjectField('${p.id}','description',this)" title="Click to edit">${p.description}</p>

    <!-- Goal / Definition of Done -->
    <div style="margin-bottom:16px;background:var(--surface2);border-radius:8px;padding:12px;border-left:3px solid var(--green);">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--green);font-weight:600;margin-bottom:4px;">üéØ Goal / What Done Looks Like</div>
      <p style="font-size:13px;color:var(--text);line-height:1.6;cursor:pointer;" onclick="editProjectField('${p.id}','goal',this)" title="Click to edit">${p.goal || '<span style=color:var(--text-dim)>Click to define the goal...</span>'}</p>
    </div>

    <div style="margin-bottom:16px;">
      <label style="font-size:11px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;">Status</label>
      <select onchange="changeProjectStatus('${p.id}', this.value)" style="display:block;width:100%;margin-top:4px;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;">
        ${KANBAN_COLUMNS.map(col => `<option value="${col.id}" ${p.status === col.id ? 'selected' : ''}>${col.label}</option>`).join('')}
      </select>
    </div>

    <div style="margin-bottom:16px;">
      <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Tags</div>
      <div style="display:flex;gap:4px;flex-wrap:wrap;">
        ${(p.tags||[]).map(t => `<span class="tag tag-blue">${t}</span>`).join('')}
        <span class="tag tag-purple">Since ${p.started}</span>
      </div>
    </div>

    ${(p.nextSteps||[]).length ? `
      <div style="margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div style="font-size:12px;font-weight:600;">Next Steps</div>
          <button onclick="addNextStep('${p.id}')" style="font-size:11px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--accent);padding:4px 10px;cursor:pointer;">+ Add</button>
        </div>
        <div style="background:var(--surface2);border-radius:8px;overflow:hidden;">
          ${(p.nextSteps||[]).map((s, i) => {
            const text = typeof s === 'string' ? s : s.text;
            const pri = typeof s === 'string' ? 'medium' : (s.priority || 'medium');
            const status = (typeof s === 'object' && s.status) || 'pending';
            const statusBadge = status === 'queued' ? '<span style="font-size:10px;background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;margin-left:6px;">‚è≥ Queued</span>'
              : status === 'in-progress' ? '<span style="font-size:10px;background:var(--orange);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">üî® In Progress</span>'
              : status === 'done' ? '<span style="font-size:10px;background:var(--green);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">‚úÖ Done</span>'
              : status === 'review' ? '<span style="font-size:10px;background:var(--yellow);color:#000;padding:2px 6px;border-radius:4px;margin-left:6px;">üëÄ Review</span>'
              : '';
            const showDoIt = status === 'pending';
            const showAccept = status === 'review';
            return `
            <div style="display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border);font-size:12px;${status === 'done' ? 'opacity:0.5;' : ''}">
              <span style="cursor:pointer;font-size:14px;" onclick="cycleStepPriority('${p.id}',${i})" title="${pri} priority">${priorityDots[pri]}</span>
              <span style="flex:1;cursor:pointer;${status === 'done' ? 'text-decoration:line-through;' : ''}" onclick="editNextStep('${p.id}',${i},this)" title="Click to edit">${text}</span>
              ${statusBadge}
              ${showDoIt ? `<button onclick="queueStep('${p.id}',${i})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;" title="Send to K-2">‚ñ∂ Do it</button>` : ''}
              ${showAccept ? `
                <button onclick="acceptStep('${p.id}',${i})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;" title="Accept">üëç</button>
                <button onclick="rejectStep('${p.id}',${i})" style="background:var(--red);border:none;border-radius:6px;color:#fff;padding:4px 8px;cursor:pointer;font-size:11px;font-weight:600;" title="Reject">üëé</button>
              ` : ''}
              <button onclick="deleteStep('${p.id}',${i})" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:12px;padding:4px;" title="Delete">‚úï</button>
            </div>
            `;
          }).join('')}
        </div>
      </div>
    ` : ''}

    ${tasks.length ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Tasks (${tasks.filter(t=>!t.done).length}/${tasks.length})</div>
        <div style="max-height:120px;overflow-y:auto;background:var(--surface2);border-radius:8px;padding:8px;">
          ${tasks.map(t => `
            <div style="display:flex;align-items:center;gap:8px;padding:4px 0;font-size:12px;cursor:pointer;" onclick="openTaskModal(${t.id})">
              <div class="task-check ${t.done ? 'done' : ''}" style="width:16px;height:16px;margin-top:0;"></div>
              <span style="flex:1;${t.done ? 'text-decoration:line-through;color:var(--text-dim);' : ''}">${t.text}</span>
              <span class="task-priority priority-${t.priority}" style="font-size:9px;padding:1px 4px;">${t.priority}</span>
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    ${(p.notes||[]).length ? `
      <div style="margin-bottom:16px;">
        <div style="font-size:12px;font-weight:600;margin-bottom:8px;">Notes</div>
        <div style="background:var(--surface2);border-radius:8px;padding:12px;max-height:100px;overflow-y:auto;">
          ${(p.notes||[]).map(n => `
            <div style="font-size:12px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border);">
              <div style="color:var(--text-dim);font-size:10px;margin-bottom:2px;">${n.date} ¬∑ ${n.author}</div>
              ${n.text}
            </div>
          `).join('')}
        </div>
      </div>
    ` : ''}

    <div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);display:flex;gap:8px;">
      <button onclick="archiveProject('${p.id}')" style="flex:1;padding:8px 12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:12px;cursor:pointer;">Archive</button>
      <button onclick="deleteProject('${p.id}')" style="flex:1;padding:8px 12px;background:var(--red);border:none;border-radius:8px;color:#fff;font-size:12px;cursor:pointer;">Delete</button>
    </div>
  `;

  document.getElementById('project-modal').style.display = 'block';
  document.body.style.overflow = 'hidden';
}

function closeProjectModal() {
  document.getElementById('project-modal').style.display = 'none';
  document.body.style.overflow = '';
}

async function changeProjectStatus(projectId, newStatus) {
  const project = DATA.projects.find(p => p.id === projectId);
  if (!project) return;
  project.status = newStatus;
  await saveData();
  renderProjects();
  closeProjectModal();
}

// Drag and drop for Kanban
let draggedProjectId = null;

function onDragStart(event, projectId) {
  draggedProjectId = projectId;
  event.target.classList.add('dragging');
}

function onDragEnd(event) {
  event.target.classList.remove('dragging');
  draggedProjectId = null;
}

function onDragOver(event) {
  event.preventDefault();
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.add('over');
}

function onDragLeave(event) {
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.remove('over');
}

async function onDrop(event, newStatus) {
  event.preventDefault();
  const dropZone = event.target.closest('.kanban-column, .kanban-drop-zone');
  if (dropZone) dropZone.classList.remove('over');
  
  if (!draggedProjectId) return;
  
  const project = DATA.projects.find(p => p.id === draggedProjectId);
  if (!project || project.status === newStatus) return;
  
  project.status = newStatus;
  await saveData();
  renderProjects();
}

// Render Tasks
function renderTasks() {
  const taskContainer = document.getElementById('task-list');
  if (!taskContainer) return;

  const activeFilter = document.querySelector('.filter-btn.active[data-group="tasks"]')?.dataset.filter || 'my';
  let filteredTasks = DATA.tasks;

  if (activeFilter === 'my') {
    filteredTasks = DATA.tasks.filter(t => (!t.done && t.status !== 'done') && (t.owner === 'ryan' || !t.owner));
  } else if (activeFilter === 'k2') {
    filteredTasks = DATA.tasks.filter(t => (!t.done && t.status !== 'done') && t.owner === 'k2');
  } else if (activeFilter === 'done') {
    filteredTasks = DATA.tasks.filter(t => t.done || t.status === 'done');
  }

  taskContainer.innerHTML = filteredTasks.map(task => {
    const project = DATA.projects.find(p => p.id === task.project);
    const projectName = project ? project.name : 'General';

    const taskText = task.text || task.title || 'Untitled';
    const taskId = JSON.stringify(task.id);
    const ownerBadge = task.owner === 'k2' ? 'ü§ñ' : 'üë§';
    const doItBtn = task.owner === 'k2' && !task.done ? `<button onclick="event.stopPropagation();queueTaskForK2(${taskId})" style="background:var(--green);border:none;border-radius:6px;color:#000;padding:4px 10px;cursor:pointer;font-size:11px;font-weight:600;white-space:nowrap;margin-right:8px;" title="Queue for K-2">‚ñ∂ Do it</button>` : '';
    return `
      <li class="task-item" onclick="openTaskModal(${taskId})">
        <div class="task-check ${task.done ? 'done' : ''}" onclick="event.stopPropagation();toggleTask(${taskId})"></div>
        <div class="task-content ${task.done ? 'done' : ''}">
          <div style="display:flex;align-items:center;gap:6px;">
            <span title="${task.owner === 'k2' ? 'K-2' : 'Ryan'}">${ownerBadge}</span>
            <span>${taskText}</span>
          </div>
          ${task.context ? `<div style="font-size:11px;color:var(--text-dim);margin-top:2px;font-style:italic;opacity:0.8;">${task.context}</div>` : ''}
          <div class="task-meta">
            ${projectName} ‚Ä¢ ${task.created}${task.source === 'jot' ? ' ‚Ä¢ üìù from jot' : ''}
          </div>
        </div>
        ${doItBtn}
        <div class="task-priority priority-${task.priority}">${task.priority}</div>
      </li>
    `;
  }).join('');

  // Update badge counts
  const pendingCount = DATA.tasks.filter(t => !t.done).length;
  const badge = document.getElementById('task-count');
  if (badge) {
    badge.textContent = pendingCount;
    badge.style.display = pendingCount > 0 ? 'inline' : 'none';
  }

  // Populate project dropdown
  const projectSelect = document.getElementById('new-task-project');
  if (projectSelect) {
    projectSelect.innerHTML = '<option value="">No Project</option>' +
      DATA.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
  }
}

async function addTask() {
  const input = document.getElementById('new-task-input');
  const priority = document.getElementById('new-task-priority').value;
  const project = document.getElementById('new-task-project').value;

  const text = input.value.trim();
  if (!text) return;

  const newTask = {
    id: Date.now(),
    text: text,
    priority: priority,
    project: project,
    done: false,
    created: new Date().toISOString().slice(0, 10),
    messages: []
  };

  DATA.tasks.push(newTask);
  input.value = '';

  await saveData();
  renderTasks();
}

async function toggleTask(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;

  task.done = !task.done;

  // Sync linked jot
  if (task.linkedJotId) {
    const jot = DATA.jots.find(j => j.id === task.linkedJotId);
    if (jot) jot.done = task.done;
  }

  await saveData();
  renderTasks();
  renderJots();
}

async function queueTaskForK2(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const taskText = task.text || task.title || '';
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'execute-task',
    taskId: task.id,
    taskText: taskText,
    status: 'pending',
    created: new Date().toISOString()
  });
  await saveData();
  showToast('üöÄ Queued for K-2');
  if (activeTaskId) openTaskModal(activeTaskId);
}

async function cycleTaskOwner(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  task.owner = task.owner === 'k2' ? 'ryan' : 'k2';
  await saveData();
  renderTasks();
  openTaskModal(taskId);
}

async function cycleTaskPriority(taskId) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const cycle = { high: 'medium', medium: 'low', low: 'high' };
  task.priority = cycle[task.priority] || 'high';
  await saveData();
  renderTasks();
  openTaskModal(taskId);
}

async function editTaskField(taskId, field, el) {
  const task = DATA.tasks.find(t => t.id == taskId);
  if (!task) return;
  const currentVal = task[field] || '';
  const isTitle = field === 'text';

  const input = document.createElement(isTitle ? 'input' : 'textarea');
  if (isTitle) input.type = 'text';
  input.value = currentVal;
  input.style.cssText = `width:100%;background:var(--surface2);border:1px solid var(--accent);border-radius:8px;color:var(--text);padding:8px 10px;font-size:${isTitle ? '16px;font-weight:700' : '12px'};font-family:inherit;${isTitle ? '' : 'min-height:50px;resize:vertical;'}outline:none;`;

  const save = async () => {
    const newVal = input.value.trim();
    if (newVal !== currentVal) {
      task[field] = newVal;
      if (field === 'text' && task.title) task.title = newVal;
      await saveData();
    }
    openTaskModal(taskId);
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (isTitle || e.metaKey || e.ctrlKey)) { e.preventDefault(); save(); }
    if (e.key === 'Escape') openTaskModal(taskId);
  });
  input.addEventListener('blur', save);

  el.replaceWith(input);
  input.focus();
}

// Setup task filters
document.querySelectorAll('.filter-btn[data-group="tasks"]').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn[data-group="tasks"]').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderTasks();
  });
});

// Render Discussions
function renderDiscussions() {
  const container = document.getElementById('discussions-list');
  if (!container) return;

  container.innerHTML = DATA.discussions.map(discussion => `
    <div class="thread">
      <div class="thread-header" onclick="toggleThread(this)">
        <span class="thread-toggle">‚ñ∂</span>
        <span class="thread-title">${discussion.title}</span>
        <span class="thread-date">${discussion.date}</span>
      </div>
      <div class="thread-body">
        <p style="margin-bottom:12px;">${discussion.summary}</p>
        
        ${discussion.keyPoints && discussion.keyPoints.length ? `
          <div style="margin-bottom:12px;">
            <strong style="font-size:12px;color:var(--text);margin-bottom:4px;display:block;">Key Points:</strong>
            <ul style="margin-left:16px;">
              ${discussion.keyPoints.map(point => `<li>${point}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${discussion.openQuestions && discussion.openQuestions.length ? `
          <div style="margin-bottom:12px;">
            <strong style="font-size:12px;color:var(--orange);margin-bottom:4px;display:block;">Open Questions:</strong>
            <ul style="margin-left:16px;">
              ${discussion.openQuestions.map(q => `<li style="color:var(--orange);">${q}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${discussion.project ? `
          <div style="margin-top:12px;padding-top:8px;border-top:1px solid var(--border);">
            <span class="tag tag-blue">${DATA.projects.find(p => p.id === discussion.project)?.name || 'Unknown Project'}</span>
          </div>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function toggleThread(element) {
  const thread = element.closest('.thread');
  thread.classList.toggle('open');
}

// Render Decisions
function renderDecisions() {
  const container = document.getElementById('decisions-timeline');
  if (!container) return;

  const sortedDecisions = [...DATA.decisions].sort((a, b) => b.date.localeCompare(a.date));

  container.innerHTML = sortedDecisions.map(decision => `
    <div class="timeline-item">
      <div class="timeline-date">${decision.date}</div>
      <div class="timeline-content">
        <div style="font-weight:600;margin-bottom:4px;">${decision.decision}</div>
        <div style="font-size:12px;color:var(--text-dim);margin-bottom:8px;">${decision.rationale}</div>
        ${decision.project ? `<span class="tag tag-blue">${DATA.projects.find(p => p.id === decision.project)?.name || 'Unknown Project'}</span>` : ''}
      </div>
    </div>
  `).join('');
}

// Render Notes
function renderNotes() {
  const container = document.getElementById('notes-list');
  if (!container) return;

  const sortedNotes = [...DATA.notes].sort((a, b) => b.created.localeCompare(a.created));

  container.innerHTML = sortedNotes.map((note, idx) => {
    const noteId = note.id || idx;
    const hasResponse = note.k2Response;
    const isPending = note.k2Status === 'pending';
    
    return `
    <div class="card" style="position:relative;">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;">
        <span class="card-title">${note.created}</span>
        <div style="display:flex;gap:6px;align-items:center;">
          ${isPending ? '<span style="font-size:11px;color:var(--yellow);font-weight:600;">‚è≥ K-2 thinking...</span>' : ''}
          ${!hasResponse && !isPending ? `<button onclick="requestK2Take('${noteId}')" style="background:var(--accent);border:none;border-radius:6px;color:#fff;padding:3px 8px;cursor:pointer;font-size:11px;font-weight:600;" title="Get K-2's take">ü§ñ Get take</button>` : ''}
          <button onclick="deleteNote('${noteId}')" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:14px;" title="Delete">‚úï</button>
        </div>
      </div>
      <div class="card-body" style="cursor:pointer;" onclick="editNote('${noteId}', this)">${note.text}</div>
      ${hasResponse ? `
        <div style="margin-top:12px;padding:12px;background:rgba(74,158,255,0.08);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;">
          <div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px;">ü§ñ K-2's Take</div>
          <div style="font-size:13px;color:var(--text);line-height:1.6;">${note.k2Response}</div>
          ${note.k2RespondedAt ? `<div style="font-size:10px;color:var(--text-dim);margin-top:8px;">${note.k2RespondedAt}</div>` : ''}
        </div>
      ` : ''}
    </div>
  `}).join('');
}

async function addNote() {
  const input = document.getElementById('note-input');
  const text = input.value.trim();
  if (!text) return;

  const noteId = 'note-' + Date.now();
  const newNote = {
    id: noteId,
    text: text,
    created: new Date().toISOString().slice(0, 16).replace('T', ' '),
    k2Status: 'pending'
  };

  DATA.notes.push(newNote);

  // Queue command for K-2 to analyze
  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'analyze-note',
    noteId: noteId,
    noteText: text,
    status: 'pending',
    created: new Date().toISOString()
  });

  input.value = '';
  await saveData();
  renderNotes();
}

async function requestK2Take(noteId) {
  const note = DATA.notes.find(n => n.id === noteId || DATA.notes.indexOf(n) === parseInt(noteId));
  if (!note) return;

  note.k2Status = 'pending';

  DATA.commands = DATA.commands || [];
  DATA.commands.push({
    id: 'cmd-' + Date.now(),
    type: 'analyze-note',
    noteId: note.id || noteId,
    noteText: note.text,
    status: 'pending',
    created: new Date().toISOString()
  });

  await saveData();
  renderNotes();
}

async function deleteNote(noteId) {
  const idx = DATA.notes.findIndex(n => n.id === noteId || DATA.notes.indexOf(n) === parseInt(noteId));
  if (idx === -1) return;
  DATA.notes.splice(idx, 1);
  await saveData();
  renderNotes();
}

function editNote(noteId, el) {
  const note = DATA.notes.find(n => n.id === noteId || DATA.notes.indexOf(n) === parseInt(noteId));
  if (!note) return;

  const textarea = document.createElement('textarea');
  textarea.value = note.text;
  textarea.style.cssText = 'width:100%;min-height:60px;background:var(--surface2);border:1px solid var(--accent);border-radius:8px;color:var(--text);padding:8px;font-size:13px;font-family:inherit;resize:vertical;';

  const save = async () => {
    const newText = textarea.value.trim();
    if (newText && newText !== note.text) {
      note.text = newText;
      await saveData();
    }
    renderNotes();
  };

  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) { e.preventDefault(); save(); }
    if (e.key === 'Escape') renderNotes();
  });
  textarea.addEventListener('blur', save);

  el.replaceWith(textarea);
  textarea.focus();
}

// Jots functionality
let jotSearchQuery = '';

function filterJots() {
  jotSearchQuery = (document.getElementById('jot-search')?.value || '').trim().toLowerCase();
  renderJots();
}

function jotMatchesSearch(jot) {
  if (!jotSearchQuery) return true;
  const text = (jot.text || '').toLowerCase();
  const tags = (jot.tags || []).map(t => t.toLowerCase());
  
  // Support multiple search terms (space-separated)
  const terms = jotSearchQuery.split(/\s+/);
  return terms.every(term => {
    if (term.startsWith('#')) {
      // Tag search
      const tagTerm = term.slice(1);
      return tags.some(t => t.includes(tagTerm));
    }
    return text.includes(term) || tags.some(t => t.includes(term));
  });
}

function renderJots() {
  const today = new Date();
  const dateStr = today.toISOString().slice(0, 10);
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const dow = dayNames[today.getDay()];
  
  const header = document.getElementById('jots-today-date');
  if (header) {
    header.innerHTML = `${dateStr} <span class="dow">${dow}</span>`;
  }

  const allJots = DATA.jots.filter(jotMatchesSearch);
  const isSearching = !!jotSearchQuery;

  const todayJots = allJots.filter(j => j.date === dateStr);
  const todayContainer = document.getElementById('jots-today-entries');
  if (todayContainer) {
    if (isSearching && todayJots.length === 0) {
      todayContainer.innerHTML = '';
    } else {
      todayContainer.innerHTML = todayJots.map(jot => renderJotEntry(jot)).join('');
    }
  }

  // Render previous days (auto-expand when searching)
  const otherDates = [...new Set(allJots.map(j => j.date))].filter(d => d !== dateStr).sort().reverse();
  const previousContainer = document.getElementById('jots-previous-days');
  if (previousContainer) {
    if (isSearching && allJots.length === 0) {
      previousContainer.innerHTML = '<div style="text-align:center;color:var(--text-dim);padding:24px;font-size:13px;">No jots matching "' + jotSearchQuery + '"</div>';
    } else {
      previousContainer.innerHTML = otherDates.map(date => {
        const dateJots = allJots.filter(j => j.date === date);
        const dayName = dayNames[new Date(date + 'T00:00:00').getDay()];
        
        return `
          <div class="jot-day-section">
            <div class="jot-day-header" onclick="toggleJotDay(this)">
              <span class="jot-day-toggle">${isSearching ? '‚ñº' : '‚ñ∂'}</span>
              <span>${date} ${dayName} (${dateJots.length})</span>
            </div>
            <div class="jot-day-entries" style="${isSearching ? '' : 'display:none;'}">
              ${dateJots.map(jot => renderJotEntry(jot)).join('')}
            </div>
          </div>
        `;
      }).join('');
    }
  }
}

function renderJotEntry(jot) {
  const timeStr = jot.time.slice(-5); // last 5 chars (HH:MM)
  let renderedText = jot.text;

  // Markdown rendering
  renderedText = renderedText
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/(#\w+)/g, '<span class="jot-tag">$1</span>');

  // Handle checkboxes
  let hasCheckbox = false;
  if (renderedText.match(/\[\s*\]/)) {
    hasCheckbox = true;
    renderedText = renderedText.replace(/\[\s*\]/g, '');
  } else if (renderedText.match(/\[x\]/i)) {
    hasCheckbox = true;
    renderedText = renderedText.replace(/\[x\]/gi, '');
  }

  const isChecked = jot.done || false;

  return `
    <div class="jot-entry" data-jot-id="${jot.id}">
      ${hasCheckbox ? `<div class="jot-check ${isChecked ? 'done' : ''}" onclick="toggleJot(${jot.id})"></div>` : ''}
      <div class="jot-text ${hasCheckbox && isChecked ? 'done' : ''}" onclick="if(!window.getSelection().toString().trim() && ${!hasCheckbox})editJot(${jot.id})">${renderedText}</div>
      <div class="jot-time">${timeStr}</div>
      <button class="jot-delete" onclick="deleteJot(${jot.id})" title="Delete">‚úï</button>
    </div>
  `;
}

function toggleJotDay(element) {
  element.classList.toggle('open');
}

async function handleJotKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    await addJot();
  }
}

function autoExpandTextarea(textarea) {
  textarea.style.height = 'auto';
  textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

async function addJot() {
  const input = document.getElementById('jot-input');
  const text = input.value.trim();
  if (!text) return;

  const now = new Date();
  const dateStr = now.toISOString().slice(0, 10);
  const timeStr = now.toTimeString().slice(0, 5);

  const newJot = {
    id: Date.now(),
    text: text,
    date: dateStr,
    time: timeStr,
    done: false
  };

  DATA.jots.push(newJot);

  // If jot has checkbox syntax, also create a linked task
  if (text.match(/\[\s*\]|\[x\]/i)) {
    const taskText = text.replace(/\[\s*\]/g, '').replace(/\[x\]/gi, '').replace(/(#\w+)/g, '').trim();
    if (taskText) {
      const newTask = {
        id: Date.now() + 1,
        text: taskText,
        priority: 'medium',
        project: '',
        done: false,
        created: dateStr,
        source: 'jot',
        linkedJotId: newJot.id,
        messages: []
      };
      DATA.tasks.push(newTask);
      newJot.linkedTaskId = newTask.id;
    }
  }

  input.value = '';
  input.style.height = 'auto';

  await saveData();
  renderJots();
  renderTasks();
}

async function editJot(jotId) {
  const jot = DATA.jots.find(j => j.id == jotId); // == for loose comparison (string vs number)
  if (!jot) return;

  // Try multiple selectors for robustness
  let jotElement = document.querySelector(`[data-jot-id="${jotId}"] .jot-text`);
  if (!jotElement) jotElement = document.querySelector(`.jot-entry[data-jot-id="${jotId}"] .jot-text`);
  if (!jotElement) return;

  const currentText = jot.text;
  jotElement.innerHTML = `
    <div class="jot-edit-wrap">
      <textarea onblur="saveJotEdit(${jotId}, this.value)" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.blur();}">${currentText}</textarea>
    </div>
  `;

  const textarea = jotElement.querySelector('textarea');
  textarea.focus();
  textarea.setSelectionRange(textarea.value.length, textarea.value.length);
}

async function saveJotEdit(jotId, newText) {
  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  jot.text = newText.trim();
  await saveData();
  renderJots();
}

async function toggleJot(jotId) {
  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  jot.done = !jot.done;

  // Sync linked task
  if (jot.linkedTaskId) {
    const task = DATA.tasks.find(t => t.id === jot.linkedTaskId);
    if (task) task.done = jot.done;
  }

  await saveData();
  renderJots();
  renderTasks();
}

async function deleteJot(jotId) {
  if (!confirm('Delete this jot?')) return;
  
  DATA.jots = DATA.jots.filter(j => j.id !== jotId);
  await saveData();
  renderJots();
}

// File attachment handling
let pendingFiles = [];

function handleJotFileAttach(event) {
  const files = Array.from(event.target.files);
  if (files.length) processDroppedFiles(files);
  event.target.value = ''; // Reset so same file can be re-selected
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROJECT NEXT STEPS ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

async function queueStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const text = typeof step === 'string' ? step : step.text;

  // Add command to queue
  const cmd = {
    id: 'cmd-' + Date.now(),
    type: 'execute-step',
    projectId: projectId,
    stepIndex: stepIdx,
    stepText: text,
    status: 'pending',
    created: new Date().toISOString()
  };
  DATA.commands = DATA.commands || [];
  DATA.commands.push(cmd);

  // Update step status to queued
  if (typeof step === 'string') {
    p.nextSteps[stepIdx] = { text: step, status: 'queued' };
  } else {
    step.status = 'queued';
  }

  await saveData();
  openProjectModal(projectId);
}

async function acceptStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  if (typeof step === 'object') step.status = 'done';
  else p.nextSteps[stepIdx] = { text: step, status: 'done' };

  await saveData();
  openProjectModal(projectId);
}

async function rejectStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const reason = prompt('What needs to change?');
  if (reason === null) return;

  const step = p.nextSteps[stepIdx];
  if (typeof step === 'object') {
    step.status = '';
    step.reworkReason = reason;
  } else {
    p.nextSteps[stepIdx] = { text: step, status: '', reworkReason: reason };
  }

  // Queue rework command
  const cmd = {
    id: 'cmd-' + Date.now(),
    type: 'rework',
    projectId: projectId,
    stepIndex: stepIdx,
    stepText: typeof step === 'string' ? step : step.text,
    reason: reason,
    status: 'pending',
    created: new Date().toISOString()
  };
  DATA.commands = DATA.commands || [];
  DATA.commands.push(cmd);

  await saveData();
  openProjectModal(projectId);
}

async function deleteStep(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps) return;

  p.nextSteps.splice(stepIdx, 1);
  await saveData();
  openProjectModal(projectId);
}

async function cycleStepPriority(projectId, stepIdx) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const cycle = { high: 'medium', medium: 'low', low: 'high', '': 'high' };

  if (typeof step === 'string') {
    p.nextSteps[stepIdx] = { text: step, priority: 'high' };
  } else {
    step.priority = cycle[step.priority || ''] || 'high';
  }

  await saveData();
  openProjectModal(projectId);
}

async function editNextStep(projectId, stepIdx, el) {
  const p = DATA.projects.find(pr => pr.id === projectId);
  if (!p || !p.nextSteps || !p.nextSteps[stepIdx]) return;

  const step = p.nextSteps[stepIdx];
  const currentText = typeof step === 'string' ? step : step.text;

  const input = document.createElement('input');
  input.type = 'text';
  input.value = currentText;
  input.style.cssText = 'width:100%;background:var(--surface2);border:1px solid var(--accent);border-radius:4px;color:var(--text);padding:4px 8px;font-size:12px;';

  const save = async () => {
    const newText = input.value.trim();
    if (newText && newText !== currentText) {
      if (typeof step === 'string') {
        p.nextSteps[stepIdx] = newText;
      } else {
        step.text = newText;
      }
      await saveData();
    }
    openProjectModal(projectId);
  };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); save(); }
    if (e.key === 'Escape') openProjectModal(projectId);
  });
  input.addEventListener('blur', save);

  el.replaceWith(input);
  input.focus();
  input.select();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KEYBOARD SHORTCUTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    // Don't fire when typing in inputs/textareas
    const tag = document.activeElement?.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || document.activeElement?.isContentEditable) return;

    // Don't fire with modifier keys (except shift for ?)
    if (e.ctrlKey || e.metaKey || e.altKey) return;

    switch (e.key) {
      case 'n': // New jot
        e.preventDefault();
        navigateTo('jots');
        setTimeout(() => document.getElementById('jot-input')?.focus(), 100);
        break;
      case '/': // Search jots
        e.preventDefault();
        navigateTo('jots');
        setTimeout(() => document.getElementById('jot-search')?.focus(), 100);
        break;
      case 't': // New task
        e.preventDefault();
        navigateTo('tasks');
        setTimeout(() => document.getElementById('new-task-input')?.focus(), 100);
        break;
      case 'd': // Dashboard
        e.preventDefault();
        navigateTo('dashboard');
        break;
      case 'j': // Jots
        e.preventDefault();
        navigateTo('jots');
        break;
      case 'p': // Projects
        e.preventDefault();
        navigateTo('projects');
        break;
      case '?': // Show shortcuts help
        e.preventDefault();
        toggleShortcutsHelp();
        break;
      case 'Escape': // Close modals
        closeAllModals();
        break;
    }
  });
}

function toggleShortcutsHelp() {
  let help = document.getElementById('shortcuts-help');
  if (help) {
    help.remove();
    return;
  }
  help = document.createElement('div');
  help.id = 'shortcuts-help';
  help.onclick = () => help.remove();
  help.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:flex;align-items:center;justify-content:center;';
  help.innerHTML = `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:24px;max-width:360px;width:90%;" onclick="event.stopPropagation()">
      <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;">‚å®Ô∏è Keyboard Shortcuts</h3>
      <div style="display:grid;grid-template-columns:40px 1fr;gap:8px 12px;font-size:13px;">
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">n</kbd><span>New jot</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">/</kbd><span>Search jots</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">t</kbd><span>New task</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">d</kbd><span>Dashboard</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">j</kbd><span>Jots</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">p</kbd><span>Projects</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">?</kbd><span>This help</span>
        <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:2px 6px;text-align:center;font-family:monospace;font-size:12px;">esc</kbd><span>Close modals</span>
      </div>
      <div style="text-align:center;margin-top:16px;font-size:11px;color:var(--text-dim);">Press any key or click outside to close</div>
    </div>
  `;
  document.body.appendChild(help);
}

function closeAllModals() {
  // Close any open modals
  document.querySelectorAll('[id$="-modal"]').forEach(m => {
    if (m.style.display !== 'none') m.style.display = 'none';
  });
  document.getElementById('shortcuts-help')?.remove();
  document.body.style.overflow = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SELECTION TOOLBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let selectionContext = { jotId: null, text: '', range: null };

function initSelectionToolbar() {
  const toolbar = document.getElementById('selection-toolbar');
  if (!toolbar) return;

  document.addEventListener('mouseup', (e) => {
    // Small delay to let selection finalize
    setTimeout(() => {
      const selection = window.getSelection();
      const text = selection.toString().trim();

      if (!text || text.length < 2) {
        toolbar.classList.remove('visible');
        return;
      }

      // Check if selection is inside a jot
      const jotEntry = selection.anchorNode?.parentElement?.closest?.('.jot-entry');
      if (!jotEntry) {
        toolbar.classList.remove('visible');
        return;
      }

      const jotId = parseInt(jotEntry.dataset.jotId);
      selectionContext = { jotId, text, range: selection.getRangeAt(0).cloneRange() };

      // Position toolbar above selection
      const rect = selection.getRangeAt(0).getBoundingClientRect();
      toolbar.style.left = Math.max(8, rect.left + rect.width / 2 - toolbar.offsetWidth / 2) + 'px';
      toolbar.style.top = (rect.top - 44 + window.scrollY) + 'px';
      toolbar.classList.add('visible');
    }, 10);
  });

  document.addEventListener('mousedown', (e) => {
    if (!e.target.closest('.selection-toolbar')) {
      toolbar.classList.remove('visible');
    }
  });
}

async function selectionToTask() {
  const { jotId, text } = selectionContext;
  if (!text) return;

  const taskText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/`/g, '').trim();
  if (!taskText) return;

  const now = new Date();
  const newTask = {
    id: Date.now(),
    text: taskText,
    priority: 'medium',
    project: '',
    done: false,
    created: now.toISOString().slice(0, 10),
    source: 'jot',
    linkedJotId: jotId || null,
    messages: []
  };

  DATA.tasks.push(newTask);
  await saveData();
  renderTasks();

  // Hide toolbar and show confirmation
  document.getElementById('selection-toolbar').classList.remove('visible');
  window.getSelection().removeAllRanges();
  
  // Brief toast
  showToast('‚òëÔ∏è Task created: ' + taskText.slice(0, 40) + (taskText.length > 40 ? '...' : ''));
}

async function selectionFormat(wrapper) {
  const { jotId, text } = selectionContext;
  if (!jotId || !text) return;

  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  const wrapped = wrapper + text + wrapper;
  jot.text = jot.text.replace(text, wrapped);

  await saveData();
  renderJots();
  document.getElementById('selection-toolbar').classList.remove('visible');
}

async function selectionHighlight() {
  const { jotId } = selectionContext;
  if (!jotId) return;

  const jot = DATA.jots.find(j => j.id == jotId);
  if (!jot) return;

  jot.pinned = !jot.pinned;
  await saveData();
  renderJots();
  document.getElementById('selection-toolbar').classList.remove('visible');
  showToast(jot.pinned ? 'üîñ Jot pinned' : 'üìå Jot unpinned');
}

function showToast(msg) {
  const toast = document.createElement('div');
  toast.textContent = msg;
  toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:400;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:opacity 0.3s;';
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2000);
}

// Drag and drop for jot attachments
function initJotDragDrop() {
  const dropZone = document.getElementById('jot-drop-zone');
  const overlay = document.getElementById('jot-drop-overlay');
  if (!dropZone || !overlay) return;

  let dragCounter = 0;

  dropZone.addEventListener('dragenter', (e) => {
    e.preventDefault();
    dragCounter++;
    overlay.style.display = 'flex';
  });

  dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dragCounter--;
    if (dragCounter === 0) overlay.style.display = 'none';
  });

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dragCounter = 0;
    overlay.style.display = 'none';
    const files = Array.from(e.dataTransfer.files);
    if (files.length) processDroppedFiles(files);
  });
}

function processDroppedFiles(files) {
  const preview = document.getElementById('jot-images-preview');
  if (!preview) return;

  files.forEach(file => {
    // Store in pendingFiles for saving
    const reader = new FileReader();
    reader.onload = (e) => {
      pendingFiles.push({ name: file.name, type: file.type, data: e.target.result });

      const chip = document.createElement('div');
      chip.className = 'jot-file-chip';
      const idx = pendingFiles.length - 1;

      // Show image preview for image files
      if (file.type.startsWith('image/')) {
        chip.innerHTML = `
          <img src="${e.target.result}" style="max-height:40px;border-radius:4px;margin-right:6px;">
          ${file.name}
          <button onclick="removePendingFile(${idx}, this)" style="background:none;border:none;color:var(--red);margin-left:4px;cursor:pointer;">‚úï</button>
        `;
      } else {
        chip.innerHTML = `
          üìé ${file.name}
          <button onclick="removePendingFile(${idx}, this)" style="background:none;border:none;color:var(--red);margin-left:4px;cursor:pointer;">‚úï</button>
        `;
      }
      preview.appendChild(chip);
    };
    reader.readAsDataURL(file);
  });
}

function removePendingFile(idx, btn) {
  pendingFiles[idx] = null;
  btn.parentElement.remove();
}

// Initialize on load
document.addEventListener('DOMContentLoaded', () => {
  if (localStorage.getItem('k2auth') === 'true' && localStorage.getItem('gh_token')) {
    GH_TOKEN = localStorage.getItem('gh_token');
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app-main').style.display = 'flex';
    loadData();
    initJotDragDrop();
    initSelectionToolbar();
    initKeyboardShortcuts();
  }
});
</script>
<!-- Selection Toolbar -->
<div class="selection-toolbar" id="selection-toolbar">
  <button class="sel-btn sel-task" onclick="selectionToTask()">‚òëÔ∏è Task</button>
  <div class="sel-divider"></div>
  <button class="sel-btn" onclick="selectionFormat('**')"><b>B</b></button>
  <button class="sel-btn" onclick="selectionFormat('*')"><i>I</i></button>
  <button class="sel-btn" onclick="selectionFormat('`')">&lt;/&gt;</button>
  <div class="sel-divider"></div>
  <button class="sel-btn" onclick="selectionHighlight()">üîñ Pin</button>
</div>
</body>
</html>